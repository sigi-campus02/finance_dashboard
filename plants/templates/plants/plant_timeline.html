{% extends 'finance/base.html' %}
{% load static %}

{% block title %}{{ plant.name }} - Timeline{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-flower1"></i> {{ plant.name }}</h1>
        <a href="{% url 'plants:plant_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
    </div>

    <!-- Kamera Button (Sticky oben rechts auf Mobile) -->
    <div class="floating-camera-btn">
        <button id="addPhotoBtn" class="btn btn-primary btn-lg rounded-circle shadow">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>

    <!-- ========== NEU: Versteckter File Input für Galerie ========== -->
    <input type="file"
           id="galleryInput"
           accept="image/*"
           style="display: none;">

    <!-- Timeline Container -->
    <div class="timeline-container">
        {% for image in images %}
        <div class="timeline-item">
            <div class="timeline-date">
                {{ image.captured_at|date:"d.m.Y H:i" }}
            </div>
            <div class="image-card">
                <img src="{{ image.image.url }}"
                     alt="{{ plant.name }}"
                     loading="lazy"
                     onclick="openImageModal('{{ image.image.url }}')">
                {% if image.notes %}
                <div class="image-notes">{{ image.notes }}</div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">
            Noch keine Fotos vorhanden. Klicke auf das Plus-Symbol, um das erste Foto hinzuzufügen!
        </div>
        {% endfor %}
    </div>
</div>

<!-- ========== NEU: Action Sheet Modal ========== -->
<div id="photoActionSheet" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-bottom">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Foto hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pb-4">
                <div class="d-grid gap-2">
                    <button class="btn btn-lg btn-primary" onclick="openCameraFromSheet()">
                        <i class="bi bi-camera-fill me-2"></i> Kamera
                    </button>
                    <button class="btn btn-lg btn-outline-primary" onclick="openGalleryFromSheet()">
                        <i class="bi bi-images me-2"></i> Galerie / Google Fotos
                    </button>
                    <button class="btn btn-lg btn-outline-secondary" data-bs-dismiss="modal">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal für Kamera -->
<div id="cameraModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Foto aufnehmen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <!-- Live-Kamera-Feed -->
                <video id="cameraFeed" autoplay playsinline class="w-100 mb-3" style="max-height: 400px;"></video>

                <!-- Canvas für Snapshot (versteckt) -->
                <canvas id="photoCanvas" style="display: none;"></canvas>

                <!-- Preview des aufgenommenen Fotos -->
                <img id="photoPreview" class="w-100 mb-3" style="display: none; max-height: 400px;">

                <!-- Notizen -->
                <textarea id="photoNotes" class="form-control mb-3"
                          placeholder="Notizen (optional)"
                          rows="2"></textarea>
            </div>
            <div class="modal-footer justify-content-center">
                <button id="captureBtn" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-camera-fill"></i> Foto aufnehmen
                </button>
                <div id="afterCaptureButtons" style="display: none; width: 100%;">
                    <button id="retakeBtn" class="btn btn-warning btn-lg mb-2 w-100">
                        <i class="bi bi-arrow-repeat"></i> Wiederholen
                    </button>
                    <button id="saveBtn" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-check-lg"></i> Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen Image Modal -->
<div id="imageModal" class="modal fade" tabindex="-1" onclick="this.querySelector('.btn-close').click()">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-header border-0">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <img id="modalImage" class="w-100" src="" style="cursor: zoom-out;">
            </div>
        </div>
    </div>
</div>

<style>
.floating-camera-btn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
}

.floating-camera-btn button {
    width: 60px;
    height: 60px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.timeline-container {
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 100px;
}

.timeline-item {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #dee2e6;
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-date {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.image-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.image-card img {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
    transition: transform 0.2s;
}

.image-card img:hover {
    transform: scale(1.02);
}

.image-notes {
    padding: 1rem;
    background: #f8f9fa;
    font-size: 0.9rem;
}

#cameraFeed, #photoPreview {
    border-radius: 8px;
    object-fit: cover;
}

#imageModal .modal-dialog {
    max-width: 90vw;
}

#imageModal .modal-body img {
    border-radius: 8px;
}

/* ========== NEU: Action Sheet Styles ========== */
.modal-dialog-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    margin: 0;
    max-width: 100%;
}

.modal-dialog-bottom .modal-content {
    border-radius: 20px 20px 0 0;
}

@media (min-width: 768px) {
    .modal-dialog-bottom {
        position: relative;
        max-width: 500px;
        margin: 1.75rem auto;
    }

    .modal-dialog-bottom .modal-content {
        border-radius: 12px;
    }
}
</style>

<script>
let stream = null;
let capturedImageData = null;

// Modal-Elemente
const cameraModalEl = document.getElementById('cameraModal');
const actionSheetEl = document.getElementById('photoActionSheet');
const cameraFeed = document.getElementById('cameraFeed');
const canvas = document.getElementById('photoCanvas');
const photoPreview = document.getElementById('photoPreview');
const captureBtn = document.getElementById('captureBtn');
const saveBtn = document.getElementById('saveBtn');
const retakeBtn = document.getElementById('retakeBtn');
const photoNotes = document.getElementById('photoNotes');
const afterCaptureButtons = document.getElementById('afterCaptureButtons');
const galleryInput = document.getElementById('galleryInput');

let cameraModal = null;
let actionSheet = null;

// Warte bis DOM geladen ist
document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined') {
        cameraModal = new bootstrap.Modal(cameraModalEl);
        actionSheet = new bootstrap.Modal(actionSheetEl);
    }
});

// ========== NEU: Plus-Button öffnet Action Sheet ==========
document.getElementById('addPhotoBtn').addEventListener('click', () => {
    console.log('Plus-Button geklickt');
    if (actionSheet) {
        actionSheet.show();
    } else {
        // Fallback ohne Bootstrap: Direkt Galerie öffnen
        galleryInput.click();
    }
});

// ========== NEU: Kamera aus Action Sheet öffnen ==========
function openCameraFromSheet() {
    console.log('Kamera aus Action Sheet');
    if (actionSheet) actionSheet.hide();
    openCameraModal();
}

// ========== NEU: Galerie aus Action Sheet öffnen ==========
function openGalleryFromSheet() {
    console.log('Galerie aus Action Sheet');
    if (actionSheet) actionSheet.hide();
    galleryInput.click();
}

galleryInput.addEventListener('change', function(e) {
    console.log('Galerie-Datei ausgewählt');
    if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            // ← Bild durch Canvas laufen lassen zur Komprimierung
            const img = new Image();
            img.onload = function() {
                // Canvas erstellen
                const tempCanvas = document.createElement('canvas');
                const maxWidth = 1920;
                const maxHeight = 1920;

                let width = img.width;
                let height = img.height;

                // Größe anpassen wenn zu groß
                if (width > maxWidth || height > maxHeight) {
                    if (width > height) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    } else {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }

                tempCanvas.width = width;
                tempCanvas.height = height;

                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Komprimiert als JPEG mit 70% Qualität
                capturedImageData = tempCanvas.toDataURL('image/jpeg', 0.7);

                // Preview im Modal zeigen
                cameraFeed.style.display = 'none';
                photoPreview.src = capturedImageData;
                photoPreview.style.display = 'block';
                captureBtn.style.display = 'none';
                afterCaptureButtons.style.display = 'block';
                photoNotes.value = '';

                if (cameraModal) {
                    cameraModal.show();
                } else {
                    cameraModalEl.classList.add('show');
                    cameraModalEl.style.display = 'block';
                }

                console.log('Galerie-Foto geladen und komprimiert');
            };
            img.src = e.target.result;
        };

        reader.readAsDataURL(file);
    }

    // Input zurücksetzen
    this.value = '';
});

// Kamera Modal öffnen
async function openCameraModal() {
    console.log('Kamera wird geöffnet');
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        cameraFeed.srcObject = stream;

        // UI zurücksetzen
        cameraFeed.style.display = 'block';
        photoPreview.style.display = 'none';
        captureBtn.style.display = 'block';
        afterCaptureButtons.style.display = 'none';
        photoNotes.value = '';

        if (cameraModal) {
            cameraModal.show();
        } else {
            cameraModalEl.classList.add('show');
            cameraModalEl.style.display = 'block';
        }

        console.log('Kamera gestartet');
    } catch (err) {
        console.error('Kamera-Fehler:', err);
        alert('Kamera-Zugriff fehlgeschlagen: ' + err.message + '\n\nBitte stelle sicher, dass du der Website Kamera-Zugriff erlaubt hast.');
    }
}

// Foto aufnehmen (mit Komprimierung)
captureBtn.addEventListener('click', () => {
    console.log('Capture-Button geklickt');

    const context = canvas.getContext('2d');
    canvas.width = cameraFeed.videoWidth;
    canvas.height = cameraFeed.videoHeight;
    context.drawImage(cameraFeed, 0, 0);

    // ← KOMPRIMIERUNG: Qualität auf 0.7 reduzieren (statt 0.9)
    capturedImageData = canvas.toDataURL('image/jpeg', 0.7);  // 70% Qualität

    // UI umschalten
    cameraFeed.style.display = 'none';
    photoPreview.src = capturedImageData;
    photoPreview.style.display = 'block';
    captureBtn.style.display = 'none';
    afterCaptureButtons.style.display = 'block';

    // Kamera stoppen
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }

    console.log('Foto aufgenommen (komprimiert)');
});

// Foto erneut aufnehmen
retakeBtn.addEventListener('click', async () => {
    console.log('Retake-Button geklickt');

    // Prüfen ob von Galerie oder Kamera
    if (stream === null && cameraFeed.srcObject === null) {
        // War von Galerie - erneut Galerie öffnen
        if (cameraModal) cameraModal.hide();
        galleryInput.click();
        return;
    }

    // War von Kamera - Kamera neu starten
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        cameraFeed.srcObject = stream;

        cameraFeed.style.display = 'block';
        photoPreview.style.display = 'none';
        captureBtn.style.display = 'block';
        afterCaptureButtons.style.display = 'none';
    } catch (err) {
        console.error('Kamera-Neustart fehlgeschlagen:', err);
        alert('Kamera konnte nicht erneut gestartet werden: ' + err.message);
    }
});

// Foto speichern
saveBtn.addEventListener('click', async () => {
    console.log('Save-Button geklickt');

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const formData = new FormData();
    formData.append('image_data', capturedImageData);
    formData.append('notes', photoNotes.value);
    formData.append('csrfmiddlewaretoken', csrfToken);

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Wird gespeichert...';

    try {
        const response = await fetch('{% url "plants:add_image" plant.id %}', {
            method: 'POST',
            body: formData
        });

        console.log('Response Status:', response.status);

        if (response.ok) {
            window.location.reload();
        } else {
            const errorText = await response.text();
            console.error('Server-Fehler:', errorText);
            alert('Fehler beim Speichern: Server antwortete mit Status ' + response.status);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
        }
    } catch (err) {
        console.error('Netzwerkfehler:', err);
        alert('Netzwerkfehler beim Speichern: ' + err.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Speichern';
    }
});

// Modal schließen Buttons
document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    });
});

// Fullscreen Image Modal
function openImageModal(src) {
    const imgModal = document.getElementById('imageModal');
    document.getElementById('modalImage').src = src;

    if (typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(imgModal).show();
    } else {
        imgModal.classList.add('show');
        imgModal.style.display = 'block';
    }
}

// Prüfe Kamera-Verfügbarkeit
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    console.warn('Kamera nicht verfügbar - nur Galerie-Upload möglich');
}

console.log('Plant Timeline Script geladen');
</script>

<!-- CSRF Token -->
{% csrf_token %}

{% endblock %}