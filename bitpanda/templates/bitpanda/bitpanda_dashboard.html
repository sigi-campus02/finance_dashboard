{% extends 'finance/base.html' %}

{% block title %}Bitpanda Portfolio - Finance{% endblock %}

{% block extra_css %}
<style>
    .asset-card {
        border-left: 4px solid #0d6efd;
        transition: transform 0.2s;
    }
    .asset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .asset-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.3rem;
    }
    .crypto-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stock-icon { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

    .value-positive { color: #28a745; font-weight: bold; }
    .value-negative { color: #dc3545; font-weight: bold; }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
    }

    .profit-badge {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-wallet2"></i> Bitpanda Portfolio
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if has_data %}
        <a href="{% url 'bitpanda:update_prices' %}" class="btn btn-success me-2">
            <i class="bi bi-currency-exchange"></i> Preise aktualisieren
        </a>
        <button onclick="location.reload()" class="btn btn-primary">
            <i class="bi bi-arrow-repeat"></i> Neu laden
        </button>
        {% endif %}
    </div>
</div>

{% if not has_data %}
<!-- Keine Daten -->
<div class="alert alert-info" role="alert">
    <h4 class="alert-heading"><i class="bi bi-info-circle"></i> Keine Daten vorhanden</h4>
    <p>Importiere deine Bitpanda Transaktionen um dein Portfolio zu verfolgen.</p>
    <hr>
    <div class="mb-3">
        <h5>So importierst du deine Daten:</h5>
        <ol>
            <li>Gehe zu <a href="https://web.bitpanda.com" target="_blank">Bitpanda Web App</a></li>
            <li>Klicke auf <strong>History</strong> → <strong>Export</strong> → <strong>CSV</strong></li>
            <li>Lade die CSV-Datei herunter</li>
            <li>Führe aus: <code>python manage.py import_bitpanda_csv transactions.csv --user {{ user.username }}</code></li>
        </ol>
    </div>
    <p class="mb-0">
        <a href="/admin/bitpanda/" class="btn btn-outline-primary">
            <i class="bi bi-database"></i> Admin öffnen
        </a>
    </p>
</div>

{% else %}

<!-- Portfolio Übersicht -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2">Gesamtwert</h6>
                <h2 class="card-title mb-0">€{{ portfolio.total_value|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Investiert</h6>
                <h3 class="card-title">€{{ portfolio.total_invested|floatformat:2 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Gewinn/Verlust</h6>
                <h3 class="card-title {% if portfolio.total_profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                    €{{ portfolio.total_profit_loss|floatformat:2 }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Performance</h6>
                <h3 class="card-title {% if portfolio.total_profit_loss_pct >= 0 %}value-positive{% else %}value-negative{% endif %}">
                    {{ portfolio.total_profit_loss_pct|floatformat:1 }}%
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Portfolio-Entwicklung</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Asset Allocation</h5>
            </div>
            <div class="card-body">
                <canvas id="allocationChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Kryptowährungen -->
{% if portfolio.crypto %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="mb-0">
            <i class="bi bi-currency-bitcoin"></i> Kryptowährungen
            <span class="badge bg-light text-dark ms-2">€{{ portfolio.crypto_value|floatformat:2 }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th class="text-end">Bestand</th>
                        <th class="text-end">Preis</th>
                        <th class="text-end">Wert</th>
                        <th class="text-end">Investiert</th>
                        <th class="text-end">Gewinn/Verlust</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio.crypto %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="asset-icon crypto-icon me-2" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                    {{ asset.asset|slice:":3" }}
                                </div>
                                <strong>{{ asset.asset }}</strong>
                            </div>
                        </td>
                        <td class="text-end">{{ asset.balance|floatformat:4 }}</td>
                        <td class="text-end">€{{ asset.current_price|floatformat:2 }}</td>
                        <td class="text-end"><strong>€{{ asset.current_value|floatformat:2 }}</strong></td>
                        <td class="text-end text-muted">€{{ asset.invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <span class="{% if asset.profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ asset.profit_loss|floatformat:2 }}
                            </span>
                            <br>
                            <span class="profit-badge badge {% if asset.profit_loss_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ asset.profit_loss_pct|floatformat:1 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="3"><strong>Gesamt Krypto</strong></td>
                        <td class="text-end"><strong>€{{ portfolio.crypto_value|floatformat:2 }}</strong></td>
                        <td class="text-end">€{{ portfolio.crypto_invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <strong class="{% if portfolio.crypto_profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ portfolio.crypto_profit_loss|floatformat:2 }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Aktien -->
{% if portfolio.stocks %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
        <h5 class="mb-0">
            <i class="bi bi-graph-up-arrow"></i> Aktien
            <span class="badge bg-light text-dark ms-2">€{{ portfolio.stock_value|floatformat:2 }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th class="text-end">Bestand</th>
                        <th class="text-end">Preis</th>
                        <th class="text-end">Wert</th>
                        <th class="text-end">Investiert</th>
                        <th class="text-end">Gewinn/Verlust</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio.stocks %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="asset-icon stock-icon me-2" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                    {{ asset.asset|slice:":3" }}
                                </div>
                                <strong>{{ asset.asset }}</strong>
                            </div>
                        </td>
                        <td class="text-end">{{ asset.balance|floatformat:4 }}</td>
                        <td class="text-end">
                            {% if asset.current_price > 0 %}
                                €{{ asset.current_price|floatformat:2 }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end"><strong>€{{ asset.current_value|floatformat:2 }}</strong></td>
                        <td class="text-end text-muted">€{{ asset.invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <span class="{% if asset.profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ asset.profit_loss|floatformat:2 }}
                            </span>
                            <br>
                            <span class="profit-badge badge {% if asset.profit_loss_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ asset.profit_loss_pct|floatformat:1 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="3"><strong>Gesamt Aktien</strong></td>
                        <td class="text-end"><strong>€{{ portfolio.stock_value|floatformat:2 }}</strong></td>
                        <td class="text-end">€{{ portfolio.stock_invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <strong class="{% if portfolio.stock_profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ portfolio.stock_profit_loss|floatformat:2 }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ETFs -->
{% if portfolio.etfs %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
        <h5 class="mb-0">
            <i class="bi bi-bar-chart-line"></i> ETFs
            <span class="badge bg-light text-dark ms-2">€{{ portfolio.etf_value|floatformat:2 }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th class="text-end">Bestand</th>
                        <th class="text-end">Preis</th>
                        <th class="text-end">Wert</th>
                        <th class="text-end">Investiert</th>
                        <th class="text-end">Gewinn/Verlust</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio.etfs %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="asset-icon me-2" style="width: 35px; height: 35px; font-size: 0.9rem; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    {{ asset.asset|slice:":3" }}
                                </div>
                                <strong>{{ asset.asset }}</strong>
                            </div>
                        </td>
                        <td class="text-end">{{ asset.balance|floatformat:4 }}</td>
                        <td class="text-end">
                            {% if asset.current_price > 0 %}
                                €{{ asset.current_price|floatformat:2 }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end"><strong>€{{ asset.current_value|floatformat:2 }}</strong></td>
                        <td class="text-end text-muted">€{{ asset.invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <span class="{% if asset.profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ asset.profit_loss|floatformat:2 }}
                            </span>
                            <br>
                            <span class="profit-badge badge {% if asset.profit_loss_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ asset.profit_loss_pct|floatformat:1 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="3"><strong>Gesamt ETFs</strong></td>
                        <td class="text-end"><strong>€{{ portfolio.etf_value|floatformat:2 }}</strong></td>
                        <td class="text-end">€{{ portfolio.etf_invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <strong class="{% if portfolio.etf_profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ portfolio.etf_profit_loss|floatformat:2 }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Commodities -->
{% if portfolio.commodities %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <h5 class="mb-0">
            <i class="bi bi-basket"></i> Rohstoffe
            <span class="badge bg-light text-dark ms-2">€{{ portfolio.commodity_value|floatformat:2 }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th class="text-end">Bestand</th>
                        <th class="text-end">Wert</th>
                        <th class="text-end">Investiert</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio.commodities %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="asset-icon me-2" style="width: 35px; height: 35px; font-size: 0.9rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    {{ asset.asset|slice:":3" }}
                                </div>
                                <strong>{{ asset.asset }}</strong>
                            </div>
                        </td>
                        <td class="text-end">{{ asset.balance|floatformat:4 }}</td>
                        <td class="text-end"><strong>€{{ asset.current_value|floatformat:2 }}</strong></td>
                        <td class="text-end text-muted">€{{ asset.invested|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="2"><strong>Gesamt Rohstoffe</strong></td>
                        <td class="text-end"><strong>€{{ portfolio.commodity_value|floatformat:2 }}</strong></td>
                        <td class="text-end">€{{ portfolio.commodity_invested|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if not portfolio.crypto and not portfolio.stocks and not portfolio.etfs and not portfolio.commodities %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
        <h5 class="mb-0">
            <i class="bi bi-graph-up-arrow"></i> Aktien
            <span class="badge bg-light text-dark ms-2">€{{ portfolio.stock_value|floatformat:2 }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th class="text-end">Bestand</th>
                        <th class="text-end">Preis</th>
                        <th class="text-end">Wert</th>
                        <th class="text-end">Investiert</th>
                        <th class="text-end">Gewinn/Verlust</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in portfolio.stocks %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="asset-icon stock-icon me-2" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                    {{ asset.asset|slice:":3" }}
                                </div>
                                <strong>{{ asset.asset }}</strong>
                            </div>
                        </td>
                        <td class="text-end">{{ asset.balance|floatformat:4 }}</td>
                        <td class="text-end">
                            {% if asset.current_price > 0 %}
                                €{{ asset.current_price|floatformat:2 }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end"><strong>€{{ asset.current_value|floatformat:2 }}</strong></td>
                        <td class="text-end text-muted">€{{ asset.invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <span class="{% if asset.profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ asset.profit_loss|floatformat:2 }}
                            </span>
                            <br>
                            <span class="profit-badge badge {% if asset.profit_loss_pct >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {{ asset.profit_loss_pct|floatformat:1 }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="3"><strong>Gesamt Aktien</strong></td>
                        <td class="text-end"><strong>€{{ portfolio.stock_value|floatformat:2 }}</strong></td>
                        <td class="text-end">€{{ portfolio.stock_invested|floatformat:2 }}</td>
                        <td class="text-end">
                            <strong class="{% if portfolio.stock_profit_loss >= 0 %}value-positive{% else %}value-negative{% endif %}">
                                €{{ portfolio.stock_profit_loss|floatformat:2 }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if not portfolio.crypto and not portfolio.stocks %}
<div class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle"></i> Keine Assets mit Bestand > 0 gefunden. Importiere mehr Transaktionen.
</div>
{% endif %}

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
{% if has_data and portfolio %}
// Performance Chart
fetch('{% url "bitpanda:api_bitpanda_portfolio_chart" %}')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('performanceChart');
        if (!ctx) return;

        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€' + context.parsed.y.toFixed(2);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(0);
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    })
    .catch(error => console.error('Chart Error:', error));

// Asset Allocation Pie Chart
fetch('{% url "bitpanda:api_bitpanda_asset_allocation" %}')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('allocationChart');
        if (!ctx) return;

        new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€' + context.parsed.toFixed(2);

                                // Prozent berechnen
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((context.parsed / total) * 100).toFixed(1);
                                label += ' (' + percent + '%)';

                                return label;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => console.error('Pie Chart Error:', error));
{% endif %}
</script>
{% endblock %}