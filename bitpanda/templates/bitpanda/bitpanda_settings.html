<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% extends 'finance/base.html' %}

{% block title %}Bitpanda Einstellungen - Finance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-gear"></i> Bitpanda Einstellungen
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'bitpanda:bitpanda_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
        </a>
    </div>
</div>

<!-- API Key Status -->
{% if api_key_obj %}
<div class="alert {% if api_key_obj.is_active %}alert-success{% else %}alert-warning{% endif %}" role="alert">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h5 class="alert-heading">
                <i class="bi bi-{% if api_key_obj.is_active %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
                API Key {% if api_key_obj.is_active %}aktiv{% else %}inaktiv{% endif %}
            </h5>
            <p class="mb-0">
                Erstellt am: {{ api_key_obj.created_at|date:"d.m.Y H:i" }} Uhr<br>
                Zuletzt aktualisiert: {{ api_key_obj.updated_at|date:"d.m.Y H:i" }} Uhr
                {% if api_key_obj.last_sync %}
                <br>Letzte Synchronisation: {{ api_key_obj.last_sync|date:"d.m.Y H:i" }} Uhr
                {% endif %}
            </p>
        </div>
        <div>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_active">
                <button type="submit" class="btn btn-sm btn-{% if api_key_obj.is_active %}warning{% else %}success{% endif %}">
                    <i class="bi bi-{% if api_key_obj.is_active %}pause{% else %}play{% endif %}-circle"></i>
                    {% if api_key_obj.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- API Key Formular -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-key"></i> 
            {% if api_key_obj %}API Key aktualisieren{% else %}API Key hinzufügen{% endif %}
        </h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_key">
            
            <div class="mb-3">
                <label for="api_key" class="form-label">Bitpanda API Key</label>
                <input 
                    type="password" 
                    class="form-control" 
                    id="api_key" 
                    name="api_key" 
                    placeholder="Füge deinen API Key hier ein"
                    required
                >
                <small class="form-text text-muted">
                    Dein API Key wird verschlüsselt gespeichert und niemals im Klartext angezeigt.
                </small>
            </div>
            
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> 
                    {% if api_key_obj %}Aktualisieren{% else %}Speichern{% endif %}
                </button>
                
                {% if api_key_obj %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> API Key löschen
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Anleitung -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> So erstellst du einen API Key</h5>
    </div>
    <div class="card-body">
        <ol>
            <li>
                Melde dich bei <a href="https://www.bitpanda.com" target="_blank" rel="noopener">Bitpanda</a> an
            </li>
            <li>
                Gehe zu: <strong>Einstellungen → API → Neue API erstellen</strong>
            </li>
            <li>
                Wähle die Berechtigungen:
                <ul>
                    <li><strong>Wallets anzeigen</strong> ✓</li>
                    <li><strong>Transaktionen anzeigen</strong> ✓</li>
                    <li><strong>Trading</strong> ✗ (nicht erforderlich)</li>
                </ul>
            </li>
            <li>
                Kopiere den generierten API Key
            </li>
            <li>
                Füge ihn oben in das Formular ein und speichere
            </li>
        </ol>
        
        <div class="alert alert-warning mt-3" role="alert">
            <i class="bi bi-shield-exclamation"></i>
            <strong>Wichtig:</strong> Gib deinen API Key niemals an Dritte weiter. 
            Er ermöglicht Zugriff auf deine Bitpanda-Daten. Verwende nur Keys mit Lese-Rechten (Read-Only).
        </div>
    </div>
</div>

<!-- Sicherheitshinweise -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-shield-check"></i> Sicherheitshinweise</h5>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li>Dein API Key wird verschlüsselt in der Datenbank gespeichert</li>
            <li>Nur du hast Zugriff auf deine Bitpanda-Daten</li>
            <li>Die App hat keine Trading-Berechtigung - nur Lese-Zugriff</li>
            <li>Du kannst den API Key jederzeit deaktivieren oder löschen</li>
            <li>Bei Bitpanda kannst du den API Key jederzeit widerrufen</li>
        </ul>
    </div>
</div>

<!-- Delete Modal -->
{% if api_key_obj %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">API Key löschen?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bist du sicher, dass du deinen Bitpanda API Key löschen möchtest?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Diese Aktion kann nicht rückgängig gemacht werden. 
                    Du musst den API Key erneut eingeben, um das Dashboard wieder zu nutzen.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_key">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Jetzt löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}</title>
</head>
<body>

</body>
</html>