{% extends 'finance/base.html' %}
{% load static %}

{% block title %}{{ produktgruppe }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'finance:billa_dashboard' %}">Billa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'finance:billa_preisentwicklung_uebersicht' %}">Preisentwicklung</a></li>
            {% if ueberkategorie %}
            <li class="breadcrumb-item"><a href="{% url 'finance:billa_preisentwicklung_ueberkategorie' ueberkategorie %}">{{ ueberkategorie }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">{{ produktgruppe }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-tag"></i> {{ produktgruppe }}</h1>
        {% if ueberkategorie %}
        <div>
            <span class="badge bg-secondary me-2"><i class="bi bi-tag-fill"></i> {{ ueberkategorie }}</span>
            <a href="{% url 'finance:billa_preisentwicklung_ueberkategorie' ueberkategorie %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Zurück
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-2">{{ stats.gesamt_produkte }}</h3>
                    <p class="text-muted mb-0">Produkte</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-cart text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-2">{{ stats.gesamt_kaeufe }}</h3>
                    <p class="text-muted mb-0">Käufe gesamt</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="bi bi-currency-euro text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-2">€{{ stats.durchschnittspreis|floatformat:2 }}</h3>
                    <p class="text-muted mb-0">Ø Preis</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart: Durchschnittliche Preisentwicklung -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h4 class="mb-0"><i class="bi bi-graph-up"></i> Durchschnittliche Preisentwicklung der Produktgruppe</h4>
        </div>
        <div class="card-body">
            <div style="height: 300px; position: relative;">
                <canvas id="chart-gruppe"></canvas>
            </div>
        </div>
    </div>

    <!-- Einzelprodukte -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0"><i class="bi bi-box-seam"></i> Einzelprodukte nach Preisänderung</h4>
        </div>
        <div class="card-body">
            <div class="row" id="produkte-container"></div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const preis_historie = {{ preis_historie_gruppe|safe }};
const produkte = {{ produkte|safe }};

// Chart: Durchschnittliche Preisentwicklung
if (preis_historie && preis_historie.length > 0) {
    const ctx = document.getElementById('chart-gruppe');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: preis_historie.map(h => {
                const d = new Date(h.datum);
                return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }),
            datasets: [{
                label: 'Ø Preis',
                data: preis_historie.map(h => h.durchschnitt),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => '€' + ctx.parsed.y.toFixed(2)
                    }
                }
            },
            scales: {
                x: {
                    ticks: { 
                        maxTicksLimit: 10,
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: (value) => '€' + value.toFixed(2)
                    }
                }
            }
        }
    });
} else {
    document.getElementById('chart-gruppe').parentElement.innerHTML = 
        '<div class="alert alert-info">Keine Preisentwicklungsdaten verfügbar.</div>';
}

// Produkte anzeigen
const container = document.getElementById('produkte-container');

if (produkte && produkte.length > 0) {
    produkte.forEach(p => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-3';
        
        let badgeClass = 'bg-info';
        if (p.diff_pct > 50) badgeClass = 'bg-danger';
        else if (p.diff_pct > 20) badgeClass = 'bg-warning';
        
        col.innerHTML = `
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">${p.produkt_name}</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-success small">Min: €${p.min_preis.toFixed(2)}</span>
                        <i class="bi bi-arrow-right"></i>
                        <span class="text-danger small">Max: €${p.max_preis.toFixed(2)}</span>
                    </div>
                    <div class="text-center">
                        <span class="badge ${badgeClass}">+${p.diff_pct.toFixed(1)}%</span>
                        <div class="text-muted small mt-1">€${p.diff.toFixed(2)} Differenz</div>
                        <div class="text-muted small"><i class="bi bi-cart"></i> ${p.anzahl_kaeufe} Käufe</div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
} else {
    container.innerHTML = '<div class="col-12"><div class="alert alert-info">Keine Produkte mit Preisänderungen gefunden.</div></div>';
}
</script>
{% endblock %}