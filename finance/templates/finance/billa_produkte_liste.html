{% extends "finance/base.html" %}
{% load static %}

{% block title %}Alle Produkte - Billa{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .produkt-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 15px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .produkt-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .produkt-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
    }
    .produkt-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
    }
    .stat-item {
        text-align: center;
        flex: 1;
    }
    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .kategorie-dropdowns {
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .kategorie-dropdowns .row {
        align-items: center;
    }
    .kategorie-dropdowns label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #495057;
    }
    .kategorie-dropdowns select {
        font-size: 0.9rem;
    }
    .save-status {
        font-size: 0.85rem;
        margin-top: 5px;
        min-height: 20px;
    }
    .produkt-link {
        text-decoration: none;
        color: inherit;
    }
    .produkt-link:hover .produkt-name {
        color: #667eea;
    }
    .success-flash {
        animation: flashGreen 1s ease;
    }
    @keyframes flashGreen {
        0%, 100% { background-color: white; }
        50% { background-color: #d4edda; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-box-seam"></i> Alle Produkte
            </h1>
            <p class="text-muted mb-0">Übersicht aller Billa-Produkte mit Bearbeitungsfunktion</p>
        </div>
        <a href="{% url 'finance:billa_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get">
            <div class="row g-3">
                <!-- Suche -->
                <div class="col-md-4">
                    <label for="suche" class="form-label">
                        <i class="bi bi-search"></i> Suche
                    </label>
                    <input
                        type="text"
                        class="form-control"
                        id="suche"
                        name="suche"
                        placeholder="Produktname..."
                        value="{{ suche }}"
                    >
                </div>

                <!-- Überkategorie Filter -->
                <div class="col-md-3">
                    <label for="ueberkategorie" class="form-label">
                        <i class="bi bi-tag"></i> Überkategorie
                    </label>
                    <select class="form-select" id="ueberkategorie" name="ueberkategorie">
                        <option value="alle" {% if selected_ueberkategorie == 'alle' %}selected{% endif %}>
                            Alle Kategorien
                        </option>
                        {% for kat in ueberkategorien %}
                        <option value="{{ kat }}" {% if selected_ueberkategorie == kat %}selected{% endif %}>
                            {{ kat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sortierung -->
                <div class="col-md-3">
                    <label for="sort" class="form-label">
                        <i class="bi bi-sort-down"></i> Sortierung
                    </label>
                    <select class="form-select" id="sort" name="sort">
                        <option value="-anzahl_kaeufe" {% if sortierung == '-anzahl_kaeufe' %}selected{% endif %}>
                            Häufigste zuerst
                        </option>
                        <option value="anzahl_kaeufe" {% if sortierung == 'anzahl_kaeufe' %}selected{% endif %}>
                            Seltenste zuerst
                        </option>
                        <option value="name_normalisiert" {% if sortierung == 'name_normalisiert' %}selected{% endif %}>
                            Name A-Z
                        </option>
                        <option value="-name_normalisiert" {% if sortierung == '-name_normalisiert' %}selected{% endif %}>
                            Name Z-A
                        </option>
                    </select>
                </div>

                <!-- Buttons -->
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </div>

            <!-- Aktive Filter -->
            {% if suche or selected_ueberkategorie != 'alle' %}
            <div class="mt-3">
                <small class="text-muted">Aktive Filter:</small>
                {% if suche %}
                <span class="badge bg-info ms-2">Suche: "{{ suche }}"</span>
                {% endif %}
                {% if selected_ueberkategorie != 'alle' %}
                <span class="badge bg-info ms-2">Kategorie: {{ selected_kategorie_display }}</span>
                {% endif %}
                <a href="{% url 'finance:billa_produkte_liste' %}" class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="bi bi-x"></i> Zurücksetzen
                </a>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Ergebnis-Anzahl -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <p class="text-muted mb-0">
            <strong>{{ produkte.count }}</strong> Produkte gefunden
        </p>
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> Tipp: Änderungen werden automatisch gespeichert
        </small>
    </div>

    <!-- Produktliste -->
    <div class="row">
        {% for produkt in produkte %}
        <div class="col-md-6 col-lg-4">
            <div class="produkt-card" data-produkt-id="{{ produkt.id }}">
                <!-- Produkt Name (klickbar) -->
                <a href="{% url 'finance:billa_produkt_detail' produkt.id %}" class="produkt-link">
                    <div class="produkt-name">
                        <i class="bi bi-box"></i> {{ produkt.name_normalisiert }}
                    </div>
                </a>

                <!-- Dropdown-Bearbeitungsfelder -->
                <div class="kategorie-dropdowns">
                    <div class="row g-2">
                        <!-- Überkategorie -->
                        <div class="col-6">
                            <label>Überkategorie</label>
                            <select 
                                class="form-select form-select-sm kategorie-dropdown"
                                data-field="ueberkategorie"
                                data-produkt-id="{{ produkt.id }}"
                            >
                                <option value="">- Keine -</option>
                                {% for kat in ueberkategorien %}
                                <option value="{{ kat }}" {% if produkt.ueberkategorie == kat %}selected{% endif %}>
                                    {{ kat }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Produktgruppe -->
                        <div class="col-6">
                            <label>Produktgruppe</label>
                            <select 
                                class="form-select form-select-sm kategorie-dropdown produktgruppe-dropdown"
                                data-field="produktgruppe"
                                data-produkt-id="{{ produkt.id }}"
                                data-current-value="{{ produkt.produktgruppe|default:'' }}"
                                data-current-ueberkategorie="{{ produkt.ueberkategorie|default:'' }}"
                            >
                                <option value="">- Keine -</option>
                                <!-- Wird dynamisch gefüllt -->
                            </select>
                        </div>
                    </div>

                    <!-- Status-Anzeige -->
                    <div class="save-status text-center" data-status-for="{{ produkt.id }}">
                        <!-- Hier erscheinen Statusmeldungen -->
                    </div>
                </div>

                <!-- Statistiken -->
                <div class="produkt-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ produkt.anzahl_kaeufe }}</div>
                        <div class="stat-label">Käufe</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% if produkt.letzter_preis %}
                            € {{ produkt.letzter_preis|floatformat:2 }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                        <div class="stat-label">Aktuell</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% if produkt.durchschnittspreis %}
                            € {{ produkt.durchschnittspreis|floatformat:2 }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                        <div class="stat-label">Ø Preis</div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i>
                Keine Produkte gefunden.
                {% if suche or selected_ueberkategorie != 'alle' %}
                <br>
                <a href="{% url 'finance:billa_produkte_liste' %}" class="alert-link">
                    Filter zurücksetzen
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Produktgruppen-Mapping aus Django Context
    const produktgruppenByUeberkategorie = JSON.parse('{{ produktgruppen_by_ueberkategorie|escapejs }}');
    
    console.log('Produktgruppen-Mapping geladen:', produktgruppenByUeberkategorie);
    
    // Alle Produktkarten initialisieren
    document.querySelectorAll('.produkt-card').forEach(card => {
        initializeCard(card);
    });
    
    function initializeCard(card) {
        const ueberkategorieSelect = card.querySelector('[data-field="ueberkategorie"]');
        const produktgruppeSelect = card.querySelector('[data-field="produktgruppe"]');
        
        if (!ueberkategorieSelect || !produktgruppeSelect) return;
        
        // Initial die Produktgruppen laden
        const currentUeberkategorie = produktgruppeSelect.dataset.currentUeberkategorie;
        const currentProduktgruppe = produktgruppeSelect.dataset.currentValue;
        
        updateProduktgruppenDropdown(ueberkategorieSelect.value, produktgruppeSelect, currentProduktgruppe);
        
        // Event-Listener für Überkategorie-Änderung
        ueberkategorieSelect.addEventListener('change', function() {
            const selectedUeberkategorie = this.value;
            updateProduktgruppenDropdown(selectedUeberkategorie, produktgruppeSelect, '');
            
            // Speichern auslösen
            saveChangesDebounced(card);
        });
        
        // Event-Listener für Produktgruppe-Änderung
        produktgruppeSelect.addEventListener('change', function() {
            saveChangesDebounced(card);
        });
    }
    
    function updateProduktgruppenDropdown(ueberkategorie, dropdown, selectedValue) {
        // Leere die Dropdown
        dropdown.innerHTML = '<option value="">- Keine -</option>';
        
        if (!ueberkategorie) {
            // Wenn keine Überkategorie ausgewählt, alle Produktgruppen anzeigen
            const alleGruppen = new Set();
            Object.values(produktgruppenByUeberkategorie).forEach(gruppen => {
                gruppen.forEach(gruppe => alleGruppen.add(gruppe));
            });
            
            Array.from(alleGruppen).sort().forEach(gruppe => {
                const option = document.createElement('option');
                option.value = gruppe;
                option.textContent = gruppe;
                if (gruppe === selectedValue) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        } else {
            // Nur Produktgruppen dieser Überkategorie anzeigen
            const gruppen = produktgruppenByUeberkategorie[ueberkategorie] || [];
            
            gruppen.forEach(gruppe => {
                const option = document.createElement('option');
                option.value = gruppe;
                option.textContent = gruppe;
                if (gruppe === selectedValue) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }
    }
    
    // Debounce für Speichern
    let saveTimeouts = {};
    
    function saveChangesDebounced(card) {
        const produktId = card.dataset.produktId;
        const statusDiv = card.querySelector(`[data-status-for="${produktId}"]`);
        
        // Status anzeigen
        statusDiv.innerHTML = '<small class="text-muted"><i class="bi bi-hourglass-split"></i> Speichere...</small>';
        
        // Alten Timer löschen
        if (saveTimeouts[produktId]) {
            clearTimeout(saveTimeouts[produktId]);
        }
        
        // Neuen Timer setzen
        saveTimeouts[produktId] = setTimeout(() => {
            saveChanges(card);
        }, 500);
    }
    
    function saveChanges(card) {
        const produktId = card.dataset.produktId;
        const statusDiv = card.querySelector(`[data-status-for="${produktId}"]`);
        const ueberkategorieSelect = card.querySelector('[data-field="ueberkategorie"]');
        const produktgruppeSelect = card.querySelector('[data-field="produktgruppe"]');
        
        const data = {
            produkte: [{
                id: produktId,
                ueberkategorie: ueberkategorieSelect.value,
                produktgruppe: produktgruppeSelect.value
            }]
        };
        
        // AJAX-Request
        fetch('{% url "finance:produktgruppen_speichern" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                statusDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle-fill"></i> Gespeichert!</small>';
                card.classList.add('success-flash');
                
                // Status nach 2 Sekunden ausblenden
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                    card.classList.remove('success-flash');
                }, 2000);
            } else {
                statusDiv.innerHTML = '<small class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Fehler!</small>';
            }
        })
        .catch(error => {
            console.error('Fehler:', error);
            statusDiv.innerHTML = '<small class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Verbindungsfehler!</small>';
        });
    }
    
    // CSRF Token holen
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}