{% extends 'finance/base.html' %}

{% block title %}Dashboard - Finance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard {{ current_year }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-calendar"></i> Jahr: {{ current_year }}
            </button>
        </div>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card kpi-card income">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Einnahmen</h6>
                        <h3 class="card-title mb-0">€ {{ total_inflow|floatformat:2 }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-down-circle text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card kpi-card expense">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Ausgaben</h6>
                        <h3 class="card-title mb-0">€ {{ total_outflow|floatformat:2 }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-up-circle text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card kpi-card balance">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Saldo</h6>
                        <h3 class="card-title mb-0" style="color: {% if netto >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                            € {{ netto|floatformat:2 }}
                        </h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-wallet2 text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card kpi-card transactions">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-2 text-muted">Transaktionen</h6>
                        <h3 class="card-title mb-0">{{ transaction_count }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-receipt text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-8 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Monatliche Übersicht {{ current_year }}</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Ausgaben nach Kategorie</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Historischer Trend -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Ausgaben-Trend (Alle Monate)
                </h5>
                <small class="text-muted">Netto-Ausgaben mit Trendlinie</small>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="60"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Top Payees</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Payee</th>
                                <th class="text-center">Anzahl</th>
                                <th class="text-end">Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payee in top_payees %}
                            <tr>
                                <td>{{ payee.payee__payee|default:"Unbekannt" }}</td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{{ payee.count }}</span>
                                </td>
                                <td class="text-end">€ {{ payee.total|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Letzte Transaktionen</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Payee</th>
                                <th class="text-end">Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in recent_transactions %}
                            <tr>
                                <td>{{ trans.date|date:"d.m.Y" }}</td>
                                <td>{{ trans.payee|default:"-" }}</td>
                                <td class="text-end">
                                    {% if trans.outflow %}
                                        <span class="text-danger">- € {{ trans.outflow|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-success">+ € {{ trans.inflow|floatformat:2 }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Income nach Payees - Gestapeltes Balkendiagramm -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cash-stack"></i> Einnahmen nach Payee ({{ current_year }})
                </h5>
                <small class="text-muted">Gestapelte Ansicht aller Income-Quellen</small>
            </div>
            <div class="card-body">
                <canvas id="incomePayeesChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Monatlicher Chart (aktuelles Jahr)
fetch("{% url 'finance:api_monthly_spending' %}?year={{ current_year }}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€ ' + value.toLocaleString('de-DE');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': € ' +
                                       context.parsed.y.toLocaleString('de-DE', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    });

// Kategorien Pie Chart
fetch("{% url 'finance:api_category_breakdown' %}?year={{ current_year }}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': € ' +
                                       context.parsed.toLocaleString('de-DE', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    });

fetch("{% url 'finance:api_spending_trend' %}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('trendChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Netto-Ausgaben',
                        data: data.spending,
                        borderColor: 'rgb(243,123,123)',
                        backgroundColor: 'rgba(243,123,123,0.16)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: 'rgb(243,123,123)',
                    },
                    {
                        label: 'Einnahmen',
                        data: data.income,
                        borderColor: 'rgb(115,239,100)',
                        backgroundColor: 'rgba(115,239,100,0.11)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: 'rgb(115,239,100)',
                    },
                    {
                        label: 'Ausgaben-Trend',
                        data: data.trend,
                        borderColor: 'rgba(236,119,0,0.59)',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        tension: 0,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€ ' + value.toLocaleString('de-DE');
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 24
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });

    // Income Payees Chart (Gestapelt)
    fetch('/api/income-payees/?year={{ current_year }}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('incomePayeesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€ ' + value.toLocaleString('de-DE');
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    // Zeige Gesamtsumme für diesen Monat
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return 'Gesamt: € ' + sum.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    }
                }
            });
        })
.catch(error => console.error('Fehler beim Laden der Income Payees:', error));

</script>
{% endblock %}