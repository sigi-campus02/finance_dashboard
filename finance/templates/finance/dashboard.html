{% extends 'finance/base.html' %}
{% load finance_filters %}

{% block title %}Dashboard - Finance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard {{ current_year }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <form method="get" id="yearFilterForm">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-calendar"></i> Jahr: {{ current_year }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% for year in available_years %}
                    <li>
                        <a class="dropdown-item {% if year == current_year %}active{% endif %}"
                           href="?year={{ year }}">
                            {{ year }}
                        </a>
                    </li>
                    {% endfor %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="?">
                            <i class="bi bi-arrow-clockwise"></i> Alle Jahre
                        </a>
                    </li>
                </ul>
            </div>
        </form>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
    <div class="col-6 col-md-3 mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="card-subtitle mb-2 text-muted">Einnahmen</h6>
                    <h3 class="card-title mb-0">{{ total_inflow|currency }}</h3>
                </div>
                <div class="align-self-center">
                    <i class="bi bi-arrow-down-circle text-success" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3 mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="card-subtitle mb-2 text-muted">Ausgaben</h6>
                    <h3 class="card-title mb-0">{{ total_outflow|currency }}</h3>
                </div>
                <div class="align-self-center">
                    <i class="bi bi-arrow-up-circle text-danger" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3 mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="card-subtitle mb-2 text-muted">Saldo</h6>
                    <h3 class="card-title mb-0" style="color: {% if netto >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                        {{ netto|currency }}
                    </h3>
                </div>
                <div class="align-self-center">
                    <i class="bi bi-wallet2 text-primary" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-6 col-md-3 mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="card-subtitle mb-2 text-muted">Transaktionen</h6>
                    <h3 class="card-title mb-0">{{ transaction_count|thousand }}</h3>
                </div>
                <div class="align-self-center">
                    <i class="bi bi-receipt text-warning" style="font-size: 2rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<!-- Charts -->
<div class="row mb-4">
    <!-- Monthly Chart OHNE Drilldown -->
    <div class="col-md-8 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Monatliche Übersicht {{ current_year }}</h5>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Doughnut Chart MIT Drilldown -->
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="categoryChartTitle">Ausgaben nach Kategorie</h5>
                <button id="backToOverview" class="btn btn-sm btn-outline-secondary" style="display: none;">
                    <i class="bi bi-arrow-left"></i> Zurück
                </button>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 300px;">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="mt-2 text-muted small text-center" id="drilldownHint">
                    <i class="bi bi-info-circle"></i> Klicke auf eine Kategorie um Details zu sehen
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historischer Trend -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Ausgaben-Trend (Alle Monate)
                </h5>
                <small class="text-muted">Netto-Ausgaben mit Trendlinie</small>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Top Payees</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Payee</th>
                                <th class="text-center">Anzahl</th>
                                <th class="text-end">Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payee in top_payees %}
                            <tr>
                                <td>{{ payee.payee__payee|default:"Unbekannt" }}</td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{{ payee.count|thousand }}</span>
                                </td>
                                <td class="text-end">{{ payee.total|currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Letzte Transaktionen</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Payee</th>
                                <th class="text-end">Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trans in recent_transactions %}
                            <tr>
                                <td>{{ trans.date|date:"d.m.Y" }}</td>
                                <td>{{ trans.payee|default:"-" }}</td>
                                <td class="text-end">
                                    {% if trans.outflow %}
                                        <span class="text-danger">- {{ trans.outflow|currency }}</span>
                                    {% else %}
                                        <span class="text-success">+ {{ trans.inflow|currency }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Income nach Payees - Gestapeltes Balkendiagramm -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cash-stack"></i> Einnahmen nach Payee ({{ current_year }})
                </h5>
                <small class="text-muted">Gestapelte Ansicht aller Income-Quellen</small>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="incomePayeesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
// ===== DASHBOARD MIT CATEGORY DOUGHNUT DRILLDOWN =====

// Globale Variablen
let categoryChartInstance = null;
let currentDrilldownState = {
    level: 'overview',
    categorygroupName: null
};

// Mobile Detection
function isMobileDevice() {
    return window.innerWidth < 768;
}

function isSmallMobile() {
    return window.innerWidth < 576;
}

// ===== 1. MONTHLY CHART (OHNE DRILLDOWN) =====
fetch("{% url 'finance:api_monthly_spending' %}?year={{ current_year }}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        const isMobile = isMobileDevice();
        const isSmall = isSmallMobile();
        
        new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            font: { size: isSmall ? 9 : (isMobile ? 10 : 12) },
                            maxRotation: isMobile ? 45 : 0,
                            minRotation: isMobile ? 45 : 0
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            font: { size: isSmall ? 9 : (isMobile ? 10 : 12) },
                            callback: function(value) {
                                if (isMobile && value >= 1000) {
                                    return '€' + (value / 1000).toFixed(0) + 'k';
                                }
                                return '€ ' + value.toLocaleString('de-DE');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: isMobile ? 'bottom' : 'top',
                        labels: {
                            font: { size: isSmall ? 10 : (isMobile ? 11 : 12) },
                            padding: isSmall ? 8 : (isMobile ? 10 : 15),
                            boxWidth: isMobile ? 12 : 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': € ' +
                                       context.parsed.y.toLocaleString('de-DE', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => console.error('Fehler beim Laden des Monthly Chart:', error));

// ===== 2. CATEGORY DOUGHNUT OVERVIEW (MIT DRILLDOWN) =====
function loadCategoryOverview() {
    fetch("{% url 'finance:api_category_breakdown' %}?year={{ current_year }}")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            const isMobile = isMobileDevice();
            const isSmall = isSmallMobile();
            
            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: isSmall ? 10 : (isMobile ? 11 : 12) },
                                padding: isSmall ? 8 : 10,
                                boxWidth: isMobile ? 12 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': € ' + value.toLocaleString('de-DE', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    onClick: function(event, elements, chart) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categorygroupName = chart.data.labels[index];
                            
                            console.log('Category clicked:', categorygroupName);
                            loadCategoryDrilldown(categorygroupName);
                        }
                    }
                }
            });
            
            currentDrilldownState.level = 'overview';
            currentDrilldownState.categorygroupName = null;
            
            document.getElementById('backToOverview').style.display = 'none';
            document.getElementById('categoryChartTitle').textContent = 'Ausgaben nach Kategorie';
            
            const drilldownHint = document.getElementById('drilldownHint');
            if (drilldownHint) {
                drilldownHint.style.display = 'block';
            }
        })
        .catch(error => console.error('Fehler beim Laden des Category Chart:', error));
}

// ===== 3. CATEGORY DRILLDOWN (EINZELNE CATEGORIES) =====
function loadCategoryDrilldown(categorygroupName) {
    fetch(`{% url 'finance:api_category_breakdown' %}?year={{ current_year }}&categorygroup=${encodeURIComponent(categorygroupName)}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            const isMobile = isMobileDevice();
            const isSmall = isSmallMobile();
            
            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: isSmall ? 10 : (isMobile ? 11 : 12) },
                                padding: isSmall ? 8 : 10,
                                boxWidth: isMobile ? 12 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': € ' + value.toLocaleString('de-DE', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            
            currentDrilldownState.level = 'drilldown';
            currentDrilldownState.categorygroupName = categorygroupName;
            
            document.getElementById('backToOverview').style.display = 'inline-block';
            document.getElementById('categoryChartTitle').textContent = categorygroupName;
            
            const drilldownHint = document.getElementById('drilldownHint');
            if (drilldownHint) {
                drilldownHint.style.display = 'none';
            }
        })
        .catch(error => console.error('Fehler beim Laden des Category Drilldown:', error));
}

// ===== BACK BUTTON =====
document.getElementById('backToOverview').addEventListener('click', function() {
    loadCategoryOverview();
});

// ===== INITIAL LOAD =====
loadCategoryOverview();

// ===== 3. TREND CHART =====
fetch("{% url 'finance:api_spending_trend' %}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const isMobile = isMobileDevice();
        const isSmall = isSmallMobile();

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Netto-Ausgaben',
                        data: data.spending,
                        borderColor: 'rgb(243,123,123)',
                        backgroundColor: 'rgba(243,123,123,0.16)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: isMobile ? 2 : 3,
                        pointHoverRadius: isMobile ? 4 : 5,
                    },
                    {
                        label: 'Einnahmen',
                        data: data.income,
                        borderColor: 'rgb(115,239,100)',
                        backgroundColor: 'rgba(115,239,100,0.11)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: isMobile ? 2 : 3,
                        pointHoverRadius: isMobile ? 4 : 5,
                    },
                    {
                        label: 'Ausgaben-Trend',
                        data: data.trend,
                        borderColor: 'rgba(236,119,0,0.59)',
                        backgroundColor: 'transparent',
                        borderWidth: isMobile ? 2 : 3,
                        borderDash: [10, 5],
                        tension: 0,
                        fill: false,
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: { size: isSmall ? 9 : (isMobile ? 10 : 12) },
                            callback: function(value) {
                                if (isMobile && value >= 1000) {
                                    return '€' + (value / 1000).toFixed(0) + 'k';
                                }
                                return '€ ' + value.toLocaleString('de-DE');
                            }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: isSmall ? 8 : (isMobile ? 9 : 11) },
                            maxRotation: isMobile ? 45 : 45,
                            minRotation: isMobile ? 45 : 0,
                            autoSkip: true,
                            maxTicksLimit: isMobile ? 8 : 24
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: isMobile ? 'bottom' : 'top',
                        labels: {
                            font: { size: isSmall ? 10 : (isMobile ? 11 : 12) },
                            padding: isSmall ? 8 : (isMobile ? 10 : 15),
                            boxWidth: isMobile ? 12 : 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                return label;
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => console.error('Fehler beim Laden des Trend Chart:', error));

// ===== 4. INCOME PAYEES CHART =====
fetch('/api/income-payees/?year={{ current_year }}')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('incomePayeesChart').getContext('2d');
        const isMobile = isMobileDevice();
        const isSmall = isSmallMobile();
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: {
                            font: { size: isSmall ? 9 : (isMobile ? 10 : 11) },
                            maxRotation: isMobile ? 45 : 45,
                            minRotation: isMobile ? 45 : 0,
                            autoSkip: true,
                            maxTicksLimit: isMobile ? 6 : 12
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            font: { size: isSmall ? 9 : (isMobile ? 10 : 12) },
                            callback: function(value) {
                                if (isMobile && value >= 1000) {
                                    return '€' + (value / 1000).toFixed(0) + 'k';
                                }
                                return '€ ' + value.toLocaleString('de-DE');
                            }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: isMobile ? 'bottom' : 'top',
                        labels: {
                            boxWidth: isMobile ? 10 : 15,
                            padding: isSmall ? 8 : (isMobile ? 10 : 10),
                            font: { size: isSmall ? 10 : (isMobile ? 11 : 11) }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                return label;
                            },
                            footer: function(tooltipItems) {
                                let sum = 0;
                                tooltipItems.forEach(item => sum += item.parsed.y);
                                return 'Gesamt: € ' + sum.toLocaleString('de-DE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                            }
                        }
                    }
                }
            }
        });
    })
    .catch(error => console.error('Fehler beim Laden der Income Payees:', error));

// ===== RESIZE HANDLER =====
let resizeTimeout;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        if (currentDrilldownState.level === 'overview') {
            loadCategoryOverview();
        } else {
            loadCategoryDrilldown(currentDrilldownState.categorygroupName);
        }
    }, 500);
});
</script>

{% endblock %}