{% extends 'finance/base.html' %}

{% block title %}Dashboard Haushalt{% endblock %}

{% block content %}
<style>
    .chart-container-horizontal {
        position: relative;
        height: 600px;
        padding-bottom: 10px;
    }

    .chart-container-medium {
        position: relative;
        height: 280px;  /* GEÄNDERT von 400px auf 280px */
        padding-bottom: 10px;
    }

    .categorygroup-header {
        padding: 15px 20px;
        color: white;
        border-radius: 5px 5px 0 0;
        margin-bottom: 0;
    }

    .stat-box {
        background: #f8f9fa;
        border-left: 4px solid;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    /* Mobile: Mehr Höhe für bessere Lesbarkeit */
    @media (max-width: 768px) {
        .chart-container-horizontal {
            height: 700px;
            padding-bottom: 15px;
        }
        .chart-container-medium {
            height: 350px;  /* GEÄNDERT von 500px auf 350px */
            padding-bottom: 15px;
        }
    }

    /* Extra kleine Geräte: Noch mehr Höhe */
    @media (max-width: 576px) {
        .chart-container-horizontal {
            height: 800px;
            padding-bottom: 20px;
        }
        .chart-container-medium {
            height: 400px;  /* GEÄNDERT von 600px auf 400px */
            padding-bottom: 20px;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-house-door"></i> Dashboard Haushalt
            </h1>
            <p class="text-muted mb-0">Visualisierung der Haushaltsausgaben</p>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>Hinweis:</strong>
        Dieses Dashboard zeigt alle Transaktionen von Robert sowie Sigis Transaktionen mit Flag "Relevant für Haushaltsbudget".
        Transfers, Kursschwankungen und "Ready to Assign" sind ausgeschlossen.
    </div>

    <!-- Gestapeltes Balkendiagramm -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-fill"></i> Monatliche Ausgaben (Netto)
                        </h5>
                        <small>Gestapelt nach Person</small>
                    </div>
                    <div>
                        <select id="barChartYearSelect" class="form-select form-select-sm">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container-horizontal">
                        <canvas id="monthlyStackedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tortendiagramme -->
    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2025
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryPieChart2025" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2024
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryPieChart2024" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SPECIAL SECTION: SUPERMARKT (Kategorie 1.4. id=5) ===== -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(52, 168, 83);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> 1.4. Supermarkt - Detailanalyse
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Statistiken -->
                    <div class="stat-box" style="border-left-color: rgb(52, 168, 83);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-supermarket">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-supermarket">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-supermarket">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monatliche Entwicklung mit Trendlinie -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Jahresvergleich 2024 vs 2025 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SPECIAL: Kombiniertes Billa-Diagramm -->
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-bag-check"></i> Billa-Einkäufe: Anzahl & Durchschnittliche Höhe</h5>
                            <p class="text-muted">
                                <small>Balken zeigen die Anzahl der Einkäufe, Linie zeigt die durchschnittliche Einkaufshöhe pro Monat</small>
                            </p>
                            <div class="chart-container-medium">
                                <canvas id="billaCombinedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ===== END SUPERMARKT SECTION ===== -->

    <!-- 1. Haushaltsausgaben -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(91, 155, 213);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> Haushaltsausgaben
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(91, 155, 213);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-2">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-2">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-2">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart2"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart2"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Wohnung -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(237, 125, 49);">
                    <h4 class="mb-0">
                        <i class="bi bi-house"></i> Wohnung
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(237, 125, 49);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-3">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-3">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-3">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart3"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart3"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart3"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Restaurant & Lieferservice -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(132, 151, 176);">
                    <h4 class="mb-0">
                        <i class="bi bi-cup-straw"></i> Restaurant & Lieferservice
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(132, 151, 176);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-4">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-4">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-4">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart4"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart4"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart4"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Ärzte & Gesundheit -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 192, 0);">
                    <h4 class="mb-0">
                        <i class="bi bi-heart-pulse"></i> Ärzte & Gesundheit
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 192, 0);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-5">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-5">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-5">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart5"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart5"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart5"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Freizeit & Hobby & Urlaub -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(112, 173, 71);">
                    <h4 class="mb-0">
                        <i class="bi bi-balloon"></i> Freizeit & Hobby & Urlaub
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(112, 173, 71);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-6">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-6">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-6">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart6"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart6"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart6"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Geschenke -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(68, 114, 196);">
                    <h4 class="mb-0">
                        <i class="bi bi-gift"></i> Geschenke
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(68, 114, 196);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-7">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-7">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-7">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart7"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart7"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart7"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. KFZ -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 0, 102);">
                    <h4 class="mb-0">
                        <i class="bi bi-car-front"></i> KFZ
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 0, 102);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-10">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Anzahl Monate</h6>
                                <h5 class="mb-0" id="num-months-10">-</h5>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                <h5 class="mb-0" id="total-spending-10">-</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart10"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart10"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart10"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link zur Transaktionsliste -->
    <div class="row">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="bi bi-list-ul"></i> Detaillierte Transaktionsansicht
                    </h5>
                    <p class="card-text text-muted">
                        Für eine detaillierte Übersicht aller Haushalt-Transaktionen mit Filtermöglichkeiten.
                    </p>
                    <a href="{% url 'finance:household_transactions' %}" class="btn btn-primary">
                        <i class="bi bi-arrow-right-circle"></i> Zu den Transaktionen
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
// ===== BESTEHENDE CHART-VARIABLEN UND FUNKTIONEN =====
let monthlyChart = null;
let pieChart2025 = null;
let pieChart2024 = null;

// Funktion zum Laden des gestapelten Balkendiagramms
function loadMonthlyChart(year) {
    fetch(`/api/household-monthly-spending/?year=${year}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('monthlyStackedChart').getContext('2d');

            // Destroy existing chart
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',  // Horizontale Balken
                    responsive: true,
                    maintainAspectRatio: false,  // Ermöglicht flexible Höhe
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '€ ' + value.toLocaleString('de-DE');
                                },
                                font: {
                                    size: window.innerWidth < 576 ? 10 : 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: window.innerWidth < 576 ? 11 : 12
                                },
                                autoSkip: false  // Zeige alle Monate
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: window.innerWidth < 576 ? 11 : 13
                                },
                                padding: window.innerWidth < 576 ? 10 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Bei horizontalen Balken ist der Wert in context.parsed.x
                                    return context.dataset.label + ': € ' +
                                           context.parsed.x.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           });
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.x;
                                    });
                                    return '━━━━━━━━━━━━━━━━\nGesamt: € ' + sum.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Fehler beim Laden der monatlichen Daten:', error);
        });
}

// Funktion zum Laden des Tortendiagramms
function loadPieChart(year, canvasId, chartVariable) {
    fetch(`/api/household-category-breakdown/?year=${year}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Destroy existing chart
            if (chartVariable === '2025' && pieChart2025) {
                pieChart2025.destroy();
            } else if (chartVariable === '2024' && pieChart2024) {
                pieChart2024.destroy();
            }

            const newChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    return label + ': € ' +
                                           value.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           }) +
                                           ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });

            // Store chart reference
            if (chartVariable === '2025') {
                pieChart2025 = newChart;
            } else if (chartVariable === '2024') {
                pieChart2024 = newChart;
            }
        })
        .catch(error => {
            console.error(`Fehler beim Laden der Kategoriedaten für ${year}:`, error);
        });
}

// ===== NEUE CATEGORYGROUP CHARTS =====

const categoryGroups = [2, 3, 4, 5, 6, 7, 10];

// Format für Euro-Werte
function formatEuro(value) {
    return new Intl.NumberFormat('de-DE', { 
        style: 'currency', 
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

// Lade Statistiken für alle CategoryGroups
function loadCategoryGroupStats() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-stats/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`avg-spending-${groupId}`).innerHTML = formatEuro(data.monthly_average);
                document.getElementById(`num-months-${groupId}`).textContent = data.num_months;
                document.getElementById(`total-spending-${groupId}`).textContent = formatEuro(data.total_spending);
            })
            .catch(error => {
                console.error(`Error loading stats for group ${groupId}:`, error);
                document.getElementById(`avg-spending-${groupId}`).innerHTML = '<span class="text-danger">Fehler</span>';
            });
    });
}

// Erstelle Trendlinie-Diagramme
function createTrendCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-monthly-trend/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`trendChart${groupId}`).getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Ausgaben',
                                data: data.data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Trend',
                                data: data.trend_data,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating trend chart ${groupId}:`, error));
    });
}

// Erstelle Vergleichs-Diagramme (2024 vs 2025)
function createComparisonCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-year-comparison/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`comparisonChart${groupId}`).getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '2025',
                                data: data.data_2025,
                                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '2024',
                                data: data.data_2024,
                                backgroundColor: 'rgba(128, 128, 128, 0.5)',
                                borderColor: 'rgba(128, 128, 128, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating comparison chart ${groupId}:`, error));
    });
}

// Erstelle Quartals-Diagramme
function createQuarterlyCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-quarterly-breakdown/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`quarterlyChart${groupId}`).getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating quarterly chart ${groupId}:`, error));
    });
}
// ===== SUPERMARKT-BEREICH FUNCTIONS =====

// Lade Supermarkt-Statistiken
function loadSupermarketStats() {
    fetch('/api/supermarket-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('avg-spending-supermarket').innerHTML = formatEuro(data.monthly_average);
            document.getElementById('num-months-supermarket').textContent = data.num_months;
            document.getElementById('total-spending-supermarket').textContent = formatEuro(data.total_spending);
        })
        .catch(error => {
            console.error('Error loading supermarket stats:', error);
            document.getElementById('avg-spending-supermarket').innerHTML = '<span class="text-danger">Fehler</span>';
        });
}

// Erstelle Supermarkt Trendlinie-Diagramm
function createSupermarketTrendChart() {
    fetch('/api/supermarket-monthly-trend/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketTrendChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Ausgaben',
                            data: data.data,
                            borderColor: 'rgb(52, 168, 83)',
                            backgroundColor: 'rgba(52, 168, 83, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Trend',
                            data: data.trend_data,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatEuro(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket trend chart:', error));
}

// Erstelle Supermarkt Jahresvergleichs-Diagramm
function createSupermarketComparisonChart() {
    fetch('/api/supermarket-year-comparison/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketComparisonChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatEuro(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket comparison chart:', error));
}

// Erstelle kombiniertes Billa-Diagramm (Balken + Linie)
function createBillaCombinedChart() {
    fetch('/api/billa-combined-chart/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('billaCombinedChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Anzahl Einkäufe',
                            data: data.count_data,
                            backgroundColor: 'rgba(91, 155, 213, 0.7)',
                            borderColor: 'rgba(91, 155, 213, 1)',
                            borderWidth: 1,
                            yAxisID: 'y-count',
                            order: 2
                        },
                        {
                            label: 'Durchschnittliche Einkaufshöhe',
                            data: data.avg_data,
                            type: 'line',
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            tension: 0.4,
                            yAxisID: 'y-avg',
                            order: 1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-count') {
                                        label += context.parsed.y + ' Einkäufe';
                                    } else {
                                        label += formatEuro(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        'y-count': {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + ' x';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Anzahl Einkäufe'
                            }
                        },
                        'y-avg': {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Durchschnittliche Einkaufshöhe'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading Billa combined chart:', error));
}
// Initialisierung beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    // Lade bestehende Charts (Balken und Tortendiagramme)
    loadMonthlyChart({{ current_year }});
    loadPieChart(2025, 'categoryPieChart2025', '2025');
    loadPieChart(2024, 'categoryPieChart2024', '2024');
    
    // Event Listener für Jahr-Wechsel beim Balkendiagramm
    document.getElementById('barChartYearSelect').addEventListener('change', function() {
        loadMonthlyChart(this.value);
    });
    
    // Lade alle CategoryGroup Daten
    loadCategoryGroupStats();
    createTrendCharts();
    createComparisonCharts();
    createQuarterlyCharts();
    
    // Supermarkt-Bereich laden
    loadSupermarketStats();
    createSupermarketTrendChart();
    createSupermarketComparisonChart();
    createBillaCombinedChart();
});
</script>
{% endblock %}