{% extends 'finance/base.html' %}

{% block title %}Dashboard Haushalt{% endblock %}

{% block content %}
<style>
    /* CSS-Variablen für Theming */
    :root {
        --color-sigi: #5b9bd5;
        --color-sigi-light: rgba(91, 155, 213, 0.1);
        --color-robert: #34a853;
        --color-robert-light: rgba(52, 168, 83, 0.1);
        --color-neutral: #6c757d;
        --color-transfer: #9bafc8;
        --color-positive: #34a853;
        --color-negative: #ea4335;
        --color-warning: #fbbc04;
        --color-card-bg: #ffffff;
        --color-card-border: #e9ecef;
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-card-bg: #1e1e1e;
            --color-card-border: #343a40;
        }
    }

    /* KPI Card Styles */
    .kpi-card {
        background: var(--color-card-bg);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        border: 1px solid var(--color-card-border);
        height: 100%;
    }

    .kpi-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .kpi-card-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-neutral);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .kpi-card-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: #212529;
    }

    .kpi-card-comparison {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .trend-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .trend-positive {
        background-color: rgba(52, 168, 83, 0.1);
        color: var(--color-positive);
    }

    .trend-negative {
        background-color: rgba(234, 67, 53, 0.1);
        color: var(--color-negative);
    }

    .trend-neutral {
        background-color: rgba(108, 117, 125, 0.1);
        color: var(--color-neutral);
    }

    /* Filter Chips */
    .filter-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--color-card-bg);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        box-shadow: var(--shadow-sm);
    }

    .filter-chip-person-sigi {
        border-left: 3px solid var(--color-sigi);
    }

    .filter-chip-person-robert {
        border-left: 3px solid var(--color-robert);
    }

    .filter-chip-remove {
        cursor: pointer;
        color: var(--color-neutral);
        transition: color 0.2s ease;
    }

    .filter-chip-remove:hover {
        color: var(--color-negative);
    }

    /* Drilldown Cards */
    .drilldown-card {
        background: var(--color-card-bg);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        border: 1px solid var(--color-card-border);
        cursor: pointer;
        height: 100%;
    }

    .drilldown-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        border-color: var(--color-sigi);
    }

    .drilldown-card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .drilldown-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--color-card-border);
    }

    .drilldown-list-item:last-child {
        border-bottom: none;
    }

    /* Person Badges */
    .person-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .person-badge-sigi {
        background-color: var(--color-sigi-light);
        color: var(--color-sigi);
    }

    .person-badge-robert {
        background-color: var(--color-robert-light);
        color: var(--color-robert);
    }

    /* Filter Panel Styles */
    .filter-panel-card {
        border: 1px solid var(--color-card-border);
        box-shadow: var(--shadow-sm);
    }

    .filter-panel-card .card-header {
        border-bottom: 2px solid var(--color-card-border);
        padding: 1rem 1.25rem;
    }

    .filter-panel-card .accordion-button {
        font-size: 0.95rem;
        padding: 0.75rem 1rem;
    }

    .filter-panel-card .accordion-button:not(.collapsed) {
        background-color: rgba(91, 155, 213, 0.05);
        color: var(--color-sigi);
    }

    .filter-panel-card .accordion-body {
        padding: 1.5rem 1rem;
        background-color: #fafbfc;
    }

    /* Multi-Select Styling */
    select[multiple] {
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-sm);
    }

    select[multiple]:focus {
        border-color: var(--color-sigi);
        box-shadow: 0 0 0 0.2rem rgba(91, 155, 213, 0.25);
    }

    select[multiple] option:checked {
        background-color: var(--color-sigi);
        color: white;
    }

    /* Filter Chips Container */
    #appliedFiltersChipsContainer {
        padding: 1rem;
        background-color: rgba(91, 155, 213, 0.03);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--color-card-border);
    }

    /* Filter Badge Count */
    #activeFiltersCount {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    /* Mobile Optimierung für Filter Panel */
    @media (max-width: 768px) {
        .filter-panel-card .card-header {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.75rem;
        }

        .filter-panel-card .card-header > div:last-child {
            width: 100%;
            display: flex;
            gap: 0.5rem;
        }

        .filter-panel-card .card-header button {
            flex: 1;
            font-size: 0.85rem;
        }

        select[multiple] {
            font-size: 0.9rem;
        }
    }

    /* Transaktions-Tabelle Styles */
    #transactionsTable {
        font-size: 0.9rem;
    }

    #transactionsTable thead {
        position: sticky;
        top: 56px;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #transactionsTable tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    #transactionsTable tbody tr:hover {
        background-color: rgba(91, 155, 213, 0.05);
    }

    .sticky-actions {
        position: sticky;
        right: 0;
        background-color: white;
        box-shadow: -2px 0 4px rgba(0,0,0,0.05);
    }

    .table-striped tbody tr:nth-of-type(odd) .sticky-actions {
        background-color: rgba(0,0,0,.05);
    }

    /* Mobile Transaction Cards */
    .transaction-card {
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-sm);
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: var(--color-card-bg);
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
    }

    .transaction-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }

    .transaction-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--color-card-border);
    }

    .transaction-card-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .transaction-card-field {
        display: flex;
        flex-direction: column;
    }

    .transaction-card-label {
        font-size: 0.7rem;
        color: var(--color-neutral);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .transaction-card-value {
        font-weight: 500;
        color: #212529;
    }

    .transaction-card-amount {
        font-size: 1.25rem;
        font-weight: 700;
    }

    /* Transaction Details (collapsible) */
    .transaction-details {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-card-border);
        display: none;
    }

    .transaction-details.show {
        display: block;
    }

    @media (max-width: 576px) {
        .transaction-card {
            padding: 0.75rem;
        }

        .transaction-card-body {
            font-size: 0.8rem;
        }

        .transaction-card-amount {
            font-size: 1.1rem;
        }
    }

    /* PHASE 4: Offcanvas Styles */
    .offcanvas-large {
        width: 600px !important;
        max-width: 90vw;
    }

    @media (max-width: 768px) {
        .offcanvas-large {
            width: 100% !important;
        }
    }

    .detail-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--color-card-border);
    }

    .detail-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .detail-section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-sigi);
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px dashed var(--color-card-border);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-size: 0.875rem;
        color: var(--color-neutral);
        font-weight: 500;
    }

    .detail-value {
        font-size: 0.875rem;
        color: #212529;
        font-weight: 600;
        text-align: right;
    }

    .similar-transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: var(--color-card-bg);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .similar-transaction-item:hover {
        background-color: rgba(91, 155, 213, 0.05);
        border-color: var(--color-sigi);
    }

    .transaction-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--color-sigi);
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--color-sigi);
    }

    .timeline-item::after {
        content: '';
        position: absolute;
        left: -1.05rem;
        top: 1.2rem;
        width: 2px;
        height: calc(100% - 0.7rem);
        background-color: var(--color-card-border);
    }

    .timeline-item:last-child::after {
        display: none;
    }

    .timeline-date {
        font-size: 0.75rem;
        color: var(--color-neutral);
        margin-bottom: 0.25rem;
    }

    .timeline-content {
        font-size: 0.875rem;
        color: #212529;
    }

    .stat-card {
        background: var(--color-card-bg);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-sm);
        padding: 1rem;
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-sigi);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--color-neutral);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chart-container-horizontal {
        position: relative;
        height: 600px;
        padding-bottom: 10px;
    }

    .chart-container-medium {
        position: relative;
        height: 280px;
        padding-bottom: 10px;
    }

    .categorygroup-header {
        padding: 15px 20px;
        color: white;
        border-radius: 5px 5px 0 0;
        margin-bottom: 0;
        position: sticky;
        top: 56px;
        z-index: 1010;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Prevent horizontal overflow */
    body {
        overflow-x: hidden;
    }

    .container-fluid {
        overflow-x: hidden;
    }

    .stat-box {
        background: #f8f9fa;
        border-left: 4px solid;
        padding: 12px 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .person-filter-wrapper {
        position: static;
        z-index: 1020;
    }

    .person-filter-card {
        background: transparent;
        border-radius: 12px;
        padding: 0;
        box-shadow: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .person-filter-card label {
        margin-bottom: 0;
    }

    .person-filter-card select {
        min-width: 160px;
    }

    @media (max-width: 576px) {
        .stat-box {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 12px;
            margin-bottom: 15px;
        }

        .stat-box h6 {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .stat-box h3 {
            font-size: 1.3rem;
        }

        .stat-box .row {
            width: 100%;
        }

        .person-filter-wrapper {
            position: fixed;
            top: 78px;
            right: 16px;
            width: auto;
            z-index: 1030;
        }

        .person-filter-card {
            flex-direction: column;
            align-items: flex-start;
            background: rgba(255, 255, 255, 0.98);
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(8px);
            border-radius: 8px;
        }

        .person-filter-card label {
            font-size: 0.7rem;
        }

        .person-filter-card select {
            min-width: 120px;
            font-size: 0.85rem;
        }

    }

    /* Bereichs-Hintergründe */
    .section-bg-overview {
        background: linear-gradient(to bottom, rgba(91, 155, 213, 0.03) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-supermarkt {
        background: linear-gradient(to bottom, rgba(52, 168, 83, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-haushalt {
        background: linear-gradient(to bottom, rgba(91, 155, 213, 0.04) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-wohnung {
        background: linear-gradient(to bottom, rgba(237, 125, 49, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-restaurant {
        background: linear-gradient(to bottom, rgba(132, 151, 176, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-gesundheit {
        background: linear-gradient(to bottom, rgba(255, 192, 0, 0.06) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-freizeit {
        background: linear-gradient(to bottom, rgba(112, 173, 71, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-geschenke {
        background: linear-gradient(to bottom, rgba(68, 114, 196, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-kfz {
        background: linear-gradient(to bottom, rgba(255, 0, 102, 0.05) 0%, rgba(255,255,255,0) 100%);
    }
    
    .section-bg-urlaube {
        background: linear-gradient(to bottom, rgba(155, 89, 182, 0.05) 0%, rgba(255,255,255,0) 100%);
    }
    
    .section-wrapper {
        padding: 30px 0;
        margin-left: -15px;
        margin-right: -15px;
        padding-left: 15px;
        padding-right: 15px;
        margin-bottom: 20px;
    }


    /* Mobile: Kompaktere Chart-Höhen */
    @media (max-width: 768px) {
        .chart-container-horizontal {
            height: 400px !important;
            padding-bottom: 10px;
        }

        .chart-container-medium {
            height: 250px !important;
        }

        /* Tortendiagramme: Reduziere Canvas-Höhe */
        #categoryPieChart2025,
        #categoryPieChart2024 {
            max-height: 280px !important;
        }

        /* Kompaktere Card-Padding auf Tablet */
        .card-body {
            padding: 1rem;
        }
    }

    /* Extra kleine Geräte: Weitere Optimierung */
    @media (max-width: 576px) {
        .chart-container-horizontal {
            height: 350px !important;
            padding-bottom: 10px;
        }

        .chart-container-medium {
            height: 220px !important;
        }

        #categoryPieChart2025,
        #categoryPieChart2024 {
            max-height: 250px !important;
        }

        /* Kompaktere Card-Header */
        .card-header h5 {
            font-size: 0.9rem;
        }

        .card-header small {
            font-size: 0.75rem;
        }

        .card-header h4 {
            font-size: 1rem;
        }

        /* Kompaktere Card-Padding auf Mobile */
        .card-body {
            padding: 0.75rem;
        }

        .section-wrapper {
            padding: 20px 0;
            margin-bottom: 15px;
        }
    }
    
    @media (min-width: 768px) {
        .section-wrapper {
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            padding-left: calc(50vw - 50% + 15px);
            padding-right: calc(50vw - 50% + 15px);
        }
    }
    
    /* Floating Navigation Button */
    .floating-nav-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        min-width: 56px;
        min-height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        cursor: pointer;
        z-index: 1050;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        -webkit-tap-highlight-color: transparent;
    }

    .floating-nav-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
    }

    .floating-nav-btn:active {
        transform: scale(0.95);
    }

    .floating-nav-btn.show {
        display: flex;
        animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
        from {
            transform: translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Navigation Overlay */
    .nav-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 1100;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .nav-overlay.show {
        display: block;
        opacity: 1;
    }

    /* Navigation Menu */
    .nav-menu {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        z-index: 1200;
        max-height: 70vh;
        overflow-y: auto;
        transition: bottom 0.3s ease;
        padding: 20px;
    }

    .nav-menu.show {
        bottom: 0;
    }

    .nav-menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .nav-menu-header h5 {
        margin: 0;
        color: #333;
    }

    .nav-close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-menu-item {
        display: flex;
        align-items: center;
        padding: 16px;
        min-height: 56px;
        margin-bottom: 8px;
        border-radius: 12px;
        background: #f8f9fa;
        border-left: 4px solid;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        color: #333;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }

    .nav-menu-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .nav-menu-item:active {
        background: #dee2e6;
        transform: translateX(3px);
    }

    .nav-menu-item i {
        font-size: 22px;
        margin-right: 14px;
        width: 28px;
        text-align: center;
        flex-shrink: 0;
    }

    .nav-menu-item span {
        font-weight: 500;
        font-size: 0.95rem;
    }

    /* Desktop: Button verstecken */
    @media (min-width: 992px) {
        .floating-nav-btn {
            display: none !important;
        }
    }

    /* Better touch targets for interactive elements */
    .form-select,
    .btn {
        min-height: 38px;
        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 576px) {
        .form-select,
        .btn {
            min-height: 44px;
            font-size: 0.9rem;
        }

        .btn-sm {
            min-height: 36px;
            padding: 0.4rem 0.8rem;
        }
    }

    /* Loading skeleton animation */
    @keyframes skeleton-loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    .skeleton {
        background: linear-gradient(
            90deg,
            #f0f0f0 25%,
            #e0e0e0 50%,
            #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
        border-radius: 4px;
    }

    .skeleton-text {
        height: 1.2rem;
        margin-bottom: 0.5rem;
    }

    .skeleton-heading {
        height: 2rem;
        margin-bottom: 1rem;
    }

    /* Smooth transitions for all cards */
    .card {
        transition: box-shadow 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Better scrolling behavior */
    html {
        scroll-behavior: smooth;
    }

    /* Dark Mode Styles */
    [data-theme="dark"] {
        --color-card-bg: #1e1e1e;
        --color-card-border: #343a40;
        background-color: #121212;
        color: #e0e0e0;
    }

    [data-theme="dark"] body {
        background-color: #121212;
        color: #e0e0e0;
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .kpi-card,
    [data-theme="dark"] .drilldown-card,
    [data-theme="dark"] .filter-panel-card {
        background-color: #1e1e1e;
        color: #e0e0e0;
        border-color: #343a40;
    }

    [data-theme="dark"] .table {
        color: #e0e0e0;
    }

    [data-theme="dark"] .table-light {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }

    [data-theme="dark"] .text-muted {
        color: #9e9e9e !important;
    }

    [data-theme="dark"] .card-header.bg-white {
        background-color: #2a2a2a !important;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
        position: relative;
        width: 50px;
        height: 26px;
        background-color: #ccc;
        border-radius: 13px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .dark-mode-toggle.active {
        background-color: var(--color-sigi);
    }

    .dark-mode-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 22px;
        height: 22px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
    }

    .dark-mode-toggle.active::after {
        transform: translateX(24px);
    }

    /* Breadcrumbs */
    .breadcrumb-custom {
        background: transparent;
        padding: 0.5rem 0;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .breadcrumb-custom .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: var(--color-neutral);
    }

    .breadcrumb-custom a {
        color: var(--color-sigi);
        text-decoration: none;
    }

    .breadcrumb-custom a:hover {
        text-decoration: underline;
    }

    .breadcrumb-custom .active {
        color: #6c757d;
    }

    /* Improve page header spacing on mobile */
    @media (max-width: 576px) {
        .container-fluid > .d-flex:first-of-type {
            margin-bottom: 1rem !important;
        }

        .container-fluid > .d-flex h1 {
            font-size: 1.5rem;
        }

        .container-fluid > .d-flex p {
            font-size: 0.85rem;
        }
    }
</style>

<div class="container-fluid">
    <!-- Breadcrumbs (PHASE 5) -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-custom">
            <li class="breadcrumb-item"><a href="{% url 'finance:dashboard' %}"><i class="bi bi-house-door"></i> Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Haushalt</li>
        </ol>
    </nav>

    <!-- Modernisierter Header -->
    <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
        <div class="flex-grow-1">
            <h1 class="h3 mb-2">
                <i class="bi bi-house-door"></i> Dashboard Haushalt
            </h1>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3"></i> {{ current_month }}
                </p>
                <!-- Filter Chips -->
                <div class="filter-chips-container mb-0" id="filterChipsContainer">
                    <div class="filter-chip filter-chip-person-{{ current_person }}" id="personFilterChip" style="display: none;">
                        <span id="personFilterChipLabel"></span>
                        <i class="bi bi-x filter-chip-remove" onclick="clearPersonFilter()"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <!-- Dark Mode Toggle -->
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-sun-fill text-warning"></i>
                <div class="dark-mode-toggle" id="darkModeToggle" role="switch" aria-checked="false" aria-label="Dark Mode umschalten" tabindex="0"></div>
                <i class="bi bi-moon-fill text-primary"></i>
            </div>

            <div class="person-filter-wrapper">
                <div class="person-filter-card">
                    <label for="personFilter" class="form-label mb-0 text-muted small">Person</label>
                    <select id="personFilter" class="form-select form-select-sm" aria-label="Person Filter">
                        {% for option in person_options %}
                            <option value="{{ option.value }}" {% if option.value == current_person %}selected{% endif %}>{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <a href="{% url 'finance:add_transaction' %}" class="btn btn-primary" aria-label="Neue Transaktion hinzufügen">
                <i class="bi bi-plus-circle"></i> Neue Transaktion
            </a>
        </div>
    </div>

    <!-- KPI Karten Bereich -->
    <div class="row g-3 mb-4">
        <!-- KPI 1: Ausgaben aktueller Monat -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-title">
                    <i class="bi bi-wallet2"></i>
                    <span>Ausgaben Aktueller Monat</span>
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                       title="Netto-Ausgaben (Ausgaben minus Einnahmen) für {{ current_month }}"></i>
                </div>
                <div class="kpi-card-value">
                    {{ current_month_spending|floatformat:2 }} €
                </div>
                <div class="kpi-card-comparison">
                    {% if mom_change_percent > 0 %}
                        <span class="trend-badge trend-negative">
                            <i class="bi bi-arrow-up"></i>
                            {{ mom_change_percent|floatformat:1 }}%
                        </span>
                    {% elif mom_change_percent < 0 %}
                        <span class="trend-badge trend-positive">
                            <i class="bi bi-arrow-down"></i>
                            {{ mom_change_percent|floatformat:1|slice:"1:" }}%
                        </span>
                    {% else %}
                        <span class="trend-badge trend-neutral">
                            <i class="bi bi-dash"></i>
                            0%
                        </span>
                    {% endif %}
                    <span class="text-muted">vs. Vormonat</span>
                </div>
            </div>
        </div>

        <!-- KPI 2: Vorjahresvergleich -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-title">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Vorjahresvergleich</span>
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                       title="Vergleich zum gleichen Monat im Vorjahr"></i>
                </div>
                <div class="kpi-card-value">
                    {% if yoy_change >= 0 %}+{% endif %}{{ yoy_change|floatformat:2 }} €
                </div>
                <div class="kpi-card-comparison">
                    {% if yoy_change_percent > 0 %}
                        <span class="trend-badge trend-negative">
                            <i class="bi bi-arrow-up"></i>
                            {{ yoy_change_percent|floatformat:1 }}%
                        </span>
                    {% elif yoy_change_percent < 0 %}
                        <span class="trend-badge trend-positive">
                            <i class="bi bi-arrow-down"></i>
                            {{ yoy_change_percent|floatformat:1|slice:"1:" }}%
                        </span>
                    {% else %}
                        <span class="trend-badge trend-neutral">
                            <i class="bi bi-dash"></i>
                            0%
                        </span>
                    {% endif %}
                    <span class="text-muted">YoY</span>
                </div>
            </div>
        </div>

        <!-- KPI 3: Durchschnitt pro Monat -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="kpi-card">
                <div class="kpi-card-title">
                    <i class="bi bi-calculator"></i>
                    <span>Durchschnitt pro Monat</span>
                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"
                       title="Durchschnittliche Ausgaben pro Monat in {{ current_year }}"></i>
                </div>
                <div class="kpi-card-value">
                    {{ avg_monthly_spending|floatformat:2 }} €
                </div>
                <div class="kpi-card-comparison">
                    <span class="text-muted">Ø {{ current_year }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Drilldown Startpunkte -->
    <div class="row g-3 mb-4">
        <!-- Top 5 Kategorien -->
        <div class="col-12 col-md-4">
            <div class="drilldown-card" onclick="scrollToElement('#section-pie-charts')">
                <div class="drilldown-card-title">
                    <i class="bi bi-bar-chart-fill"></i>
                    <span>Top 5 Kategorien</span>
                </div>
                {% for category in top_categories|slice:":5" %}
                    <div class="drilldown-list-item">
                        <span>{{ category.name }}</span>
                        <strong>{{ category.amount|floatformat:2 }} €</strong>
                    </div>
                {% empty %}
                    <p class="text-muted mb-0">Keine Daten verfügbar</p>
                {% endfor %}
                <div class="text-end mt-2">
                    <small class="text-primary">
                        <i class="bi bi-arrow-right"></i> Details anzeigen
                    </small>
                </div>
            </div>
        </div>

        <!-- Auffällige Transaktionen -->
        <div class="col-12 col-md-4">
            <div class="drilldown-card">
                <div class="drilldown-card-title">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Auffällige Transaktionen</span>
                </div>
                {% for trans in notable_transactions|slice:":5" %}
                    <div class="drilldown-list-item">
                        <div class="d-flex flex-column">
                            <span>{{ trans.payee }}</span>
                            <small class="text-muted">{{ trans.date }} •
                                <span class="person-badge person-badge-{{ trans.person|lower }}">
                                    {{ trans.person }}
                                </span>
                            </small>
                        </div>
                        <strong style="color: {% if trans.amount > 0 %}var(--color-negative){% else %}var(--color-positive){% endif %}">
                            {{ trans.amount|floatformat:2 }} €
                        </strong>
                    </div>
                {% empty %}
                    <p class="text-muted mb-0">Keine auffälligen Transaktionen</p>
                {% endfor %}
                <div class="text-end mt-2">
                    <small class="text-muted">
                        Transaktionen > 200€
                    </small>
                </div>
            </div>
        </div>

        <!-- Geplante Transaktionen Link -->
        <div class="col-12 col-md-4">
            <div class="drilldown-card" onclick="window.location.href='{% url 'finance:scheduled_transactions' %}'">
                <div class="drilldown-card-title">
                    <i class="bi bi-clock-history"></i>
                    <span>Geplante Transaktionen</span>
                </div>
                <div class="text-center py-4">
                    <i class="bi bi-calendar-check" style="font-size: 3rem; color: var(--color-sigi);"></i>
                    <p class="mt-3 mb-0">Wiederkehrende und geplante Zahlungen verwalten</p>
                </div>
                <div class="text-end mt-2">
                    <small class="text-primary">
                        <i class="bi bi-arrow-right"></i> Zur Übersicht
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Erweitertes Filterpanel -->
    <div class="card mb-4 filter-panel-card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-funnel"></i>
                <h5 class="mb-0">Filter</h5>
                <span class="badge bg-primary" id="activeFiltersCount" style="display: none;">0</span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn" onclick="resetAllFilters()">
                    <i class="bi bi-arrow-counterclockwise"></i> Zurücksetzen
                </button>
                <button class="btn btn-sm btn-outline-primary" id="saveFavoriteBtn" onclick="saveFilterFavorite()">
                    <i class="bi bi-star"></i> Als Favorit speichern
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Basis-Filter -->
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-3">
                    <label for="filterYear" class="form-label small text-muted">Jahr</label>
                    <select id="filterYear" class="form-select form-select-sm">
                        <option value="">Alle Jahre</option>
                        {% for y in available_years %}
                            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label for="filterMonth" class="form-label small text-muted">Monat</label>
                    <select id="filterMonth" class="form-select form-select-sm">
                        <option value="">Alle Monate</option>
                        <option value="1">Januar</option>
                        <option value="2">Februar</option>
                        <option value="3">März</option>
                        <option value="4">April</option>
                        <option value="5">Mai</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Dezember</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label for="filterPersonAdvanced" class="form-label small text-muted">Person</label>
                    <select id="filterPersonAdvanced" class="form-select form-select-sm">
                        <option value="">Alle Personen</option>
                        <option value="sigi">Sigi</option>
                        <option value="robert">Robert</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label small text-muted d-block">&nbsp;</label>
                    <button class="btn btn-sm btn-primary w-100" id="applyBasicFiltersBtn" onclick="applyFilters()">
                        <i class="bi bi-check-circle"></i> Filter anwenden
                    </button>
                </div>
            </div>

            <!-- Erweiterte Filter (Collapsible) -->
            <div class="accordion" id="advancedFiltersAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="advancedFiltersHeader">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#advancedFiltersCollapse" aria-expanded="false"
                                aria-controls="advancedFiltersCollapse">
                            <i class="bi bi-sliders me-2"></i>
                            Erweiterte Filter
                        </button>
                    </h2>
                    <div id="advancedFiltersCollapse" class="accordion-collapse collapse"
                         aria-labelledby="advancedFiltersHeader" data-bs-parent="#advancedFiltersAccordion">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <!-- Konto Filter -->
                                <div class="col-12 col-md-4">
                                    <label for="filterAccount" class="form-label small text-muted">Konto</label>
                                    <select id="filterAccount" class="form-select form-select-sm" multiple size="4">
                                        <option value="">Lade Konten...</option>
                                    </select>
                                    <small class="text-muted">Mehrfachauswahl mit Strg/Cmd</small>
                                </div>

                                <!-- Kategorie Filter (Multi-Select) -->
                                <div class="col-12 col-md-4">
                                    <label for="filterCategory" class="form-label small text-muted">Kategorie</label>
                                    <select id="filterCategory" class="form-select form-select-sm" multiple size="4">
                                        <option value="">Lade Kategorien...</option>
                                    </select>
                                    <small class="text-muted">Mehrfachauswahl mit Strg/Cmd</small>
                                </div>

                                <!-- Suche -->
                                <div class="col-12 col-md-4">
                                    <label for="filterSearch" class="form-label small text-muted">Suche (Payee/Memo)</label>
                                    <input type="text" id="filterSearch" class="form-control form-control-sm"
                                           placeholder="Suchbegriff eingeben...">
                                    <small class="text-muted" id="searchResultsCount"></small>
                                </div>

                                <!-- Betragsbereiche -->
                                <div class="col-12 col-md-6">
                                    <label for="filterAmountMin" class="form-label small text-muted">Mindestbetrag (€)</label>
                                    <input type="number" id="filterAmountMin" class="form-control form-control-sm"
                                           placeholder="0.00" step="0.01">
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="filterAmountMax" class="form-label small text-muted">Höchstbetrag (€)</label>
                                    <input type="number" id="filterAmountMax" class="form-control form-control-sm"
                                           placeholder="999999.99" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Chips Feedback -->
            <div class="mt-3" id="appliedFiltersChipsContainer" style="display: none;">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <small class="text-muted fw-bold">Aktive Filter:</small>
                    <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="clearAllFilterChips()">
                        <small>Alle entfernen</small>
                    </button>
                </div>
                <div class="filter-chips-container" id="appliedFiltersChips">
                    <!-- Filter chips werden hier dynamisch eingefügt -->
                </div>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>Hinweis:</strong>
        Dieses Dashboard zeigt alle Transaktionen von Robert sowie nur Sigis Transaktionen mit Flag "Relevant für Haushaltsbudget" (flag_id=5).
        Transfers und Kursschwankungen sind ausgeschlossen.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Transaktions-Tabelle -->
    <div class="card mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> Transaktionen
                </h5>
                <small class="text-muted" id="transactionsCountText">Lade Transaktionen...</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="exportTransactions('csv')">
                    <i class="bi bi-download"></i> CSV Export
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Desktop Tabelle -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover table-striped mb-0" id="transactionsTable">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Datum</th>
                            <th>Payee</th>
                            <th>Konto</th>
                            <th>Kategorie</th>
                            <th>Person</th>
                            <th>Memo</th>
                            <th class="text-end">Ausgaben</th>
                            <th class="text-end">Einnahmen</th>
                            <th class="text-end sticky-actions">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Laden...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="table-light">
                        <tr class="fw-bold">
                            <td colspan="6" class="text-end">Summen:</td>
                            <td class="text-end" id="totalOutflow">0,00 €</td>
                            <td class="text-end" id="totalInflow">0,00 €</td>
                            <td class="text-end">Netto: <span id="totalNetto">0,00 €</span></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="d-md-none" id="transactionsMobileCards">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laden...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted" id="paginationInfo">Seite 1 von 1</span>
            </div>
            <div>
                <button class="btn btn-sm btn-primary" id="loadMoreBtn" onclick="loadMoreTransactions()" style="display: none;">
                    <i class="bi bi-arrow-down-circle"></i> Weitere laden
                </button>
            </div>
        </div>
    </div>

    <!-- Gestapeltes Balkendiagramm -->
    <div class="section-wrapper section-bg-overview">
        <div class="row mb-4" id="section-overview">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-fill"></i> Monatliche Ausgaben (Netto)
                        </h5>
                        <small>Gestapelt nach Person</small>
                    </div>
                    <div>
                        <select id="barChartYearSelect" class="form-select form-select-sm">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container-horizontal">
                        <canvas id="monthlyStackedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Tortendiagramme MIT DRILLDOWN -->
    <div class="section-wrapper section-bg-overview">
        <div class="row mb-5" id="section-pie-charts">
            <!-- 2025 Pie Chart -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" id="pieChartHeader2025">
                        <h5 class="mb-0" id="pieChartTitle2025">
                            <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2025
                        </h5>
                        <!-- ⚠️ ZURÜCK-BUTTON HIER -->
                        <button id="backBtn2025" class="btn btn-sm btn-outline-light" style="display: none;" onclick="backToOverview(2025, 'categoryPieChart2025', '2025')">
                            <i class="bi bi-arrow-left"></i> Zurück
                        </button>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryPieChart2025" height="250"></canvas>
                        <div class="mt-2 text-muted small text-center" id="drilldownHint2025">
                            <i class="bi bi-info-circle"></i> Klicke auf eine Kategorie für Details
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- 2024 Pie Chart -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" id="pieChartHeader2024">
                        <h5 class="mb-0" id="pieChartTitle2024">
                            <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2024
                        </h5>
                        <!-- ⚠️ ZURÜCK-BUTTON HIER -->
                        <button id="backBtn2024" class="btn btn-sm btn-outline-light" style="display: none;" onclick="backToOverview(2024, 'categoryPieChart2024', '2024')">
                            <i class="bi bi-arrow-left"></i> Zurück
                        </button>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryPieChart2024" height="250"></canvas>
                        <div class="mt-2 text-muted small text-center" id="drilldownHint2024">
                            <i class="bi bi-info-circle"></i> Klicke auf eine Kategorie für Details
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- ===== SPECIAL SECTION: SUPERMARKT (Kategorie 1.4. id=5) ===== -->
    <div class="section-wrapper section-bg-supermarkt">
        <div class="row mb-5" id="section-supermarkt">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(52, 168, 83);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> 1.4. Supermarkt - Detailanalyse
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Statistiken -->
                    <div class="stat-box" style="border-left-color: rgb(52, 168, 83);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-supermarket">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <!-- Monatliche Entwicklung mit Trendlinie -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Jahresvergleich 2024 vs 2025 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- SPECIAL: Kombiniertes Billa-Diagramm -->
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-bag-check"></i> Billa-Einkäufe: Anzahl & Durchschnittliche Höhe</h5>
                            <p class="text-muted">
                                <small>Balken zeigen die Anzahl der Einkäufe, Linie zeigt die durchschnittliche Einkaufshöhe pro Monat</small>
                            </p>
                            <div class="chart-container-medium">
                                <canvas id="billaCombinedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- ===== END SUPERMARKT SECTION ===== -->

    <!-- 1. Haushaltsausgaben -->
    <div class="section-wrapper section-bg-haushalt">
        <div class="row mb-5" id="section-haushalt">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(91, 155, 213);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> Haushaltsausgaben
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(91, 155, 213);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-2">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 2. Wohnung -->
    <div class="section-wrapper section-bg-wohnung">
        <div class="row mb-5" id="section-wohnung">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(237, 125, 49);">
                    <h4 class="mb-0">
                        <i class="bi bi-house"></i> Wohnung
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(237, 125, 49);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-3">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart3"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart3"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart3"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 3. Restaurant & Lieferservice -->
    <div class="section-wrapper section-bg-restaurant">
        <div class="row mb-5" id="section-restaurant">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(132, 151, 176);">
                    <h4 class="mb-0">
                        <i class="bi bi-cup-straw"></i> Restaurant & Lieferservice
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(132, 151, 176);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-4">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart4"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart4"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart4"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 4. Ärzte & Gesundheit -->
    <div class="section-wrapper section-bg-gesundheit">
        <div class="row mb-5" id="section-gesundheit">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 192, 0);">
                    <h4 class="mb-0">
                        <i class="bi bi-heart-pulse"></i> Ärzte & Gesundheit
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 192, 0);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-5">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart5"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart5"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart5"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 5. Freizeit & Hobby & Urlaub -->
    <div class="section-wrapper section-bg-freizeit">
        <div class="row mb-5" id="section-freizeit">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(112, 173, 71);">
                    <h4 class="mb-0">
                        <i class="bi bi-balloon"></i> Freizeit & Hobby & Urlaub
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(112, 173, 71);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-6">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart6"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart6"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart6"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 6. Geschenke -->
    <div class="section-wrapper section-bg-geschenke">
        <div class="row mb-5" id="section-geschenke">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(68, 114, 196);">
                    <h4 class="mb-0">
                        <i class="bi bi-gift"></i> Geschenke
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(68, 114, 196);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-7">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart7"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart7"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart7"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 9. KFZ -->
    <div class="section-wrapper section-bg-kfz">
        <div class="row mb-5" id="section-kfz">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 0, 102);">
                    <h4 class="mb-0">
                        <i class="bi bi-car-front"></i> KFZ
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 0, 102);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-10">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart10"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart10"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart10"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- 10. Urlaube -->
    <div class="section-wrapper section-bg-urlaube">
        <div class="row mb-5" id="section-urlaube">
            <div class="col-12">
                <div class="card">
                    <div class="categorygroup-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h4 class="mb-0">
                            <i class="bi bi-airplane"></i> Urlaube & Reisen
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Statistiken -->
                        <div class="stat-box" style="border-left-color: rgb(102, 126, 234);">
                            <div class="row">
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <h6 class="text-muted mb-1">Gesamtausgaben</h6>
                                    <h3 class="mb-0" id="urlaube-gesamt">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <h6 class="text-muted mb-1">Anzahl Urlaube</h6>
                                    <h3 class="mb-0" id="urlaube-anzahl">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-1">Durchschnitt pro Urlaub</h6>
                                    <h3 class="mb-0" id="urlaube-durchschnitt">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                            </div>
                        </div>
    
                        <!-- Urlaubs-Chart -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5><i class="bi bi-bar-chart-fill"></i> Urlaubsausgaben nach Person</h5>
                                <p class="text-muted mb-3">
                                    <small>Gestapelte Darstellung der Kostenaufteilung zwischen Robert und Sigi</small>
                                </p>
                                <div class="chart-container-horizontal">
                                    <canvas id="urlaubeChart"></canvas>
                                </div>
                            </div>
                        </div>
    
                        <!-- Jahresvergleich -->
                        <div class="row">
                            <div class="col-md-6 mb-4 mb-md-0">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-2">
                                            <i class="bi bi-calendar3"></i> Jahr 2024
                                        </h6>
                                        <h4 class="mb-1" id="urlaube-2024-gesamt">-</h4>
                                        <small class="text-muted" id="urlaube-2024-anzahl">-</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-2">
                                            <i class="bi bi-calendar3"></i> Jahr 2025
                                        </h6>
                                        <h4 class="mb-1" id="urlaube-2025-gesamt">-</h4>
                                        <small class="text-muted" id="urlaube-2025-anzahl">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. Betriebskosten -->
    <div class="section-wrapper section-bg-betriebskosten">
        <div class="row mb-5" id="section-betriebskosten">
            <div class="col-12">
                <div class="card">
                    <div class="categorygroup-header" style="background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);">
                        <h4 class="mb-0">
                            <i class="bi bi-building"></i> Betriebskosten Entwicklung
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Statistiken -->
                        <div class="stat-box" style="border-left-color: rgb(74, 144, 226);">
                            <div class="row">
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <h6 class="text-muted mb-1">Aktuelle Betriebskosten (2025.07)</h6>
                                    <h3 class="mb-0" id="betriebskosten-aktuell">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <h6 class="text-muted mb-1">Durchschnitt pro Periode</h6>
                                    <h3 class="mb-0" id="betriebskosten-durchschnitt">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-1">Steigerung 2022 → 2025</h6>
                                    <h3 class="mb-0" id="betriebskosten-steigerung">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    </h3>
                                </div>
                            </div>
                        </div>
    
                        <!-- Chart -->
                        <div class="row">
                            <div class="col-12">
                                <h5><i class="bi bi-bar-chart-fill"></i> Entwicklung nach Kostenart</h5>
                                <p class="text-muted mb-3">
                                    <small>Gestapelte Darstellung der Betriebskosten (Brutto) über die Zeit</small>
                                </p>
                                <div class="chart-container-horizontal">
                                    <canvas id="betriebskostenChart"></canvas>
                                </div>
                            </div>
                        </div>
    
                        <!-- Tabelle unter Chart -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover" id="betriebskostenTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Periode</th>
                                                <th class="text-end">Reparaturrücklage</th>
                                                <th class="text-end">Wohnkosten</th>
                                                <th class="text-end">Heizkosten & Warmwasser</th>
                                                <th class="text-end">Wohnkosten Wasser</th>
                                                <th class="text-end"><strong>Gesamt</strong></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Wird dynamisch gefüllt -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Link zur Transaktionsliste -->
    <div class="row">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="bi bi-list-ul"></i> Detaillierte Transaktionsansicht
                    </h5>
                    <p class="card-text text-muted">
                        Für eine detaillierte Übersicht aller Haushalt-Transaktionen mit Filtermöglichkeiten.
                    </p>
                    <a href="{% url 'finance:household_transactions' %}" class="btn btn-primary">
                        <i class="bi bi-arrow-right-circle"></i> Zu den Transaktionen
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Navigation Button (nur Mobile) -->
    <button class="floating-nav-btn" id="floatingNavBtn" aria-label="Navigation öffnen">
        <i class="bi bi-list"></i>
    </button>

    <!-- Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- Navigation Menu -->
    <div class="nav-menu" id="navMenu">
        <div class="nav-menu-header">
            <h5><i class="bi bi-compass"></i> Navigation</h5>
            <button class="nav-close-btn" id="navCloseBtn" aria-label="Menü schließen">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <a href="#section-overview" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-overview">
            <i class="bi bi-bar-chart-fill" style="color: rgb(91, 155, 213);"></i>
            <span>Übersicht Monatlich</span>
        </a>

        <a href="#section-pie-charts" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-pie-charts">
            <i class="bi bi-pie-chart-fill" style="color: rgb(91, 155, 213);"></i>
            <span>Kategorien 2024/2025</span>
        </a>

        <a href="#section-supermarkt" class="nav-menu-item" style="border-left-color: rgb(52, 168, 83);" data-section="section-supermarkt">
            <i class="bi bi-cart" style="color: rgb(52, 168, 83);"></i>
            <span>Supermarkt</span>
        </a>

        <a href="#section-haushalt" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-haushalt">
            <i class="bi bi-cart" style="color: rgb(91, 155, 213);"></i>
            <span>Haushaltsausgaben</span>
        </a>

        <a href="#section-wohnung" class="nav-menu-item" style="border-left-color: rgb(237, 125, 49);" data-section="section-wohnung">
            <i class="bi bi-house" style="color: rgb(237, 125, 49);"></i>
            <span>Wohnung</span>
        </a>

        <a href="#section-restaurant" class="nav-menu-item" style="border-left-color: rgb(132, 151, 176);" data-section="section-restaurant">
            <i class="bi bi-cup-straw" style="color: rgb(132, 151, 176);"></i>
            <span>Restaurant & Lieferservice</span>
        </a>

        <a href="#section-gesundheit" class="nav-menu-item" style="border-left-color: rgb(255, 192, 0);" data-section="section-gesundheit">
            <i class="bi bi-heart-pulse" style="color: rgb(255, 192, 0);"></i>
            <span>Ärzte & Gesundheit</span>
        </a>

        <a href="#section-freizeit" class="nav-menu-item" style="border-left-color: rgb(112, 173, 71);" data-section="section-freizeit">
            <i class="bi bi-balloon" style="color: rgb(112, 173, 71);"></i>
            <span>Freizeit & Hobby & Urlaub</span>
        </a>

        <a href="#section-geschenke" class="nav-menu-item" style="border-left-color: rgb(68, 114, 196);" data-section="section-geschenke">
            <i class="bi bi-gift" style="color: rgb(68, 114, 196);"></i>
            <span>Geschenke</span>
        </a>

        <a href="#section-kfz" class="nav-menu-item" style="border-left-color: rgb(255, 0, 102);" data-section="section-kfz">
            <i class="bi bi-car-front" style="color: rgb(255, 0, 102);"></i>
            <span>KFZ</span>
        </a>
    
        <a href="#section-urlaube" class="nav-menu-item" style="border-left-color: rgb(102, 126, 234);" data-section="section-urlaube">
            <i class="bi bi-airplane" style="color: rgb(102, 126, 234);"></i>
            <span>Urlaube & Reisen</span>
        </a>
        <a href="#section-betriebskosten" class="nav-menu-item" style="border-left-color: rgb(74, 144, 226);" data-section="section-betriebskosten">
            <i class="bi bi-building" style="color: rgb(74, 144, 226);"></i>
            <span>Betriebskosten</span>
        </a>
    </div>

    <!-- Transaction Details Offcanvas (PHASE 4) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="transactionDetailsOffcanvas" aria-labelledby="transactionDetailsOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="transactionDetailsOffcanvasLabel">
                <i class="bi bi-receipt"></i> Transaktions-Details
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="transactionDetailsContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laden...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payee History Offcanvas (PHASE 4) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="payeeHistoryOffcanvas" aria-labelledby="payeeHistoryOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="payeeHistoryOffcanvasLabel">
                <i class="bi bi-person-badge"></i> <span id="payeeHistoryName">Payee</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="payeeHistoryContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laden...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Analysis Offcanvas (PHASE 4) -->
    <div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="categoryAnalysisOffcanvas" aria-labelledby="categoryAnalysisOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="categoryAnalysisOffcanvasLabel">
                <i class="bi bi-bar-chart-line"></i> <span id="categoryAnalysisName">Kategorie</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="categoryAnalysisContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Laden...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
// ===== BESTEHENDE CHART-VARIABLEN UND FUNKTIONEN =====
let monthlyChart = null;
let pieChart2025 = null;
let pieChart2024 = null;

let drilldownState2025 = {
    level: 'overview',
    categorygroupName: null,
    categorygroupId: null  // ⚠️ NEU
};

let drilldownState2024 = {
    level: 'overview',
    categorygroupName: null,
    categorygroupId: null  // ⚠️ NEU
};

let sharedDrilldownState = {
    level: 'overview',
    categorygroupName: null,
    categorygroupId: null
};

let currentPerson = '{{ current_person }}';
const defaultYear = {{ current_year }};
const categoryTrendCharts = {};
const categoryComparisonCharts = {};
const categoryQuarterlyCharts = {};
let supermarketTrendChartInstance = null;
let supermarketComparisonChartInstance = null;
let billaCombinedChartInstance = null;
let urlaubeChartInstance = null;
let betriebskostenChartInstance = null;

function addPersonToUrl(url) {
    const separator = url.includes('?') ? '&' : '?';
    return `${url}${separator}person=${encodeURIComponent(currentPerson)}`;
}

function resetPieDrilldownState() {
    sharedDrilldownState.level = 'overview';
    sharedDrilldownState.categorygroupName = null;
    sharedDrilldownState.categorygroupId = null;
}

// ============================================================
// Ersetze die loadMonthlyChart Funktion mit dieser optimierten Version:
// ============================================================

function loadMonthlyChart(year) {
    const url = addPersonToUrl(`/api/household-monthly-spending/?year=${year}`);
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('monthlyStackedChart').getContext('2d');

            // Destroy existing chart
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: isMobile ? 5 : 10,
                            right: isMobile ? 5 : 10,
                            bottom: isMobile ? 5 : 10,
                            left: isMobile ? 5 : 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        axis: 'y',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    // Kompaktere Darstellung auf Mobile
                                    if (isMobile) {
                                        return '€' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return '€ ' + value.toLocaleString('de-DE');
                                },
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                autoSkipPadding: isMobile ? 10 : 5
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                                },
                                autoSkip: false,
                                // Kürzere Monatsnamen auf Mobile
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    if (isMobile && label.length > 10) {
                                        // Kürze lange Labels
                                        return label.substring(0, 8) + '..';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 13)
                                },
                                padding: isSmallMobile ? 8 : (isMobile ? 10 : 15),
                                boxWidth: isMobile ? 10 : 15,
                                boxHeight: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': € ' +
                                           context.parsed.x.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           });
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.x;
                                    });
                                    return '━━━━━━━━━━━━━━━━\nGesamt: € ' + sum.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    onHover: (event, elements, chart) => {
                        const canvas = event?.native?.target || event?.target;
                        if (canvas) {
                            canvas.style.cursor = elements.length ? 'pointer' : 'default';
                        }
                    },
                    onClick: (event, elements, chart) => {
                        const points = chart.getElementsAtEventForMode(
                            event,
                            'index',
                            { intersect: false, axis: 'y' },
                            true
                        );

                        if (points.length) {
                            const { x, y } = points[0].element;
                            chart.tooltip.setActiveElements(points, { x, y });
                            chart.setActiveElements(points);
                        } else {
                            chart.tooltip.setActiveElements([], { x: 0, y: 0 });
                            chart.setActiveElements([]);
                        }

                        chart.update();
                    }
                }
            });
        })
        .catch(error => {
            console.error('Fehler beim Laden der monatlichen Daten:', error);
        });
}
// ===== FUNKTION: LADE PIE CHART (MIT DRILLDOWN SUPPORT) =====
// ===== GEMEINSAMER DRILLDOWN STATE (SYNCHRONISIERT) =====


// ===== FUNKTION: LADE PIE CHART (MIT SYNCHRONISIERTEM DRILLDOWN) =====
function loadPieChart(year, canvasId, chartVariable) {
    const isChart2025 = chartVariable === '2025';

    // Baue URL (mit optionalem categorygroup_id Parameter)
    let url = `/api/household-category-breakdown/?year=${year}`;
    if (sharedDrilldownState.level === 'drilldown' && sharedDrilldownState.categorygroupId) {
        url += `&categorygroup_id=${sharedDrilldownState.categorygroupId}`;
    }

    url = addPersonToUrl(url);

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Zerstöre alten Chart
            if (isChart2025 && pieChart2025) {
                pieChart2025.destroy();
            } else if (!isChart2025 && pieChart2024) {
                pieChart2024.destroy();
            }

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            const newChart = new Chart(ctx, {
                type: isMobile ? 'doughnut' : 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: isMobile ? '50%' : '0%',
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'top' : 'bottom',
                            align: 'center',
                            labels: {
                                padding: isMobile ? 6 : 15,
                                font: {
                                    size: isSmallMobile ? 8 : (isMobile ? 9 : 11)
                                },
                                boxWidth: isMobile ? 10 : 15,
                                boxHeight: isMobile ? 10 : 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(0);

                                            let shortLabel = label;
                                            if (isMobile) {
                                                const labelMap = {
                                                    'Haushaltsausgaben': 'Haushalt',
                                                    'Wohnung': 'Wohnung',
                                                    'Restaurant & Lieferservice': 'Restaurant',
                                                    'Ärzte & Gesundheit': 'Gesundheit',
                                                    'Freizeit & Hobby & Urlaub': 'Freizeit',
                                                    'Geschenke': 'Geschenke',
                                                    'KFZ': 'KFZ'
                                                };
                                                shortLabel = labelMap[label] || label;
                                            }

                                            return {
                                                text: `${shortLabel} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i,
                                                lineWidth: 0
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    if (isMobile) {
                                        return `${label}: €${Math.round(value).toLocaleString('de-DE')} (${percentage}%)`;
                                    }
                                    return label + ': € ' +
                                           value.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           }) +
                                           ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 0,
                            bottom: isMobile ? 10 : 0,
                            left: 0,
                            right: isMobile ? 5 : 0
                        }
                    },
                    // ⚠️ WICHTIG: Click-Handler nur auf Overview-Ebene
                    onClick: sharedDrilldownState.level === 'overview' ? function(event, elements, chart) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categorygroupName = chart.data.labels[index];
                            
                            const categoryGroupMapping = {
                                'Haushaltsausgaben': 2,
                                'Wohnung': 3,
                                'Restaurant & Lieferservice': 4,
                                'Ärzte & Gesundheit': 5,
                                'Freizeit & Hobby & Urlaub': 6,
                                'Geschenke': 7,
                                'KFZ': 10
                            };
                            
                            const categorygroupId = categoryGroupMapping[categorygroupName];

                            console.log(`Pie clicked:`, categorygroupName, 'ID:', categorygroupId);
                            // ⚠️ SYNCHRONISIERE BEIDE CHARTS
                            loadPieChartDrilldown(categorygroupName, categorygroupId);
                        }
                    } : null
                }
            });

            // Speichere Chart-Instanz
            if (isChart2025) {
                pieChart2025 = newChart;
            } else {
                pieChart2024 = newChart;
            }

            // Update UI (Titel, Back-Button, Hint)
            updatePieChartUI(year, canvasId, chartVariable);
        })
        .catch(error => {
            console.error(`Fehler beim Laden der Kategoriedaten für ${year}:`, error);
        });
}

// ===== DRILLDOWN: LADE BEIDE CHARTS GLEICHZEITIG =====
function loadPieChartDrilldown(categorygroupName, categorygroupId) {
    // Update GEMEINSAMEN State
    sharedDrilldownState.level = 'drilldown';
    sharedDrilldownState.categorygroupName = categorygroupName;
    sharedDrilldownState.categorygroupId = categorygroupId;

    // ⚠️ LADE BEIDE CHARTS NEU
    loadPieChart(2025, 'categoryPieChart2025', '2025');
    loadPieChart(2024, 'categoryPieChart2024', '2024');
}

// ===== UPDATE UI (TITEL, BACK-BUTTON, HINT) =====
function updatePieChartUI(year, canvasId, chartVariable) {
    const isChart2025 = chartVariable === '2025';
    const titleId = isChart2025 ? 'pieChartTitle2025' : 'pieChartTitle2024';
    const backButtonId = isChart2025 ? 'backBtn2025' : 'backBtn2024';
    const hintId = isChart2025 ? 'drilldownHint2025' : 'drilldownHint2024';

    const titleElement = document.getElementById(titleId);
    const backButton = document.getElementById(backButtonId);
    const hint = document.getElementById(hintId);

    if (!titleElement) return;

    if (sharedDrilldownState.level === 'overview') {
        // Overview-Modus
        titleElement.innerHTML = `<i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie ${year}`;
        if (backButton) backButton.style.display = 'none';
        if (hint) hint.style.display = 'block';
    } else {
        // Drilldown-Modus
        titleElement.innerHTML = `<i class="bi bi-pie-chart-fill"></i> ${sharedDrilldownState.categorygroupName} - ${year}`;
        if (backButton) backButton.style.display = 'inline-block';
        if (hint) hint.style.display = 'none';
    }
}

// ===== BACK TO OVERVIEW (BEIDE CHARTS) =====
function backToOverview(year, canvasId, chartVariable) {
    // Reset GEMEINSAMEN State
    sharedDrilldownState.level = 'overview';
    sharedDrilldownState.categorygroupName = null;
    sharedDrilldownState.categorygroupId = null;

    // ⚠️ LADE BEIDE CHARTS NEU
    loadPieChart(2025, 'categoryPieChart2025', '2025');
    loadPieChart(2024, 'categoryPieChart2024', '2024');
}

// ===== NEUE CATEGORYGROUP CHARTS =====

const categoryGroups = [2, 3, 4, 5, 6, 7, 10];

// Farbschema für jeden Bereich
const groupColors = {
    2: { // Haushaltsausgaben
        primary: 'rgb(91, 155, 213)',
        primaryAlpha: 'rgba(91, 155, 213, 0.7)',
        secondary: 'rgb(91, 155, 213)',
        secondaryAlpha: 'rgba(91, 155, 213, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    3: { // Wohnung
        primary: 'rgb(237, 125, 49)',
        primaryAlpha: 'rgba(237, 125, 49, 0.7)',
        secondary: 'rgb(237, 125, 49)',
        secondaryAlpha: 'rgba(237, 125, 49, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    4: { // Restaurant
        primary: 'rgb(132, 151, 176)',
        primaryAlpha: 'rgba(132, 151, 176, 0.7)',
        secondary: 'rgb(132, 151, 176)',
        secondaryAlpha: 'rgba(132, 151, 176, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    5: { // Gesundheit
        primary: 'rgb(255, 192, 0)',
        primaryAlpha: 'rgba(255, 192, 0, 0.7)',
        secondary: 'rgb(255, 192, 0)',
        secondaryAlpha: 'rgba(255, 192, 0, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    6: { // Freizeit
        primary: 'rgb(112, 173, 71)',
        primaryAlpha: 'rgba(112, 173, 71, 0.7)',
        secondary: 'rgb(112, 173, 71)',
        secondaryAlpha: 'rgba(112, 173, 71, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    7: { // Geschenke
        primary: 'rgb(68, 114, 196)',
        primaryAlpha: 'rgba(68, 114, 196, 0.7)',
        secondary: 'rgb(68, 114, 196)',
        secondaryAlpha: 'rgba(68, 114, 196, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    10: { // KFZ
        primary: 'rgb(255, 0, 102)',
        primaryAlpha: 'rgba(255, 0, 102, 0.7)',
        secondary: 'rgb(255, 0, 102)',
        secondaryAlpha: 'rgba(255, 0, 102, 0.25)',
        trend: 'rgb(255, 99, 132)'
    }
};

function formatEuro(value) {
    return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function loadCategoryGroupStats() {
    categoryGroups.forEach(groupId => {
        fetch(addPersonToUrl(`/api/categorygroup-stats/?group_id=${groupId}`))
            .then(response => response.json())
            .then(data => {
                document.getElementById(`avg-spending-${groupId}`).innerHTML = formatEuro(data.monthly_average);
            })
            .catch(error => {
                console.error(`Error loading stats for group ${groupId}:`, error);
                document.getElementById(`avg-spending-${groupId}`).innerHTML = '<span class="text-danger">Fehler</span>';
            });
    });
}

function createTrendCharts() {
    categoryGroups.forEach(groupId => {
        fetch(addPersonToUrl(`/api/categorygroup-monthly-trend/?group_id=${groupId}`))
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`trendChart${groupId}`).getContext('2d');
                const colors = groupColors[groupId];

                if (categoryTrendCharts[groupId]) {
                    categoryTrendCharts[groupId].destroy();
                }

                categoryTrendCharts[groupId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Ausgaben',
                                data: data.data,
                                borderColor: colors.primary,
                                backgroundColor: colors.primaryAlpha,
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Trend',
                                data: data.trend_data,
                                borderColor: colors.trend,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating trend chart ${groupId}:`, error));
    });
}

function createComparisonCharts() {
    categoryGroups.forEach(groupId => {
        fetch(addPersonToUrl(`/api/categorygroup-year-comparison/?group_id=${groupId}`))
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`comparisonChart${groupId}`).getContext('2d');
                const colors = groupColors[groupId];

                if (categoryComparisonCharts[groupId]) {
                    categoryComparisonCharts[groupId].destroy();
                }

                categoryComparisonCharts[groupId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '2025',
                                data: data.data_2025,
                                backgroundColor: colors.primaryAlpha,
                                borderColor: colors.primary,
                                borderWidth: 1
                            },
                            {
                                label: '2024',
                                data: data.data_2024,
                                backgroundColor: colors.secondaryAlpha,
                                borderColor: colors.secondary,
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating comparison chart ${groupId}:`, error));
    });
}

function createQuarterlyCharts() {
    categoryGroups.forEach(groupId => {
        fetch(addPersonToUrl(`/api/categorygroup-quarterly-breakdown/?group_id=${groupId}`))
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`quarterlyChart${groupId}`).getContext('2d');

                if (categoryQuarterlyCharts[groupId]) {
                    categoryQuarterlyCharts[groupId].destroy();
                }

                categoryQuarterlyCharts[groupId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating quarterly chart ${groupId}:`, error));
    });
}

// ===== SUPERMARKT-BEREICH FUNCTIONS =====

function loadSupermarketStats() {
    fetch(addPersonToUrl('/api/supermarket-stats/'))
        .then(response => response.json())
        .then(data => {
            document.getElementById('avg-spending-supermarket').innerHTML = formatEuro(data.monthly_average);
        })
        .catch(error => {
            console.error('Error loading supermarket stats:', error);
            document.getElementById('avg-spending-supermarket').innerHTML = '<span class="text-danger">Fehler</span>';
        });
}

function createSupermarketTrendChart() {
    fetch(addPersonToUrl('/api/supermarket-monthly-trend/'))
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketTrendChart').getContext('2d');

            if (supermarketTrendChartInstance) {
                supermarketTrendChartInstance.destroy();
            }

            supermarketTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Ausgaben',
                            data: data.data,
                            borderColor: 'rgb(52, 168, 83)',
                            backgroundColor: 'rgba(52, 168, 83, 0.3)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Trend',
                            data: data.trend_data,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatEuro(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket trend chart:', error));
}

function createSupermarketComparisonChart() {
    fetch(addPersonToUrl('/api/supermarket-year-comparison/'))
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketComparisonChart').getContext('2d');

            if (supermarketComparisonChartInstance) {
                supermarketComparisonChartInstance.destroy();
            }

            supermarketComparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatEuro(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket comparison chart:', error));
}

function createBillaCombinedChart() {
    fetch(addPersonToUrl('/api/billa-combined-chart/'))
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('billaCombinedChart').getContext('2d');

            // Mobile Detection
            const isMobile = window.innerWidth < 768;

            if (billaCombinedChartInstance) {
                billaCombinedChartInstance.destroy();
            }

            billaCombinedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: isMobile ? 'Anzahl' : 'Anzahl Einkäufe',
                            data: data.count_data,
                            backgroundColor: 'rgba(52, 168, 83, 0.6)',
                            borderColor: 'rgb(52, 168, 83)',
                            borderWidth: isMobile ? 1 : 1,
                            yAxisID: 'y-count',
                            order: 2
                        },
                        {
                            label: isMobile ? 'Ø Höhe' : 'Durchschnittliche Einkaufshöhe',
                            data: data.avg_data,
                            type: 'line',
                            borderColor: 'rgb(30,122,54)',
                            backgroundColor: 'rgba(52, 168, 83, 0.2)',
                            borderWidth: isMobile ? 2 : 3,
                            pointRadius: isMobile ? 5 : 5,  // Größere Touch-Targets
                            pointHoverRadius: isMobile ? 6 : 7,
                            pointBackgroundColor: 'rgb(52, 168, 83)',
                            tension: 0.4,
                            yAxisID: 'y-avg',
                            order: 1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',  // Legende unten auf Mobile
                            labels: {
                                padding: isMobile ? 10 : 15,
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                boxWidth: isMobile ? 30 : 40
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 12 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 11 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-count') {
                                        label += context.parsed.y + (isMobile ? 'x' : ' Einkäufe');
                                    } else {
                                        label += formatEuro(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxRotation: isMobile ? 45 : 0,  // Drehe Labels auf Mobile
                                minRotation: isMobile ? 45 : 0,
                                autoSkip: true,
                                autoSkipPadding: isMobile ? 20 : 10
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: isMobile ? 10 : 11
                                },
                                callback: function(value) {
                                    return value + 'x';
                                }
                            },
                            title: {
                                display: !isMobile,  // Verberge Titel auf Mobile
                                text: 'Anzahl Einkäufe',
                                font: {
                                    size: isMobile ? 11 : 12
                                }
                            }
                        },
                        'y-avg': {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 10 : 11
                                },
                                callback: function(value) {
                                    // Kürzeres Format auf Mobile
                                    return isMobile ? '€' + Math.round(value) : formatEuro(value);
                                }
                            },
                            title: {
                                display: !isMobile,  // Verberge Titel auf Mobile
                                text: 'Durchschnittliche Einkaufshöhe',
                                font: {
                                    size: isMobile ? 11 : 12
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading Billa combined chart:', error));
}

// ===== URLAUBE SECTION =====

function loadUrlaubeStats() {
    fetch(addPersonToUrl('/api/urlaube-chart/'))
        .then(response => response.json())
        .then(data => {
            const stats = data.stats || {};
            const totalAmount = stats.total_amount || 0;
            const tripCount = stats.trip_count || 0;
            const averageAmount = stats.average_amount || 0;
            const summary = stats.year_summary || {};

            const year2024 = summary['2024'] || { amount: 0, trip_count: 0 };
            const year2025 = summary['2025'] || { amount: 0, trip_count: 0 };

            document.getElementById('urlaube-gesamt').innerHTML = formatEuro(totalAmount);
            document.getElementById('urlaube-anzahl').innerHTML = tripCount;
            document.getElementById('urlaube-durchschnitt').innerHTML = formatEuro(averageAmount);

            document.getElementById('urlaube-2024-gesamt').innerHTML = formatEuro(year2024.amount || 0);
            document.getElementById('urlaube-2024-anzahl').innerHTML = `${year2024.trip_count || 0} Urlaube`;

            document.getElementById('urlaube-2025-gesamt').innerHTML = formatEuro(year2025.amount || 0);
            document.getElementById('urlaube-2025-anzahl').innerHTML = `${year2025.trip_count || 0} Urlaube`;
        })
        .catch(error => {
            console.error('Error loading urlaube stats:', error);
            document.getElementById('urlaube-gesamt').innerHTML = '<span class="text-danger">Fehler</span>';
            document.getElementById('urlaube-anzahl').innerHTML = '<span class="text-danger">-</span>';
            document.getElementById('urlaube-durchschnitt').innerHTML = '<span class="text-danger">-</span>';
        });
}

function createUrlaubeChart() {
    fetch(addPersonToUrl('/api/urlaube-chart/'))
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('urlaubeChart').getContext('2d');

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            if (urlaubeChartInstance) {
                urlaubeChartInstance.destroy();
            }

            const chartData = {
                labels: data.labels,
                datasets: data.datasets
            };

            urlaubeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: isMobile ? 5 : 10,
                            right: isMobile ? 5 : 10,
                            bottom: isMobile ? 5 : 10,
                            left: isMobile ? 5 : 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        axis: 'y',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (isMobile) {
                                        return '€' + (value / 1000).toFixed(1) + 'k';
                                    }
                                    return formatEuro(value);
                                },
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                                },
                                maxRotation: 0,
                                autoSkip: true
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 11)
                                },
                                autoSkip: false,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    // Auf Mobile: Zeige nur Datum, nicht Beschreibung
                                    if (isMobile) {
                                        return label.split('\n')[0];
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 13)
                                },
                                padding: isSmallMobile ? 8 : (isMobile ? 10 : 15),
                                boxWidth: isMobile ? 12 : 15,
                                boxHeight: isMobile ? 12 : 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                title: function(context) {
                                    // Zeige beide Zeilen im Tooltip
                                    return context[0].label.replace('\n', ' - ');
                                },
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatEuro(context.parsed.x);
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => {
                                        sum += item.parsed.x;
                                    });
                                    return '━━━━━━━━━━━━━━━━\nGesamt: ' + formatEuro(sum);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error creating urlaube chart:', error));
}

// ===== BETRIEBSKOSTEN SECTION =====

function loadBetriebskostenStats() {
    fetch(addPersonToUrl('/api/betriebskosten-chart/'))
        .then(response => response.json())
        .then(data => {
            // Berechne Statistiken
            const labels = data.labels;
            const datasets = data.datasets;
            
            // Summe für letzten Monat (2025.07)
            let aktuell = 0;
            datasets.forEach(ds => {
                aktuell += ds.data[ds.data.length - 1] || 0;
            });
            
            // Durchschnitt
            let gesamt = 0;
            let count = labels.length;
            datasets.forEach(ds => {
                ds.data.forEach(val => gesamt += val);
            });
            const durchschnitt = count > 0 ? gesamt / count : 0;
            
            // Steigerung 2022.01 vs 2025.07
            let start = 0;
            let ende = 0;
            datasets.forEach(ds => {
                start += ds.data[0] || 0;
                ende += ds.data[ds.data.length - 1] || 0;
            });
            const steigerungProzent = start > 0 ? ((ende - start) / start * 100).toFixed(1) : 0;
            const steigerungBetrag = ende - start;
            
            // Update UI
            document.getElementById('betriebskosten-aktuell').innerHTML = formatEuro(aktuell);
            document.getElementById('betriebskosten-durchschnitt').innerHTML = formatEuro(durchschnitt);
            document.getElementById('betriebskosten-steigerung').innerHTML = 
                `<span class="text-${steigerungBetrag >= 0 ? 'danger' : 'success'}">${formatEuro(steigerungBetrag)} (+${steigerungProzent}%)</span>`;
            
            // Fülle Tabelle
            fillBetriebskostenTable(data);
        })
        .catch(error => {
            console.error('Error loading betriebskosten stats:', error);
            document.getElementById('betriebskosten-aktuell').innerHTML = '<span class="text-danger">Fehler</span>';
        });
}

function fillBetriebskostenTable(data) {
    const tbody = document.querySelector('#betriebskostenTable tbody');
    tbody.innerHTML = '';
    
    const kategorien = ['Reparaturrücklage', 'Wohnkosten', 'Heizkosten & Warmwasser', 'Wohnkosten Wasser'];
    
    data.labels.forEach((label, index) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = label;
        
        let summe = 0;
        kategorien.forEach(kat => {
            const dataset = data.datasets.find(ds => ds.label === kat);
            const wert = dataset ? dataset.data[index] : 0;
            summe += wert;
            
            const cell = row.insertCell();
            cell.className = 'text-end';
            cell.textContent = formatEuro(wert);
        });
        
        const sumCell = row.insertCell();
        sumCell.className = 'text-end fw-bold';
        sumCell.textContent = formatEuro(summe);
    });
}

function createBetriebskostenChart() {
    fetch(addPersonToUrl('/api/betriebskosten-chart/'))
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('betriebskostenChart').getContext('2d');

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            if (betriebskostenChartInstance) {
                betriebskostenChartInstance.destroy();
            }

            betriebskostenChartInstance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: isMobile ? 5 : 10,
                            right: isMobile ? 5 : 10,
                            bottom: isMobile ? 5 : 10,
                            left: isMobile ? 5 : 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (isMobile) {
                                        return '€' + Math.round(value);
                                    }
                                    return formatEuro(value);
                                },
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 13)
                                },
                                padding: isSmallMobile ? 8 : (isMobile ? 10 : 15),
                                boxWidth: isMobile ? 12 : 15,
                                boxHeight: isMobile ? 12 : 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatEuro(context.parsed.y);
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(item => {
                                        sum += item.parsed.y;
                                    });
                                    return '━━━━━━━━━━━━━━━━\nGesamt: ' + formatEuro(sum);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error creating betriebskosten chart:', error));
}


function reloadAllCharts() {
    const yearSelect = document.getElementById('barChartYearSelect');
    const selectedYear = yearSelect ? yearSelect.value : defaultYear;

    loadMonthlyChart(selectedYear);
    loadPieChart(2025, 'categoryPieChart2025', '2025');
    loadPieChart(2024, 'categoryPieChart2024', '2024');

    loadCategoryGroupStats();
    createTrendCharts();
    createComparisonCharts();
    createQuarterlyCharts();

    loadSupermarketStats();
    createSupermarketTrendChart();
    createSupermarketComparisonChart();
    createBillaCombinedChart();

    loadUrlaubeStats();
    createUrlaubeChart();

    loadBetriebskostenStats();
    createBetriebskostenChart();
}


// ===== NEUE FUNKTIONEN FÜR MODERNISIERTES DASHBOARD =====

// Filter-Chip Management
function updateFilterChips() {
    const personSelect = document.getElementById('personFilter');
    const personChip = document.getElementById('personFilterChip');
    const personChipLabel = document.getElementById('personFilterChipLabel');

    if (personSelect && personChip && personChipLabel) {
        const selectedValue = personSelect.value;
        const selectedText = personSelect.options[personSelect.selectedIndex].text;

        if (selectedValue !== 'all') {
            personChip.style.display = 'flex';
            personChipLabel.textContent = selectedText;
            personChip.className = 'filter-chip filter-chip-person-' + selectedValue;
        } else {
            personChip.style.display = 'none';
        }
    }
}

// Filter zurücksetzen
function clearPersonFilter() {
    const personSelect = document.getElementById('personFilter');
    if (personSelect) {
        personSelect.value = 'all';
        personSelect.dispatchEvent(new Event('change'));
    }
}

// Scroll zu Element
function scrollToElement(selector) {
    const element = document.querySelector(selector);
    if (element) {
        const yOffset = -80;
        const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;
        window.scrollTo({
            top: y,
            behavior: 'smooth'
        });
    }
}

// Bootstrap Tooltips initialisieren
function initializeTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// ===== PHASE 2: FILTER-MANAGEMENT =====

// Global filter state
let currentFilters = {
    year: '',
    month: '',
    person: '',
    accounts: [],
    categories: [],
    search: '',
    amountMin: '',
    amountMax: ''
};

// Filter-Optionen dynamisch laden
async function loadFilterOptions() {
    try {
        // Konten laden
        const accountsResponse = await fetch('/finance/api/household-filter-accounts/');
        const accountsData = await accountsResponse.json();
        const accountSelect = document.getElementById('filterAccount');

        if (accountSelect && accountsData.accounts) {
            accountSelect.innerHTML = '<option value="">Alle Konten</option>';
            accountsData.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = acc.name;
                accountSelect.appendChild(option);
            });
        }

        // Kategorien laden
        const categoriesResponse = await fetch('/finance/api/household-filter-categories/');
        const categoriesData = await categoriesResponse.json();
        const categorySelect = document.getElementById('filterCategory');

        if (categorySelect && categoriesData.categories) {
            categorySelect.innerHTML = '<option value="">Alle Kategorien</option>';
            categoriesData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Fehler beim Laden der Filter-Optionen:', error);
    }
}

// Filter anwenden
function applyFilters() {
    // Sammle alle Filter-Werte
    currentFilters.year = document.getElementById('filterYear')?.value || '';
    currentFilters.month = document.getElementById('filterMonth')?.value || '';
    currentFilters.person = document.getElementById('filterPersonAdvanced')?.value || '';

    // Multi-Select Werte
    const accountSelect = document.getElementById('filterAccount');
    currentFilters.accounts = Array.from(accountSelect?.selectedOptions || [])
        .map(opt => opt.value)
        .filter(val => val !== '');

    const categorySelect = document.getElementById('filterCategory');
    currentFilters.categories = Array.from(categorySelect?.selectedOptions || [])
        .map(opt => opt.value)
        .filter(val => val !== '');

    currentFilters.search = document.getElementById('filterSearch')?.value || '';
    currentFilters.amountMin = document.getElementById('filterAmountMin')?.value || '';
    currentFilters.amountMax = document.getElementById('filterAmountMax')?.value || '';

    // Filter-Chips aktualisieren
    updateAppliedFilterChips();

    // Transaktionsliste neu laden
    loadTransactions();

    // Charts neu laden (später: mit Filtern)
    // reloadAllCharts();

    // Erfolgsbenachrichtigung
    showFilterNotification('Filter wurden angewendet');
}

// Filter-Chips aktualisieren
function updateAppliedFilterChips() {
    const chipsContainer = document.getElementById('appliedFiltersChips');
    const chipsWrapper = document.getElementById('appliedFiltersChipsContainer');
    const activeCountBadge = document.getElementById('activeFiltersCount');

    if (!chipsContainer) return;

    chipsContainer.innerHTML = '';
    let activeCount = 0;

    // Jahr-Chip
    if (currentFilters.year) {
        chipsContainer.appendChild(createFilterChip('Jahr', currentFilters.year, 'year'));
        activeCount++;
    }

    // Monat-Chip
    if (currentFilters.month) {
        const monthNames = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        const monthName = monthNames[parseInt(currentFilters.month) - 1];
        chipsContainer.appendChild(createFilterChip('Monat', monthName, 'month'));
        activeCount++;
    }

    // Person-Chip
    if (currentFilters.person) {
        const personName = currentFilters.person.charAt(0).toUpperCase() + currentFilters.person.slice(1);
        chipsContainer.appendChild(createFilterChip('Person', personName, 'person'));
        activeCount++;
    }

    // Konten-Chips
    if (currentFilters.accounts.length > 0) {
        const accountSelect = document.getElementById('filterAccount');
        currentFilters.accounts.forEach(accId => {
            const option = accountSelect?.querySelector(`option[value="${accId}"]`);
            if (option) {
                chipsContainer.appendChild(createFilterChip('Konto', option.textContent, 'account', accId));
                activeCount++;
            }
        });
    }

    // Kategorien-Chips
    if (currentFilters.categories.length > 0) {
        const categorySelect = document.getElementById('filterCategory');
        currentFilters.categories.forEach(catId => {
            const option = categorySelect?.querySelector(`option[value="${catId}"]`);
            if (option) {
                chipsContainer.appendChild(createFilterChip('Kategorie', option.textContent, 'category', catId));
                activeCount++;
            }
        });
    }

    // Suche-Chip
    if (currentFilters.search) {
        chipsContainer.appendChild(createFilterChip('Suche', `"${currentFilters.search}"`, 'search'));
        activeCount++;
    }

    // Betrag-Chips
    if (currentFilters.amountMin) {
        chipsContainer.appendChild(createFilterChip('Min', `${currentFilters.amountMin}€`, 'amountMin'));
        activeCount++;
    }
    if (currentFilters.amountMax) {
        chipsContainer.appendChild(createFilterChip('Max', `${currentFilters.amountMax}€`, 'amountMax'));
        activeCount++;
    }

    // Container anzeigen/verstecken
    if (activeCount > 0) {
        chipsWrapper.style.display = 'block';
        activeCountBadge.style.display = 'inline-block';
        activeCountBadge.textContent = activeCount;
    } else {
        chipsWrapper.style.display = 'none';
        activeCountBadge.style.display = 'none';
    }
}

// Filter-Chip erstellen
function createFilterChip(label, value, filterType, filterId = null) {
    const chip = document.createElement('div');
    chip.className = 'filter-chip';

    const labelSpan = document.createElement('span');
    labelSpan.className = 'text-muted me-1';
    labelSpan.textContent = label + ':';

    const valueSpan = document.createElement('strong');
    valueSpan.textContent = value;

    const removeIcon = document.createElement('i');
    removeIcon.className = 'bi bi-x filter-chip-remove ms-2';
    removeIcon.style.cursor = 'pointer';
    removeIcon.onclick = () => removeFilterChip(filterType, filterId);

    chip.appendChild(labelSpan);
    chip.appendChild(valueSpan);
    chip.appendChild(removeIcon);

    return chip;
}

// Einzelnen Filter-Chip entfernen
function removeFilterChip(filterType, filterId = null) {
    switch (filterType) {
        case 'year':
            document.getElementById('filterYear').value = '';
            currentFilters.year = '';
            break;
        case 'month':
            document.getElementById('filterMonth').value = '';
            currentFilters.month = '';
            break;
        case 'person':
            document.getElementById('filterPersonAdvanced').value = '';
            currentFilters.person = '';
            break;
        case 'account':
            const accountSelect = document.getElementById('filterAccount');
            const accountOption = accountSelect?.querySelector(`option[value="${filterId}"]`);
            if (accountOption) accountOption.selected = false;
            currentFilters.accounts = currentFilters.accounts.filter(id => id !== filterId);
            break;
        case 'category':
            const categorySelect = document.getElementById('filterCategory');
            const categoryOption = categorySelect?.querySelector(`option[value="${filterId}"]`);
            if (categoryOption) categoryOption.selected = false;
            currentFilters.categories = currentFilters.categories.filter(id => id !== filterId);
            break;
        case 'search':
            document.getElementById('filterSearch').value = '';
            currentFilters.search = '';
            break;
        case 'amountMin':
            document.getElementById('filterAmountMin').value = '';
            currentFilters.amountMin = '';
            break;
        case 'amountMax':
            document.getElementById('filterAmountMax').value = '';
            currentFilters.amountMax = '';
            break;
    }

    updateAppliedFilterChips();
    loadTransactions();
}

// Alle Filter-Chips entfernen
function clearAllFilterChips() {
    resetAllFilters();
}

// Alle Filter zurücksetzen
function resetAllFilters() {
    // Formular zurücksetzen
    document.getElementById('filterYear').value = '';
    document.getElementById('filterMonth').value = '';
    document.getElementById('filterPersonAdvanced').value = '';

    const accountSelect = document.getElementById('filterAccount');
    if (accountSelect) {
        Array.from(accountSelect.options).forEach(opt => opt.selected = false);
    }

    const categorySelect = document.getElementById('filterCategory');
    if (categorySelect) {
        Array.from(categorySelect.options).forEach(opt => opt.selected = false);
    }

    document.getElementById('filterSearch').value = '';
    document.getElementById('filterAmountMin').value = '';
    document.getElementById('filterAmountMax').value = '';

    // Filter-State zurücksetzen
    currentFilters = {
        year: '',
        month: '',
        person: '',
        accounts: [],
        categories: [],
        search: '',
        amountMin: '',
        amountMax: ''
    };

    updateAppliedFilterChips();
    loadTransactions();

    showFilterNotification('Alle Filter wurden zurückgesetzt');
}

// Filter als Favorit speichern
async function saveFilterFavorite() {
    const filterName = prompt('Name für diesen Filter:', 'Mein Filter ' + new Date().toLocaleDateString());

    if (!filterName) return;

    try {
        const response = await fetch('/finance/api/household-save-filter-favorite/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: filterName,
                filters: currentFilters
            })
        });

        const data = await response.json();

        if (data.success) {
            showFilterNotification(data.message, 'success');
        } else {
            showFilterNotification('Fehler beim Speichern: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Fehler beim Speichern des Favoriten:', error);
        showFilterNotification('Fehler beim Speichern des Favoriten', 'error');
    }
}

// CSRF Token holen
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Benachrichtigung anzeigen
function showFilterNotification(message, type = 'info') {
    // Toast-Benachrichtigung erstellen (Bootstrap Toast)
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Instant-Suche
let searchTimeout;
function setupInstantSearch() {
    const searchInput = document.getElementById('filterSearch');
    const searchResultsCount = document.getElementById('searchResultsCount');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);

            if (this.value.length === 0) {
                searchResultsCount.textContent = '';
                return;
            }

            searchTimeout = setTimeout(() => {
                const query = this.value.toLowerCase();
                searchResultsCount.textContent = `Suche nach "${query}"...`;

                // Transaktionen neu laden mit Suchbegriff
                loadTransactions();
            }, 500);
        });
    }
}

// ===== PHASE 3: TRANSAKTIONS-TABELLE =====

let currentPage = 1;
let allTransactions = [];

// Transaktionen laden
async function loadTransactions(append = false) {
    if (!append) {
        currentPage = 1;
        allTransactions = [];
    }

    // Filter-Parameter sammeln
    const params = new URLSearchParams();

    if (currentFilters.year) params.append('year', currentFilters.year);
    if (currentFilters.month) params.append('month', currentFilters.month);
    if (currentFilters.person) params.append('person', currentFilters.person);
    if (currentFilters.search) params.append('search', currentFilters.search);
    if (currentFilters.amountMin) params.append('amount_min', currentFilters.amountMin);
    if (currentFilters.amountMax) params.append('amount_max', currentFilters.amountMax);

    currentFilters.accounts.forEach(acc => params.append('accounts[]', acc));
    currentFilters.categories.forEach(cat => params.append('categories[]', cat));

    params.append('page', currentPage);
    params.append('page_size', 50);

    try {
        const response = await fetch(`/finance/api/household-transactions-list/?${params.toString()}`);
        const data = await response.json();

        if (append) {
            allTransactions = allTransactions.concat(data.transactions);
        } else {
            allTransactions = data.transactions;
        }

        renderTransactions(data);
        updatePaginationInfo(data.pagination);
        updateTotals(data.totals);

        // Announce für Screen Reader
        announceUpdate(`${data.pagination.total_count} Transaktionen geladen`);
    } catch (error) {
        console.error('Fehler beim Laden der Transaktionen:', error);
        showFilterNotification('Fehler beim Laden der Transaktionen', 'error');
        announceUpdate('Fehler beim Laden der Transaktionen');
    }
}

// Transaktionen rendern
function renderTransactions(data) {
    const tableBody = document.getElementById('transactionsTableBody');
    const mobileCards = document.getElementById('transactionsMobileCards');
    const countText = document.getElementById('transactionsCountText');

    // Update count
    countText.textContent = `${data.pagination.total_count} Transaktionen`;

    // Desktop Tabelle
    if (allTransactions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted">Keine Transaktionen gefunden</td></tr>';
        mobileCards.innerHTML = '<div class="text-center py-4 text-muted">Keine Transaktionen gefunden</div>';
        return;
    }

    tableBody.innerHTML = '';
    allTransactions.forEach(trans => {
        const row = document.createElement('tr');
        row.onclick = () => viewTransactionDetails(trans);

        row.innerHTML = `
            <td>${formatDate(trans.date)}</td>
            <td>${trans.payee}</td>
            <td>${trans.account}</td>
            <td>${trans.category}</td>
            <td><span class="person-badge person-badge-${trans.person.toLowerCase()}">${trans.person}</span></td>
            <td>${trans.memo || '-'}</td>
            <td class="text-end">${trans.outflow > 0 ? formatCurrency(trans.outflow) : '-'}</td>
            <td class="text-end">${trans.inflow > 0 ? formatCurrency(trans.inflow) : '-'}</td>
            <td class="text-end sticky-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editTransaction(${trans.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
        `;

        tableBody.appendChild(row);
    });

    // Mobile Cards
    mobileCards.innerHTML = '';
    allTransactions.forEach(trans => {
        const card = createTransactionCard(trans);
        mobileCards.appendChild(card);
    });
}

// Mobile Transaction Card erstellen
function createTransactionCard(trans) {
    const card = document.createElement('div');
    card.className = 'transaction-card';
    card.onclick = () => viewTransactionDetails(trans);

    const amountClass = trans.amount > 0 ? 'text-danger' : trans.amount < 0 ? 'text-success' : 'text-muted';

    card.innerHTML = `
        <div class="transaction-card-header">
            <div>
                <h6 class="mb-1">${trans.payee}</h6>
                <small class="text-muted">${formatDate(trans.date)}</small>
            </div>
            <div class="text-end">
                <div class="transaction-card-amount ${amountClass}">
                    ${formatCurrency(Math.abs(trans.amount))} €
                </div>
                <span class="person-badge person-badge-${trans.person.toLowerCase()}">${trans.person}</span>
            </div>
        </div>
        <div class="transaction-card-body">
            <div class="transaction-card-field">
                <span class="transaction-card-label">Kategorie</span>
                <span class="transaction-card-value">${trans.category}</span>
            </div>
            <div class="transaction-card-field">
                <span class="transaction-card-label">Konto</span>
                <span class="transaction-card-value">${trans.account}</span>
            </div>
            ${trans.memo ? `
                <div class="transaction-card-field" style="grid-column: 1 / -1;">
                    <span class="transaction-card-label">Memo</span>
                    <span class="transaction-card-value">${trans.memo}</span>
                </div>
            ` : ''}
        </div>
    `;

    return card;
}

// Weitere Transaktionen laden
function loadMoreTransactions() {
    currentPage++;
    loadTransactions(true);
}

// Pagination Info aktualisieren
function updatePaginationInfo(pagination) {
    const paginationInfo = document.getElementById('paginationInfo');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    paginationInfo.textContent = `Seite ${pagination.page} von ${pagination.total_pages} (${pagination.total_count} Transaktionen)`;

    if (pagination.has_next) {
        loadMoreBtn.style.display = 'inline-block';
    } else {
        loadMoreBtn.style.display = 'none';
    }
}

// Summen aktualisieren
function updateTotals(totals) {
    document.getElementById('totalOutflow').textContent = formatCurrency(totals.outflow);
    document.getElementById('totalInflow').textContent = formatCurrency(totals.inflow);
    document.getElementById('totalNetto').textContent = formatCurrency(totals.netto);
}

// Helper: Datum formatieren
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Helper: Währung formatieren
function formatCurrency(amount) {
    return new Intl.NumberFormat('de-DE', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

// ===== PHASE 4: TRANSACTION DETAILS & DRILLDOWN =====

// Transaction Details anzeigen
function viewTransactionDetails(trans) {
    const offcanvas = new bootstrap.Offcanvas(document.getElementById('transactionDetailsOffcanvas'));
    const content = document.getElementById('transactionDetailsContent');

    // Zeige Offcanvas
    offcanvas.show();

    // Baue Detail-Content
    content.innerHTML = `
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-info-circle"></i> Basis-Informationen
            </div>
            <div class="detail-row">
                <span class="detail-label">Datum</span>
                <span class="detail-value">${formatDate(trans.date)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payee</span>
                <span class="detail-value">
                    <a href="#" onclick="event.preventDefault(); viewPayeeHistory('${trans.payee}', '${trans.person}')" class="text-primary text-decoration-none">
                        ${trans.payee} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Konto</span>
                <span class="detail-value">${trans.account}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Kategorie</span>
                <span class="detail-value">
                    <a href="#" onclick="event.preventDefault(); viewCategoryAnalysis('${trans.category}')" class="text-primary text-decoration-none">
                        ${trans.category} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Person</span>
                <span class="detail-value">
                    <span class="person-badge person-badge-${trans.person.toLowerCase()}">${trans.person}</span>
                </span>
            </div>
            ${trans.memo ? `
                <div class="detail-row">
                    <span class="detail-label">Memo</span>
                    <span class="detail-value">${trans.memo}</span>
                </div>
            ` : ''}
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-cash-stack"></i> Beträge
            </div>
            <div class="detail-row">
                <span class="detail-label">Ausgaben</span>
                <span class="detail-value text-danger">${trans.outflow > 0 ? formatCurrency(trans.outflow) + ' €' : '-'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Einnahmen</span>
                <span class="detail-value text-success">${trans.inflow > 0 ? formatCurrency(trans.inflow) + ' €' : '-'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label fw-bold">Netto</span>
                <span class="detail-value fw-bold" style="color: ${trans.amount > 0 ? 'var(--color-negative)' : trans.amount < 0 ? 'var(--color-positive)' : 'var(--color-neutral)'}">
                    ${formatCurrency(Math.abs(trans.amount))} €
                </span>
            </div>
        </div>

        <div class="detail-section">
            <div class="detail-section-title">
                <i class="bi bi-pen"></i> Aktionen
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="editTransaction(${trans.id})">
                    <i class="bi bi-pencil"></i> Transaktion bearbeiten
                </button>
                <button class="btn btn-outline-primary" onclick="viewPayeeHistory('${trans.payee}', '${trans.person}')">
                    <i class="bi bi-clock-history"></i> Payee-Historie anzeigen
                </button>
                <button class="btn btn-outline-secondary" onclick="viewCategoryAnalysis('${trans.category}')">
                    <i class="bi bi-bar-chart-line"></i> Kategorie-Analyse
                </button>
            </div>
        </div>
    `;
}

// Payee-Historie anzeigen
async function viewPayeeHistory(payeeName, person) {
    const offcanvas = new bootstrap.Offcanvas(document.getElementById('payeeHistoryOffcanvas'));
    const content = document.getElementById('payeeHistoryContent');
    const nameElement = document.getElementById('payeeHistoryName');

    nameElement.textContent = payeeName;
    offcanvas.show();

    // Loading state
    content.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3 text-muted">Lade Transaktionen...</p>
        </div>
    `;

    try {
        // Lade Transaktionen für diesen Payee
        const params = new URLSearchParams();
        params.append('search', payeeName);
        if (person && person !== 'all') {
            params.append('person', person.toLowerCase());
        }
        params.append('page_size', 100);

        const response = await fetch(`/finance/api/household-transactions-list/?${params.toString()}`);
        const data = await response.json();

        if (data.transactions.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Keine Transaktionen gefunden für "${payeeName}".
                </div>
            `;
            return;
        }

        // Berechne Statistiken
        const totalCount = data.transactions.length;
        const totalAmount = data.transactions.reduce((sum, t) => sum + t.amount, 0);
        const avgAmount = totalAmount / totalCount;
        const latestDate = data.transactions[0].date;
        const oldestDate = data.transactions[data.transactions.length - 1].date;

        // Baue Content
        content.innerHTML = `
            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-graph-up"></i> Statistik
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">${totalCount}</div>
                            <div class="stat-label">Transaktionen</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(avgAmount)} €</div>
                            <div class="stat-label">Ø Betrag</div>
                        </div>
                    </div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Erste Transaktion</span>
                    <span class="detail-value">${formatDate(oldestDate)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Letzte Transaktion</span>
                    <span class="detail-value">${formatDate(latestDate)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Gesamt-Netto</span>
                    <span class="detail-value fw-bold" style="color: ${totalAmount > 0 ? 'var(--color-negative)' : 'var(--color-positive)'}">
                        ${formatCurrency(Math.abs(totalAmount))} €
                    </span>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-clock-history"></i> Transaktions-Historie
                </div>
                <div class="transaction-timeline">
                    ${data.transactions.slice(0, 20).map(t => `
                        <div class="timeline-item">
                            <div class="timeline-date">${formatDate(t.date)}</div>
                            <div class="timeline-content">
                                <strong>${formatCurrency(Math.abs(t.amount))} €</strong> - ${t.category}
                                ${t.memo ? `<br><small class="text-muted">${t.memo}</small>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${data.transactions.length > 20 ? `
                    <div class="alert alert-info mt-3">
                        <small><i class="bi bi-info-circle"></i> Zeige die letzten 20 von ${totalCount} Transaktionen.</small>
                    </div>
                ` : ''}
            </div>
        `;
    } catch (error) {
        console.error('Fehler beim Laden der Payee-Historie:', error);
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Fehler beim Laden der Daten.
            </div>
        `;
    }
}

// Kategorie-Analyse anzeigen
async function viewCategoryAnalysis(categoryName) {
    const offcanvas = new bootstrap.Offcanvas(document.getElementById('categoryAnalysisOffcanvas'));
    const content = document.getElementById('categoryAnalysisContent');
    const nameElement = document.getElementById('categoryAnalysisName');

    nameElement.textContent = categoryName;
    offcanvas.show();

    content.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3 text-muted">Lade Kategorie-Daten...</p>
        </div>
    `;

    try {
        // Lade Transaktionen für diese Kategorie
        const params = new URLSearchParams();
        params.append('search', categoryName);
        params.append('page_size', 100);

        const response = await fetch(`/finance/api/household-transactions-list/?${params.toString()}`);
        const data = await response.json();

        if (data.transactions.length === 0) {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Keine Transaktionen gefunden für Kategorie "${categoryName}".
                </div>
            `;
            return;
        }

        // Aggregiere nach Monat
        const monthlyData = {};
        data.transactions.forEach(t => {
            const monthKey = t.date.substring(0, 7); // YYYY-MM
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { total: 0, count: 0 };
            }
            monthlyData[monthKey].total += t.amount;
            monthlyData[monthKey].count += 1;
        });

        const sortedMonths = Object.keys(monthlyData).sort().reverse().slice(0, 12);

        // Baue Content
        content.innerHTML = `
            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-graph-up"></i> Übersicht
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">${data.transactions.length}</div>
                            <div class="stat-label">Transaktionen</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-value">${formatCurrency(data.totals.netto)} €</div>
                            <div class="stat-label">Gesamt-Netto</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-calendar3"></i> Monatliche Ausgaben (letzte 12 Monate)
                </div>
                ${sortedMonths.map(month => `
                    <div class="detail-row">
                        <span class="detail-label">${month}</span>
                        <span class="detail-value">
                            ${formatCurrency(Math.abs(monthlyData[month].total))} €
                            <small class="text-muted">(${monthlyData[month].count}x)</small>
                        </span>
                    </div>
                `).join('')}
            </div>

            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="bi bi-list-ul"></i> Letzte Transaktionen
                </div>
                ${data.transactions.slice(0, 10).map(t => `
                    <div class="similar-transaction-item" onclick="viewTransactionDetails(${JSON.stringify(t).replace(/"/g, '&quot;')})">
                        <div>
                            <div><strong>${t.payee}</strong></div>
                            <small class="text-muted">${formatDate(t.date)} • ${t.person}</small>
                        </div>
                        <div class="text-end">
                            <strong style="color: ${t.amount > 0 ? 'var(--color-negative)' : 'var(--color-positive)'}">
                                ${formatCurrency(Math.abs(t.amount))} €
                            </strong>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Fehler beim Laden der Kategorie-Analyse:', error);
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Fehler beim Laden der Daten.
            </div>
        `;
    }
}

// Transaction bearbeiten
function editTransaction(transId) {
    window.location.href = `/finance/transactions/edit/${transId}/`;
}

// CSV Export
function exportTransactions(format) {
    if (format === 'csv') {
        let csv = 'Datum,Payee,Konto,Kategorie,Person,Memo,Ausgaben,Einnahmen\n';

        allTransactions.forEach(trans => {
            csv += `${trans.date},"${trans.payee}","${trans.account}","${trans.category}",${trans.person},"${trans.memo}",${trans.outflow},${trans.inflow}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', `transaktionen_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showFilterNotification('CSV-Export erfolgreich', 'success');
    }
}

// ===== PHASE 5: DARK MODE & ACCESSIBILITY =====

// Dark Mode Toggle
function initializeDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    const htmlElement = document.documentElement;

    // Lade gespeicherte Präferenz
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    // Event Listener
    toggle.addEventListener('click', toggleDarkMode);
    toggle.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleDarkMode();
        }
    });

    function toggleDarkMode() {
        const currentTheme = htmlElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
    }

    function setTheme(theme) {
        htmlElement.setAttribute('data-theme', theme);
        toggle.classList.toggle('active', theme === 'dark');
        toggle.setAttribute('aria-checked', theme === 'dark');
    }
}

// Keyboard Navigation für Tabelle
function setupKeyboardNavigation() {
    const table = document.getElementById('transactionsTable');
    if (!table) return;

    let currentRow = -1;
    const rows = table.querySelectorAll('tbody tr');

    document.addEventListener('keydown', function(e) {
        // Nur wenn Focus auf Tabelle oder nirgends
        if (!document.activeElement || document.activeElement === document.body) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentRow = Math.min(currentRow + 1, rows.length - 1);
                rows[currentRow]?.focus();
                rows[currentRow]?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentRow = Math.max(currentRow - 1, 0);
                rows[currentRow]?.focus();
                rows[currentRow]?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
    });

    // Mache Rows fokussierbar
    rows.forEach((row, index) => {
        row.setAttribute('tabindex', '0');
        row.setAttribute('role', 'button');
        row.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                row.click();
            }
        });
    });
}

// Skip Navigation Link
function setupSkipLinks() {
    const skipLinks = document.querySelectorAll('a[href^="#"]');
    skipLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const targetId = this.getAttribute('href').substring(1);
            const target = document.getElementById(targetId);
            if (target) {
                e.preventDefault();
                target.setAttribute('tabindex', '-1');
                target.focus();
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
}

// Focus Management für Offcanvas
function setupOffcanvasFocusManagement() {
    const offcanvases = document.querySelectorAll('.offcanvas');

    offcanvases.forEach(offcanvas => {
        offcanvas.addEventListener('shown.bs.offcanvas', function() {
            // Fokussiere ersten fokussierbaren Element
            const focusable = this.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusable) {
                setTimeout(() => focusable.focus(), 100);
            }
        });

        offcanvas.addEventListener('hidden.bs.offcanvas', function() {
            // Gebe Focus zurück zum Trigger-Element
            document.activeElement?.blur();
        });
    });
}

// Live Region für dynamische Updates
function announceUpdate(message) {
    let liveRegion = document.getElementById('ariaLiveRegion');
    if (!liveRegion) {
        liveRegion = document.createElement('div');
        liveRegion.id = 'ariaLiveRegion';
        liveRegion.setAttribute('role', 'status');
        liveRegion.setAttribute('aria-live', 'polite');
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.style.position = 'absolute';
        liveRegion.style.left = '-10000px';
        liveRegion.style.width = '1px';
        liveRegion.style.height = '1px';
        liveRegion.style.overflow = 'hidden';
        document.body.appendChild(liveRegion);
    }
    liveRegion.textContent = message;
}

// Initialisierung beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    const yearSelect = document.getElementById('barChartYearSelect');
    const personSelect = document.getElementById('personFilter');

    // Tooltips initialisieren
    initializeTooltips();

    // Filter-Chips initial setzen
    updateFilterChips();

    // Phase 2: Filter-System initialisieren
    loadFilterOptions();
    setupInstantSearch();

    // Phase 5: Dark Mode & Accessibility
    initializeDarkMode();
    setupKeyboardNavigation();
    setupSkipLinks();
    setupOffcanvasFocusManagement();

    if (personSelect) {
        currentPerson = personSelect.value;
        personSelect.addEventListener('change', function() {
            currentPerson = this.value;
            updateFilterChips();
            resetPieDrilldownState();
            reloadAllCharts();
            announceUpdate(`Filter geändert auf ${this.options[this.selectedIndex].text}`);
        });
    }

    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            loadMonthlyChart(this.value);
            announceUpdate(`Jahr geändert auf ${this.value}`);
        });
    }

    reloadAllCharts();

    // === PHASE 3: TRANSAKTIONS-TABELLE ===
    loadTransactions();

    // === Floating Navigation ===
    const floatingBtn = document.getElementById('floatingNavBtn');
    const navOverlay = document.getElementById('navOverlay');
    const navMenu = document.getElementById('navMenu');
    const navCloseBtn = document.getElementById('navCloseBtn');
    const navMenuItems = document.querySelectorAll('.nav-menu-item');

    // Zeige Button beim Scrollen
    window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
            floatingBtn.classList.add('show');
        } else {
            floatingBtn.classList.remove('show');
        }
    });

    // Öffne Navigation
    floatingBtn.addEventListener('click', function() {
        navOverlay.classList.add('show');
        navMenu.classList.add('show');
        document.body.style.overflow = 'hidden';
    });

    // Schließe Navigation
    function closeNav() {
        navOverlay.classList.remove('show');
        navMenu.classList.remove('show');
        document.body.style.overflow = '';
    }

    navCloseBtn.addEventListener('click', closeNav);
    navOverlay.addEventListener('click', closeNav);

    // Navigation zu Bereichen
    navMenuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-section');
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                closeNav();

                // Smooth scroll mit Offset für Header
                const yOffset = -80;
                const y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;

                window.scrollTo({
                    top: y,
                    behavior: 'smooth'
                });
            }
        });
    });
});
</script>
{% endblock %}