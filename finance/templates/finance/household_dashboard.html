{% extends 'finance/base.html' %}

{% block title %}Dashboard Haushalt{% endblock %}

{% block content %}
<style>
    .chart-container-horizontal {
        position: relative;
        height: 600px;
        padding-bottom: 10px;
    }

    .chart-container-medium {
        position: relative;
        height: 280px;
        padding-bottom: 10px;
    }

    .categorygroup-header {
        padding: 15px 20px;
        color: white;
        border-radius: 5px 5px 0 0;
        margin-bottom: 0;
    }

    .stat-box {
        background: #f8f9fa;
        border-left: 4px solid;
        padding: 12px 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .stat-box-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
        font-weight: 500;
    }

    .stat-box-value {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
        color: #212529;
    }

    @media (max-width: 576px) {
        .stat-box {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 12px;
        }

        .stat-box-value {
            font-size: 1.5rem;
            margin-top: 4px;
        }
    }

    /* Bereichs-Hintergründe */
    .section-bg-overview {
        background: linear-gradient(to bottom, rgba(91, 155, 213, 0.03) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-supermarkt {
        background: linear-gradient(to bottom, rgba(52, 168, 83, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-haushalt {
        background: linear-gradient(to bottom, rgba(91, 155, 213, 0.04) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-wohnung {
        background: linear-gradient(to bottom, rgba(237, 125, 49, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-restaurant {
        background: linear-gradient(to bottom, rgba(132, 151, 176, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-gesundheit {
        background: linear-gradient(to bottom, rgba(255, 192, 0, 0.06) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-freizeit {
        background: linear-gradient(to bottom, rgba(112, 173, 71, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-geschenke {
        background: linear-gradient(to bottom, rgba(68, 114, 196, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-bg-kfz {
        background: linear-gradient(to bottom, rgba(255, 0, 102, 0.05) 0%, rgba(255,255,255,0) 100%);
    }

    .section-wrapper {
        padding: 30px 0;
        margin-left: -15px;
        margin-right: -15px;
        padding-left: 15px;
        padding-right: 15px;
        margin-bottom: 20px;
    }

    
    /* Mobile: Kompaktere Chart-Höhen */
    @media (max-width: 768px) {
        .chart-container-horizontal {
            height: 500px !important;  /* Reduziert von 700px */
            padding-bottom: 10px;
        }
        
        /* Tortendiagramme: Reduziere Canvas-Höhe */
        #categoryPieChart2025,
        #categoryPieChart2024 {
            max-height: 300px !important;
        }
    }

    /* Extra kleine Geräte: Weitere Optimierung */
    @media (max-width: 576px) {
        .chart-container-horizontal {
            height: 450px !important;  /* Reduziert von 800px */
            padding-bottom: 10px;
        }
        
        #categoryPieChart2025,
        #categoryPieChart2024 {
            max-height: 280px !important;
        }
        
        /* Kompaktere Card-Header */
        .card-header h5 {
            font-size: 0.95rem;
        }
        
        .card-header small {
            font-size: 0.8rem;
        }
    }
    
    @media (min-width: 768px) {
        .section-wrapper {
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            padding-left: calc(50vw - 50% + 15px);
            padding-right: calc(50vw - 50% + 15px);
        }
    }
    
    /* Floating Navigation Button */
    .floating-nav-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: all 0.3s ease;
    }

    .floating-nav-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    .floating-nav-btn.show {
        display: flex;
    }

    /* Navigation Overlay */
    .nav-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 1100;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .nav-overlay.show {
        display: block;
        opacity: 1;
    }

    /* Navigation Menu */
    .nav-menu {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        z-index: 1200;
        max-height: 70vh;
        overflow-y: auto;
        transition: bottom 0.3s ease;
        padding: 20px;
    }

    .nav-menu.show {
        bottom: 0;
    }

    .nav-menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .nav-menu-header h5 {
        margin: 0;
        color: #333;
    }

    .nav-close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-menu-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 8px;
        border-radius: 10px;
        background: #f8f9fa;
        border-left: 4px solid;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: #333;
    }

    .nav-menu-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .nav-menu-item i {
        font-size: 20px;
        margin-right: 12px;
        width: 24px;
        text-align: center;
    }

    .nav-menu-item span {
        font-weight: 500;
    }

    /* Desktop: Button verstecken */
    @media (min-width: 992px) {
        .floating-nav-btn {
            display: none !important;
        }
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-house-door"></i> Dashboard Haushalt
            </h1>
            <p class="text-muted mb-0">Visualisierung der Haushaltsausgaben</p>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        <strong>Hinweis:</strong>
        Dieses Dashboard zeigt alle Transaktionen von Robert sowie Sigis Transaktionen mit Flag "Relevant für Haushaltsbudget".
        Transfers, Kursschwankungen und "Ready to Assign" sind ausgeschlossen.
    </div>

    <!-- Gestapeltes Balkendiagramm -->
    <div class="section-wrapper section-bg-overview">
        <div class="row mb-4" id="section-overview">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-fill"></i> Monatliche Ausgaben (Netto)
                        </h5>
                        <small>Gestapelt nach Person</small>
                    </div>
                    <div>
                        <select id="barChartYearSelect" class="form-select form-select-sm">
                            {% for y in available_years %}
                                <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container-horizontal">
                        <canvas id="monthlyStackedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Tortendiagramme -->
    <div class="section-wrapper section-bg-overview">
        <div class="row mb-5" id="section-pie-charts">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2025
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryPieChart2025" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i> Ausgaben nach Kategorie 2024
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryPieChart2024" height="250"></canvas>
                </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- ===== SPECIAL SECTION: SUPERMARKT (Kategorie 1.4. id=5) ===== -->
    <div class="section-wrapper section-bg-supermarkt">
        <div class="row mb-5" id="section-supermarkt">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(52, 168, 83);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> 1.4. Supermarkt - Detailanalyse
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Statistiken -->
                    <div class="stat-box" style="border-left-color: rgb(52, 168, 83);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-supermarket">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <!-- Monatliche Entwicklung mit Trendlinie -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Jahresvergleich 2024 vs 2025 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="supermarketComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- SPECIAL: Kombiniertes Billa-Diagramm -->
                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-bag-check"></i> Billa-Einkäufe: Anzahl & Durchschnittliche Höhe</h5>
                            <p class="text-muted">
                                <small>Balken zeigen die Anzahl der Einkäufe, Linie zeigt die durchschnittliche Einkaufshöhe pro Monat</small>
                            </p>
                            <div class="chart-container-medium">
                                <canvas id="billaCombinedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- ===== END SUPERMARKT SECTION ===== -->

    <!-- 1. Haushaltsausgaben -->
    <div class="section-wrapper section-bg-haushalt">
        <div class="row mb-5" id="section-haushalt">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(91, 155, 213);">
                    <h4 class="mb-0">
                        <i class="bi bi-cart"></i> Haushaltsausgaben
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(91, 155, 213);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-2">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart2"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 2. Wohnung -->
    <div class="section-wrapper section-bg-wohnung">
        <div class="row mb-5" id="section-wohnung">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(237, 125, 49);">
                    <h4 class="mb-0">
                        <i class="bi bi-house"></i> Wohnung
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(237, 125, 49);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-3">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart3"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart3"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart3"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 3. Restaurant & Lieferservice -->
    <div class="section-wrapper section-bg-restaurant">
        <div class="row mb-5" id="section-restaurant">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(132, 151, 176);">
                    <h4 class="mb-0">
                        <i class="bi bi-cup-straw"></i> Restaurant & Lieferservice
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(132, 151, 176);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-4">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart4"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart4"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart4"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 4. Ärzte & Gesundheit -->
    <div class="section-wrapper section-bg-gesundheit">
        <div class="row mb-5" id="section-gesundheit">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 192, 0);">
                    <h4 class="mb-0">
                        <i class="bi bi-heart-pulse"></i> Ärzte & Gesundheit
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 192, 0);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-5">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart5"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart5"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart5"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 5. Freizeit & Hobby & Urlaub -->
    <div class="section-wrapper section-bg-freizeit">
        <div class="row mb-5" id="section-freizeit">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(112, 173, 71);">
                    <h4 class="mb-0">
                        <i class="bi bi-balloon"></i> Freizeit & Hobby & Urlaub
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(112, 173, 71);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-6">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart6"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart6"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart6"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 6. Geschenke -->
    <div class="section-wrapper section-bg-geschenke">
        <div class="row mb-5" id="section-geschenke">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(68, 114, 196);">
                    <h4 class="mb-0">
                        <i class="bi bi-gift"></i> Geschenke
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(68, 114, 196);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-7">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart7"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart7"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart7"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 9. KFZ -->
    <div class="section-wrapper section-bg-kfz">
        <div class="row mb-5" id="section-kfz">
        <div class="col-12">
            <div class="card">
                <div class="categorygroup-header" style="background-color: rgb(255, 0, 102);">
                    <h4 class="mb-0">
                        <i class="bi bi-car-front"></i> KFZ
                    </h4>
                </div>
                <div class="card-body">
                    <div class="stat-box" style="border-left-color: rgb(255, 0, 102);">
                        <div class="row">
                            <div class="col-md-4">
                                <h6 class="text-muted mb-1">Durchschnittliche monatliche Ausgaben</h6>
                                <h3 class="mb-0" id="avg-spending-10">
                                    <span class="spinner-border spinner-border-sm" role="status"></span>
                                </h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-graph-up"></i> Monatliche Entwicklung 2024-2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="trendChart10"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5><i class="bi bi-bar-chart"></i> Jahresvergleich 2024 vs 2025</h5>
                            <div class="chart-container-medium">
                                <canvas id="comparisonChart10"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h5><i class="bi bi-stack"></i> Quartalsweise nach Kategorien</h5>
                            <div class="chart-container-medium">
                                <canvas id="quarterlyChart10"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Link zur Transaktionsliste -->
    <div class="row">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="bi bi-list-ul"></i> Detaillierte Transaktionsansicht
                    </h5>
                    <p class="card-text text-muted">
                        Für eine detaillierte Übersicht aller Haushalt-Transaktionen mit Filtermöglichkeiten.
                    </p>
                    <a href="{% url 'finance:household_transactions' %}" class="btn btn-primary">
                        <i class="bi bi-arrow-right-circle"></i> Zu den Transaktionen
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Navigation Button (nur Mobile) -->
    <button class="floating-nav-btn" id="floatingNavBtn" aria-label="Navigation öffnen">
        <i class="bi bi-list"></i>
    </button>

    <!-- Navigation Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- Navigation Menu -->
    <div class="nav-menu" id="navMenu">
        <div class="nav-menu-header">
            <h5><i class="bi bi-compass"></i> Navigation</h5>
            <button class="nav-close-btn" id="navCloseBtn" aria-label="Menü schließen">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <a href="#section-overview" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-overview">
            <i class="bi bi-bar-chart-fill" style="color: rgb(91, 155, 213);"></i>
            <span>Übersicht Monatlich</span>
        </a>

        <a href="#section-pie-charts" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-pie-charts">
            <i class="bi bi-pie-chart-fill" style="color: rgb(91, 155, 213);"></i>
            <span>Kategorien 2024/2025</span>
        </a>

        <a href="#section-supermarkt" class="nav-menu-item" style="border-left-color: rgb(52, 168, 83);" data-section="section-supermarkt">
            <i class="bi bi-cart" style="color: rgb(52, 168, 83);"></i>
            <span>Supermarkt</span>
        </a>

        <a href="#section-haushalt" class="nav-menu-item" style="border-left-color: rgb(91, 155, 213);" data-section="section-haushalt">
            <i class="bi bi-cart" style="color: rgb(91, 155, 213);"></i>
            <span>Haushaltsausgaben</span>
        </a>

        <a href="#section-wohnung" class="nav-menu-item" style="border-left-color: rgb(237, 125, 49);" data-section="section-wohnung">
            <i class="bi bi-house" style="color: rgb(237, 125, 49);"></i>
            <span>Wohnung</span>
        </a>

        <a href="#section-restaurant" class="nav-menu-item" style="border-left-color: rgb(132, 151, 176);" data-section="section-restaurant">
            <i class="bi bi-cup-straw" style="color: rgb(132, 151, 176);"></i>
            <span>Restaurant & Lieferservice</span>
        </a>

        <a href="#section-gesundheit" class="nav-menu-item" style="border-left-color: rgb(255, 192, 0);" data-section="section-gesundheit">
            <i class="bi bi-heart-pulse" style="color: rgb(255, 192, 0);"></i>
            <span>Ärzte & Gesundheit</span>
        </a>

        <a href="#section-freizeit" class="nav-menu-item" style="border-left-color: rgb(112, 173, 71);" data-section="section-freizeit">
            <i class="bi bi-balloon" style="color: rgb(112, 173, 71);"></i>
            <span>Freizeit & Hobby & Urlaub</span>
        </a>

        <a href="#section-geschenke" class="nav-menu-item" style="border-left-color: rgb(68, 114, 196);" data-section="section-geschenke">
            <i class="bi bi-gift" style="color: rgb(68, 114, 196);"></i>
            <span>Geschenke</span>
        </a>

        <a href="#section-kfz" class="nav-menu-item" style="border-left-color: rgb(255, 0, 102);" data-section="section-kfz">
            <i class="bi bi-car-front" style="color: rgb(255, 0, 102);"></i>
            <span>KFZ</span>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
// ===== BESTEHENDE CHART-VARIABLEN UND FUNKTIONEN =====
let monthlyChart = null;
let pieChart2025 = null;
let pieChart2024 = null;

// ============================================================
// Ersetze die loadMonthlyChart Funktion mit dieser optimierten Version:
// ============================================================

function loadMonthlyChart(year) {
    fetch(`/api/household-monthly-spending/?year=${year}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('monthlyStackedChart').getContext('2d');

            // Destroy existing chart
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: isMobile ? 5 : 10,
                            right: isMobile ? 5 : 10,
                            bottom: isMobile ? 5 : 10,
                            left: isMobile ? 5 : 10
                        }
                    },
                    interaction: {
                        mode: 'index',
                        axis: 'y',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    // Kompaktere Darstellung auf Mobile
                                    if (isMobile) {
                                        return '€' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return '€ ' + value.toLocaleString('de-DE');
                                },
                                font: {
                                    size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                                },
                                maxRotation: 0,
                                autoSkip: true,
                                autoSkipPadding: isMobile ? 10 : 5
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                                },
                                autoSkip: false,
                                // Kürzere Monatsnamen auf Mobile
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    if (isMobile && label.length > 10) {
                                        // Kürze lange Labels
                                        return label.substring(0, 8) + '..';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                font: {
                                    size: isSmallMobile ? 10 : (isMobile ? 11 : 13)
                                },
                                padding: isSmallMobile ? 8 : (isMobile ? 10 : 15),
                                boxWidth: isMobile ? 10 : 15,
                                boxHeight: isMobile ? 10 : 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': € ' +
                                           context.parsed.x.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           });
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.x;
                                    });
                                    return '━━━━━━━━━━━━━━━━\nGesamt: € ' + sum.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    onHover: (event, elements, chart) => {
                        const canvas = event?.native?.target || event?.target;
                        if (canvas) {
                            canvas.style.cursor = elements.length ? 'pointer' : 'default';
                        }
                    },
                    onClick: (event, elements, chart) => {
                        const points = chart.getElementsAtEventForMode(
                            event,
                            'index',
                            { intersect: false, axis: 'y' },
                            true
                        );

                        if (points.length) {
                            const { x, y } = points[0].element;
                            chart.tooltip.setActiveElements(points, { x, y });
                            chart.setActiveElements(points);
                        } else {
                            chart.tooltip.setActiveElements([], { x: 0, y: 0 });
                            chart.setActiveElements([]);
                        }

                        chart.update();
                    }
                }
            });
        })
        .catch(error => {
            console.error('Fehler beim Laden der monatlichen Daten:', error);
        });
}

function loadPieChart(year, canvasId, chartVariable) {
    fetch(`/api/household-category-breakdown/?year=${year}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (chartVariable === '2025' && pieChart2025) {
                pieChart2025.destroy();
            } else if (chartVariable === '2024' && pieChart2024) {
                pieChart2024.destroy();
            }

            // Mobile Detection
            const isMobile = window.innerWidth < 768;
            const isSmallMobile = window.innerWidth < 576;

            const newChart = new Chart(ctx, {
                type: isMobile ? 'doughnut' : 'pie',  // Doughnut auf Mobile
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: isMobile ? '50%' : '0%',  // ← HIER: auf options-Ebene!
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'top' : 'bottom',
                            align: 'center',
                            labels: {
                                padding: isMobile ? 6 : 15,
                                font: {
                                    size: isSmallMobile ? 8 : (isMobile ? 9 : 11)
                                },
                                boxWidth: isMobile ? 10 : 15,
                                boxHeight: isMobile ? 10 : 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(0);
                                            
                                            // Kürzere Labels auf Mobile
                                            let shortLabel = label;
                                            if (isMobile) {
                                                const labelMap = {
                                                    'Haushaltsausgaben': 'Haushalt',
                                                    'Wohnung': 'Wohnung',
                                                    'Restaurant & Lieferservice': 'Restaurant',
                                                    'Ärzte & Gesundheit': 'Gesundheit',
                                                    'Freizeit & Hobby & Urlaub': 'Freizeit',
                                                    'Geschenke': 'Geschenke',
                                                    'KFZ': 'KFZ'
                                                };
                                                shortLabel = labelMap[label] || label;
                                            }
                                            
                                            return {
                                                text: `${shortLabel} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i,
                                                lineWidth: 0
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 11 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    if (isMobile) {
                                        return `${label}: €${Math.round(value).toLocaleString('de-DE')} (${percentage}%)`;
                                    }
                                    return label + ': € ' +
                                           value.toLocaleString('de-DE', {
                                               minimumFractionDigits: 2,
                                               maximumFractionDigits: 2
                                           }) +
                                           ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 0,
                            bottom: isMobile ? 10 : 0,
                            left: 0,
                            right: isMobile ? 5 : 0  // Weniger Padding rechts auf Mobile
                        }
                    }
                }
            });

            if (chartVariable === '2025') {
                pieChart2025 = newChart;
            } else if (chartVariable === '2024') {
                pieChart2024 = newChart;
            }
        })
        .catch(error => {
            console.error(`Fehler beim Laden der Kategoriedaten für ${year}:`, error);
        });
}

// ===== NEUE CATEGORYGROUP CHARTS =====

const categoryGroups = [2, 3, 4, 5, 6, 7, 10];

// Farbschema für jeden Bereich
const groupColors = {
    2: { // Haushaltsausgaben
        primary: 'rgb(91, 155, 213)',
        primaryAlpha: 'rgba(91, 155, 213, 0.7)',
        secondary: 'rgb(91, 155, 213)',
        secondaryAlpha: 'rgba(91, 155, 213, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    3: { // Wohnung
        primary: 'rgb(237, 125, 49)',
        primaryAlpha: 'rgba(237, 125, 49, 0.7)',
        secondary: 'rgb(237, 125, 49)',
        secondaryAlpha: 'rgba(237, 125, 49, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    4: { // Restaurant
        primary: 'rgb(132, 151, 176)',
        primaryAlpha: 'rgba(132, 151, 176, 0.7)',
        secondary: 'rgb(132, 151, 176)',
        secondaryAlpha: 'rgba(132, 151, 176, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    5: { // Gesundheit
        primary: 'rgb(255, 192, 0)',
        primaryAlpha: 'rgba(255, 192, 0, 0.7)',
        secondary: 'rgb(255, 192, 0)',
        secondaryAlpha: 'rgba(255, 192, 0, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    6: { // Freizeit
        primary: 'rgb(112, 173, 71)',
        primaryAlpha: 'rgba(112, 173, 71, 0.7)',
        secondary: 'rgb(112, 173, 71)',
        secondaryAlpha: 'rgba(112, 173, 71, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    7: { // Geschenke
        primary: 'rgb(68, 114, 196)',
        primaryAlpha: 'rgba(68, 114, 196, 0.7)',
        secondary: 'rgb(68, 114, 196)',
        secondaryAlpha: 'rgba(68, 114, 196, 0.25)',
        trend: 'rgb(255, 99, 132)'
    },
    10: { // KFZ
        primary: 'rgb(255, 0, 102)',
        primaryAlpha: 'rgba(255, 0, 102, 0.7)',
        secondary: 'rgb(255, 0, 102)',
        secondaryAlpha: 'rgba(255, 0, 102, 0.25)',
        trend: 'rgb(255, 99, 132)'
    }
};

function formatEuro(value) {
    return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function loadCategoryGroupStats() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-stats/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`avg-spending-${groupId}`).innerHTML = formatEuro(data.monthly_average);
            })
            .catch(error => {
                console.error(`Error loading stats for group ${groupId}:`, error);
                document.getElementById(`avg-spending-${groupId}`).innerHTML = '<span class="text-danger">Fehler</span>';
            });
    });
}

function createTrendCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-monthly-trend/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`trendChart${groupId}`).getContext('2d');
                const colors = groupColors[groupId];

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Ausgaben',
                                data: data.data,
                                borderColor: colors.primary,
                                backgroundColor: colors.primaryAlpha,
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Trend',
                                data: data.trend_data,
                                borderColor: colors.trend,
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating trend chart ${groupId}:`, error));
    });
}

function createComparisonCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-year-comparison/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`comparisonChart${groupId}`).getContext('2d');
                const colors = groupColors[groupId];

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '2025',
                                data: data.data_2025,
                                backgroundColor: colors.primaryAlpha,
                                borderColor: colors.primary,
                                borderWidth: 1
                            },
                            {
                                label: '2024',
                                data: data.data_2024,
                                backgroundColor: colors.secondaryAlpha,
                                borderColor: colors.secondary,
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating comparison chart ${groupId}:`, error));
    });
}

function createQuarterlyCharts() {
    categoryGroups.forEach(groupId => {
        fetch(`/api/categorygroup-quarterly-breakdown/?group_id=${groupId}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById(`quarterlyChart${groupId}`).getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatEuro(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatEuro(value);
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error(`Error creating quarterly chart ${groupId}:`, error));
    });
}

// ===== SUPERMARKT-BEREICH FUNCTIONS =====

function loadSupermarketStats() {
    fetch('/api/supermarket-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('avg-spending-supermarket').innerHTML = formatEuro(data.monthly_average);
        })
        .catch(error => {
            console.error('Error loading supermarket stats:', error);
            document.getElementById('avg-spending-supermarket').innerHTML = '<span class="text-danger">Fehler</span>';
        });
}

function createSupermarketTrendChart() {
    fetch('/api/supermarket-monthly-trend/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketTrendChart').getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Ausgaben',
                            data: data.data,
                            borderColor: 'rgb(52, 168, 83)',
                            backgroundColor: 'rgba(52, 168, 83, 0.3)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Trend',
                            data: data.trend_data,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatEuro(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket trend chart:', error));
}

function createSupermarketComparisonChart() {
    fetch('/api/supermarket-year-comparison/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('supermarketComparisonChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatEuro(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading supermarket comparison chart:', error));
}

function createBillaCombinedChart() {
    fetch('/api/billa-combined-chart/')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('billaCombinedChart').getContext('2d');
            
            // Mobile Detection
            const isMobile = window.innerWidth < 768;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: isMobile ? 'Anzahl' : 'Anzahl Einkäufe',
                            data: data.count_data,
                            backgroundColor: 'rgba(52, 168, 83, 0.6)',
                            borderColor: 'rgb(52, 168, 83)',
                            borderWidth: isMobile ? 1 : 1,
                            yAxisID: 'y-count',
                            order: 2
                        },
                        {
                            label: isMobile ? 'Ø Höhe' : 'Durchschnittliche Einkaufshöhe',
                            data: data.avg_data,
                            type: 'line',
                            borderColor: 'rgb(30,122,54)',
                            backgroundColor: 'rgba(52, 168, 83, 0.2)',
                            borderWidth: isMobile ? 2 : 3,
                            pointRadius: isMobile ? 6 : 5,  // Größere Touch-Targets
                            pointHoverRadius: isMobile ? 8 : 7,
                            pointBackgroundColor: 'rgb(52, 168, 83)',
                            tension: 0.4,
                            yAxisID: 'y-avg',
                            order: 1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: isMobile ? 'bottom' : 'top',  // Legende unten auf Mobile
                            labels: {
                                padding: isMobile ? 10 : 15,
                                font: {
                                    size: isMobile ? 11 : 12
                                },
                                boxWidth: isMobile ? 30 : 40
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            padding: isMobile ? 8 : 12,
                            titleFont: {
                                size: isMobile ? 12 : 13
                            },
                            bodyFont: {
                                size: isMobile ? 11 : 12
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-count') {
                                        label += context.parsed.y + (isMobile ? 'x' : ' Einkäufe');
                                    } else {
                                        label += formatEuro(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 11
                                },
                                maxRotation: isMobile ? 45 : 0,  // Drehe Labels auf Mobile
                                minRotation: isMobile ? 45 : 0,
                                autoSkip: true,
                                autoSkipPadding: isMobile ? 20 : 10
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: isMobile ? 10 : 11
                                },
                                callback: function(value) {
                                    return value + 'x';
                                }
                            },
                            title: {
                                display: !isMobile,  // Verberge Titel auf Mobile
                                text: 'Anzahl Einkäufe',
                                font: {
                                    size: isMobile ? 11 : 12
                                }
                            }
                        },
                        'y-avg': {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 10 : 11
                                },
                                callback: function(value) {
                                    // Kürzeres Format auf Mobile
                                    return isMobile ? '€' + Math.round(value) : formatEuro(value);
                                }
                            },
                            title: {
                                display: !isMobile,  // Verberge Titel auf Mobile
                                text: 'Durchschnittliche Einkaufshöhe',
                                font: {
                                    size: isMobile ? 11 : 12
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading Billa combined chart:', error));
}

// Initialisierung beim Laden der Seite
document.addEventListener('DOMContentLoaded', function() {
    // Lade bestehende Charts (Balken und Tortendiagramme)
    loadMonthlyChart({{ current_year }});
    loadPieChart(2025, 'categoryPieChart2025', '2025');
    loadPieChart(2024, 'categoryPieChart2024', '2024');

    // Event Listener für Jahr-Wechsel beim Balkendiagramm
    document.getElementById('barChartYearSelect').addEventListener('change', function() {
        loadMonthlyChart(this.value);
    });

    // Lade alle CategoryGroup Daten
    loadCategoryGroupStats();
    createTrendCharts();
    createComparisonCharts();
    createQuarterlyCharts();

    // Supermarkt-Bereich laden
    loadSupermarketStats();
    createSupermarketTrendChart();
    createSupermarketComparisonChart();
    createBillaCombinedChart();

    // === Floating Navigation ===
    const floatingBtn = document.getElementById('floatingNavBtn');
    const navOverlay = document.getElementById('navOverlay');
    const navMenu = document.getElementById('navMenu');
    const navCloseBtn = document.getElementById('navCloseBtn');
    const navMenuItems = document.querySelectorAll('.nav-menu-item');

    // Zeige Button beim Scrollen
    window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
            floatingBtn.classList.add('show');
        } else {
            floatingBtn.classList.remove('show');
        }
    });

    // Öffne Navigation
    floatingBtn.addEventListener('click', function() {
        navOverlay.classList.add('show');
        navMenu.classList.add('show');
        document.body.style.overflow = 'hidden';
    });

    // Schließe Navigation
    function closeNav() {
        navOverlay.classList.remove('show');
        navMenu.classList.remove('show');
        document.body.style.overflow = '';
    }

    navCloseBtn.addEventListener('click', closeNav);
    navOverlay.addEventListener('click', closeNav);

    // Navigation zu Bereichen
    navMenuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-section');
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                closeNav();

                // Smooth scroll mit Offset für Header
                const yOffset = -80;
                const y = targetElement.getBoundingClientRect().top + window.pageYOffset + yOffset;

                window.scrollTo({
                    top: y,
                    behavior: 'smooth'
                });
            }
        });
    });
});
</script>
{% endblock %}