{% extends 'finance/base.html' %}
{% load static %}

{% block title %}Preisentwicklung - Überkategorien{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'finance:billa_dashboard' %}">Billa</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'finance:billa_preisentwicklung_uebersicht' %}">Preisentwicklung</a>
            </li>
            <li class="breadcrumb-item active">Überkategorien</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-layers-fill"></i> Preisentwicklung nach Überkategorien</h1>
        <a href="{% url 'finance:billa_preisentwicklung_uebersicht' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Zurück
        </a>
    </div>

    <!-- Info -->
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i>
        Diese Ansicht zeigt die durchschnittliche Preisentwicklung aller Produkte pro Überkategorie.
    </div>

    <!-- Überkategorien Grid -->
    <div class="row">
        {% for kat in ueberkategorien %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card shadow-sm h-100 hover-card">
                <div class="card-header bg-primary bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-tag-fill"></i> {{ kat.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Statistiken -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="stat-mini">
                                <div class="stat-value">{{ kat.anzahl_produkte }}</div>
                                <div class="stat-label">Produkte</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-mini">
                                <div class="stat-value">{{ kat.anzahl_kaeufe }}</div>
                                <div class="stat-label">Käufe</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-mini">
                                <div class="stat-value text-danger">
                                    {{ kat.diff_pct|floatformat:1 }}%
                                </div>
                                <div class="stat-label">Änderung</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mini Chart -->
                    <canvas id="chart-{{ forloop.counter }}" height="150"></canvas>

                    <!-- Preis-Info -->
                    <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                        <div class="text-center">
                            <small class="text-muted">Min. Preis</small>
                            <div class="fw-bold text-success">€{{ kat.min_preis|floatformat:2 }}</div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">Max. Preis</small>
                            <div class="fw-bold text-danger">€{{ kat.max_preis|floatformat:2 }}</div>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">Differenz</small>
                            <div class="fw-bold">€{{ kat.diff|floatformat:2 }}</div>
                        </div>
                    </div>

                    <!-- Link -->
                    <div class="mt-3">
                        <a href="{% url 'finance:billa_preisentwicklung_ueberkategorie' kat.name %}" 
                           class="btn btn-primary w-100">
                            <i class="bi bi-arrow-right-circle"></i> Details anzeigen
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<style>
.hover-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
.stat-mini {
    padding: 10px;
}
.stat-mini .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}
.stat-mini .stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ueberkategorien = {{ ueberkategorien|safe }};
    
    ueberkategorien.forEach((kat, index) => {
        const ctx = document.getElementById('chart-' + (index + 1));
        if (!ctx) return;
        
        const dates = kat.preis_historie.map(h => h.datum);
        const prices = kat.preis_historie.map(h => h.durchschnitt);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Ø Preis',
                    data: prices,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '€' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    });
});
</script>

{% endblock %}