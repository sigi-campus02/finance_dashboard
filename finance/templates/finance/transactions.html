{% extends 'finance/base.html' %}
{% load finance_filters %}

{% block title %}Transaktionen - Finance{% endblock %}

{% block extra_css %}
<style>
    .memo-cell {
        max-width: 300px;
        word-wrap: break-word;
        white-space: normal;
    }
    .action-icon {
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.2s;
    }
    .action-icon:hover {
        transform: scale(1.2);
    }
    
    .date-cell {
        cursor: pointer;
        position: relative;
    }
    .date-cell:hover .date-display {
        background-color: #f8f9fa;
        padding: 2px 5px;
        border-radius: 3px;
    }
    .date-input {
        width: 140px;
    }
    .date-cell.editing .date-display {
        display: none !important;
    }
    .date-cell.editing .date-input {
        display: block !important;
    }
    
</style>
    
{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Transaktionen</h1>

<!-- Statistik Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card kpi-card transactions">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Anzahl Transaktionen</h6>
                <h4 class="card-title mb-0">{{ transaction_count }}</h4>
                <small class="text-muted">
                    {% if excluded_count > 0 %}
                        Inkl. {{ transfer_count }} Transfer(s) & {{ kursschwankung_count }} Kursschwankung(en)
                    {% else %}
                        Gefilterte Transaktionen
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card kpi-card income">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Gesamteinnahmen</h6>
                <h4 class="card-title mb-0">€ {{ total_inflow|floatformat:2 }}</h4>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Nur "Inflow - Ready to Assign"
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card kpi-card expense">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Gesamtausgaben (Netto)</h6>
                <h4 class="card-title mb-0">€ {{ total_outflow|floatformat:2 }}</h4>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Outflow - Inflow (exkl. Ready to Assign)
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card kpi-card balance">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Saldo</h6>
                <h4 class="card-title mb-0" style="color: {% if netto >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                    € {{ netto|floatformat:2 }}
                </h4>
                <small class="text-muted">
                    Einnahmen - Ausgaben
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-2">
                <label class="form-label">Jahr</label>
                <select name="year" class="form-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="">Alle</option>
                    {% for y in years %}
                    <option value="{{ y }}" {% if selected_year and y == selected_year|add:"0" %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Monat</label>
                <select name="month" class="form-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="">Alle</option>
                    <option value="1" {% if selected_month == "1" %}selected{% endif %}>Jänner</option>
                    <option value="2" {% if selected_month == "2" %}selected{% endif %}>Februar</option>
                    <option value="3" {% if selected_month == "3" %}selected{% endif %}>März</option>
                    <option value="4" {% if selected_month == "4" %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month == "5" %}selected{% endif %}>Mai</option>
                    <option value="6" {% if selected_month == "6" %}selected{% endif %}>Juni</option>
                    <option value="7" {% if selected_month == "7" %}selected{% endif %}>Juli</option>
                    <option value="8" {% if selected_month == "8" %}selected{% endif %}>August</option>
                    <option value="9" {% if selected_month == "9" %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month == "10" %}selected{% endif %}>Oktober</option>
                    <option value="11" {% if selected_month == "11" %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month == "12" %}selected{% endif %}>Dezember</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Konto</label>
                <select name="account" class="form-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="">Alle</option>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}" {% if selected_account and acc.id == selected_account|add:"0" %}selected{% endif %}>
                        {{ acc.account }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Kategorie</label>
                <select name="category" class="form-select" onchange="document.getElementById('filterForm').submit()">
                    <option value="">Alle</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if selected_category and cat.id == selected_category|add:"0" %}selected{% endif %}>
                        {{ cat.category }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Suche</label>
                <input type="text" name="search" class="form-control" placeholder="Payee oder Memo" value="{{ search_query|default:'' }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filtern
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tabelle -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Konto</th>
                        <th>Payee</th>
                        <th>Kategorie</th>
                        <th>Memo</th>
                        <th class="text-end">Ausgaben</th>
                        <th class="text-end">Einnahmen</th>
                        <th class="text-center">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in transactions %}
                    <tr {% if trans.payee.payee_type == 'transfer' or trans.payee.payee_type == 'kursschwankung' %}class="table-secondary" style="opacity: 0.6;"{% endif %}>
                        <td class="date-cell" data-transaction-id="{{ trans.id }}">
                            <span class="date-display">{{ trans.date|date:"d.m.Y" }}</span>
                            <input type="date" 
                                   class="form-control form-control-sm date-input" 
                                   value="{{ trans.date|date:'Y-m-d' }}" 
                                   style="display: none;">
                        </td>
                        <td>
                            {% if trans.account %}
                            <i class="bi bi-{{ trans.account.account|account_icon }} text-muted"></i>
                            {{ trans.account }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {{ trans.payee|default:"-" }}
                            {% if trans.payee.payee_type == 'transfer' %}
                                <span class="badge bg-secondary" title="Transfer zwischen Konten - nicht in Statistiken">
                                    <i class="bi bi-arrow-left-right"></i> Transfer
                                </span>
                            {% elif trans.payee.payee_type == 'kursschwankung' %}
                                <span class="badge bg-info" title="Kursschwankung bei Investments - nicht in Statistiken">
                                    <i class="bi bi-graph-up-arrow"></i> Kursschwankung
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ trans.category.categorygroup|default:"-" }}</small><br>
                            {{ trans.category|default:"-" }}
                        </td>
                        <td class="memo-cell"><small>{{ trans.memo|default:"-" }}</small></td>
                        <td class="text-end text-danger">
                            {% if trans.outflow %}€ {{ trans.outflow|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="text-end text-success">
                            {% if trans.inflow %}€ {{ trans.inflow|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            <i class="bi bi-trash text-danger action-icon" 
                               data-bs-toggle="modal" 
                               data-bs-target="#deleteModal"
                               data-transaction-id="{{ trans.id }}"
                               data-transaction-date="{{ trans.date|date:'d.m.Y' }}"
                               data-transaction-payee="{{ trans.payee|default:'Unbekannt' }}"
                               data-transaction-amount="€ {{ trans.outflow|default:trans.inflow|floatformat:2 }}"
                               data-transaction-category="{{ trans.category|default:'Unbekannt' }}"
                               title="Löschen"></i>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">Keine Transaktionen gefunden</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr class="fw-bold">
                        <td colspan="5" class="text-end">Summe (gefiltert):</td>
                        <td class="text-end text-danger">€ {{ total_outflow|floatformat:2 }}</td>
                        <td class="text-end text-success">€ {{ total_inflow|floatformat:2 }}</td>
                        <td></td>
                    </tr>
                    <tr class="fw-bold">
                        <td colspan="5" class="text-end">Saldo:</td>
                        <td colspan="2" class="text-end" style="color: {% if netto >= 0 %}#28a745{% else %}#dc3545{% endif %}">
                            € {{ netto|floatformat:2 }}
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% if transaction_count > 100 %}
<div class="alert alert-info mt-3" role="alert">
    <i class="bi bi-info-circle"></i>
    <strong>Hinweis:</strong>
    Es werden die ersten 100 Transaktionen angezeigt. Die Statistiken basieren auf allen {{ transaction_count }} gefilterten Transaktionen.
    <br>
    <strong>Statistik-Regeln:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>Einnahmen:</strong> Nur Kategorie "Inflow - Ready to Assign" (ohne Transfers & Kursschwankungen)</li>
        <li><strong>Ausgaben (Netto):</strong> Outflow - Inflow für alle anderen Kategorien (ohne Transfers, Kursschwankungen & Ready to Assign)</li>
        <li><strong>Saldo:</strong> Einnahmen - Ausgaben (Netto)</li>
    </ul>
</div>
{% elif excluded_count > 0 %}
<div class="alert alert-info mt-3" role="alert">
    <i class="bi bi-info-circle"></i>
    <strong>Statistik-Regeln:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>Einnahmen:</strong> Nur Kategorie "Inflow - Ready to Assign" (ohne Transfers & Kursschwankungen)</li>
        <li><strong>Ausgaben (Netto):</strong> Outflow - Inflow für alle anderen Kategorien (ohne Transfers, Kursschwankungen & Ready to Assign)</li>
        <li><strong>Saldo:</strong> Einnahmen - Ausgaben (Netto)</li>
    </ul>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Transaktion löschen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Möchten Sie diese Transaktion wirklich löschen?</p>
                <div class="card">
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Datum:</dt>
                            <dd class="col-sm-8" id="modal-date">-</dd>
                            
                            <dt class="col-sm-4">Payee:</dt>
                            <dd class="col-sm-8" id="modal-payee">-</dd>
                            
                            <dt class="col-sm-4">Kategorie:</dt>
                            <dd class="col-sm-8" id="modal-category">-</dd>
                            
                            <dt class="col-sm-4">Betrag:</dt>
                            <dd class="col-sm-8 fw-bold" id="modal-amount">-</dd>
                        </dl>
                    </div>
                </div>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> Sie haben 30 Sekunden Zeit, um die Löschung rückgängig zu machen.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Abbrechen
                </button>
                <form method="post" action="" id="deleteForm" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Ja, löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Modal mit Transaktionsdaten befüllen
document.addEventListener('DOMContentLoaded', function() {
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        var button = event.relatedTarget;
        
        var transactionId = button.getAttribute('data-transaction-id');
        var date = button.getAttribute('data-transaction-date');
        var payee = button.getAttribute('data-transaction-payee');
        var amount = button.getAttribute('data-transaction-amount');
        var category = button.getAttribute('data-transaction-category');
        
        document.getElementById('modal-date').textContent = date;
        document.getElementById('modal-payee').textContent = payee;
        document.getElementById('modal-amount').textContent = amount;
        document.getElementById('modal-category').textContent = category;
        
        document.getElementById('deleteForm').action = '/transactions/delete/' + transactionId + '/';
    });
});

// Datum-Inline-Bearbeitung
document.addEventListener('DOMContentLoaded', function() {
    // Alle Datumszellen
    const dateCells = document.querySelectorAll('.date-cell');
    
    dateCells.forEach(cell => {
        const display = cell.querySelector('.date-display');
        const input = cell.querySelector('.date-input');
        const transactionId = cell.dataset.transactionId;
        
        // Klick auf Datum → Edit-Mode
        display.addEventListener('click', function() {
            cell.classList.add('editing');
            input.focus();
        });
        
        // Datum geändert → Speichern
        input.addEventListener('change', async function() {
            const newDate = input.value;
            
            try {
                const response = await fetch(`/transactions/update-date/${transactionId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ date: newDate })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update Display
                    display.textContent = data.new_date;
                    cell.classList.remove('editing');
                    
                    // Success Toast
                    showToast('success', data.message);
                } else {
                    // Error
                    showToast('danger', data.error || 'Fehler beim Speichern');
                    // Reset input
                    input.value = input.defaultValue;
                    cell.classList.remove('editing');
                }
            } catch (error) {
                showToast('danger', 'Netzwerkfehler: ' + error.message);
                input.value = input.defaultValue;
                cell.classList.remove('editing');
            }
        });
        
        // Abbrechen bei Blur (wenn nicht geändert)
        input.addEventListener('blur', function() {
            setTimeout(() => {
                cell.classList.remove('editing');
            }, 200);
        });
        
        // ESC zum Abbrechen
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                input.value = input.defaultValue;
                cell.classList.remove('editing');
            }
        });
    });
});

// Toast-Notification Helper
function showToast(type, message) {
    const toastContainer = document.querySelector('.toast-container');
    
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0 show" 
             role="alert" aria-live="assertive" aria-atomic="true"
             data-bs-autohide="true" data-bs-delay="3000">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Entferne nach dem Ausblenden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}


</script>
{% endblock %}