{% extends 'finance/base.html' %}

{% block title %}Vermögensübersicht - Finance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Vermögensübersicht</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <form method="get" class="d-flex">
                <input type="month" name="date" class="form-control" 
                       value="{{ current_date|date:'Y-m' }}" 
                       onchange="this.form.submit()">
            </form>
        </div>
    </div>
</div>

<!-- Gesamtsummen Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h6 class="text-muted">Aktueller Gesamtwert</h6>
                        <h3 class="mb-0">€ {{ total_current|floatformat:2 }}</h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Vormonat</h6>
                        <h4 class="mb-0">€ {{ total_prev_month|floatformat:2 }}</h4>
                        {% if total_delta_month %}
                        <small class="{% if total_delta_month >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if total_delta_month >= 0 %}+{% endif %}{{ total_delta_month|floatformat:1 }}%
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Vorjahr</h6>
                        <h4 class="mb-0">€ {{ total_prev_year|floatformat:2 }}</h4>
                        {% if total_delta_year %}
                        <small class="{% if total_delta_year >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if total_delta_year >= 0 %}+{% endif %}{{ total_delta_year|floatformat:1 }}%
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Stichtag</h6>
                        <h4 class="mb-0">{{ current_date|date:"F Y" }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detaillierte Übersicht -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead class="table-primary">
                    <tr>
                        <th>Zeilenbeschriftungen</th>
                        <th class="text-end">Kontostand</th>
                        <th class="text-end">Kontostand Vormonat</th>
                        <th class="text-end">Δ</th>
                        <th class="text-end">Kontostand Vorjahr</th>
                        <th class="text-end">Δ Vorjahr</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                    <!-- Kategorie Header -->
                        <tr class="table-secondary fw-bold">
                            <td>
                                {% if category.color_rgb %}
                                    <span style="display: inline-block; width: 4px; height: 16px;
                                        background-color: {{ category.color_rgb }};
                                        margin-right: 8px; border-radius: 2px;
                                        vertical-align: middle;"></span>
                                {% endif %}
                                <i class="bi bi-folder"></i> {{ category.display_name }}
                            </td>
                        <td class="text-end">€ {{ category.total_current|floatformat:2 }}</td>
                        <td class="text-end">€ {{ category.total_prev_month|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if category.delta_month %}
                            <span class="badge {% if category.delta_month >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if category.delta_month >= 0 %}+{% endif %}{{ category.delta_month|floatformat:1 }}%
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">€ {{ category.total_prev_year|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if category.delta_year %}
                            <span class="badge {% if category.delta_year >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if category.delta_year >= 0 %}+{% endif %}{{ category.delta_year|floatformat:1 }}%
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    
                    <!-- Positionen unter der Kategorie -->
                    {% for position in category.positions %}
                    <tr>
                        <td class="ps-4">
                            <i class="bi bi-{{ position.icon }}"></i> {{ position.name }}
                        </td>
                        <td class="text-end">€ {{ position.current_balance|floatformat:2 }}</td>
                        <td class="text-end">€ {{ position.prev_month_balance|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if position.delta_month %}
                            <small class="{% if position.delta_month >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if position.delta_month >= 0 %}+{% endif %}{{ position.delta_month|floatformat:1 }}%
                            </small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">€ {{ position.prev_year_balance|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if position.delta_year %}
                            <small class="{% if position.delta_year >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if position.delta_year >= 0 %}+{% endif %}{{ position.delta_year|floatformat:1 }}%
                            </small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                    
                    <!-- Gesamtergebnis -->
                    <tr class="table-dark fw-bold">
                        <td>Gesamtergebnis</td>
                        <td class="text-end">€ {{ total_current|floatformat:2 }}</td>
                        <td class="text-end">€ {{ total_prev_month|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if total_delta_month %}
                            <span class="badge {% if total_delta_month >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if total_delta_month >= 0 %}+{% endif %}{{ total_delta_month|floatformat:1 }}%
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-end">€ {{ total_prev_year|floatformat:2 }}</td>
                        <td class="text-end">
                            {% if total_delta_year %}
                            <span class="badge {% if total_delta_year >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if total_delta_year >= 0 %}+{% endif %}{{ total_delta_year|floatformat:1 }}%
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Historisches Liniendiagramm -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up"></i> Vermögensentwicklung (letzte 24 Monate)
                </h6>
                <small class="text-muted">Gestackte Ansicht nach Kategorien</small>
            </div>
            <div class="card-body">
                <canvas id="assetHistoryChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detail-Diagramme pro Kategorie -->
<div class="row mt-4">
    <!-- Cash Detail -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-wallet2"></i> Cash - Kontendetails
                </h6>
            </div>
            <div class="card-body">
                <canvas id="cashDetailChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- MidtermInvest Detail -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i> MidtermInvest - Kontendetails
                </h6>
            </div>
            <div class="card-body">
                <canvas id="midtermDetailChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- LongtermInvest Detail -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">
                    <i class="bi bi-shield-check"></i> LongtermInvest - Kontendetails
                </h6>
            </div>
            <div class="card-body">
                <canvas id="longtermDetailChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Gemeinsame Chart-Optionen für alle Detail-Charts
function getStackedChartOptions(yAxisLabel) {
    return {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                beginAtZero: true,
                stacked: true,
                ticks: {
                    callback: function(value) {
                        return '€ ' + value.toLocaleString('de-DE', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    },
                    font: {
                        size: 10
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: true,
                    maxTicksLimit: 8,
                    font: {
                        size: 9
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 8,
                    font: {
                        size: 10
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        return label;
                    },
                    footer: function(tooltipItems) {
                        let sum = 0;
                        tooltipItems.forEach(function(tooltipItem) {
                            sum += tooltipItem.parsed.y;
                        });
                        return '━━━━━━━━━━━━━━━━━━\nGesamt: € ' +
                            sum.toLocaleString('de-DE', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                    }
                }
            },
            filler: {
                propagate: false
            }
        }
    };
}

// Haupt-Chart: Gesamtübersicht
fetch("{% url 'finance:api_asset_history' %}")
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('assetHistoryChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: true,
                        ticks: {
                            callback: function(value) {
                                return '€ ' + value.toLocaleString('de-DE', {
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                });
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 12
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€ ' + context.parsed.y.toLocaleString('de-DE', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                return label;
                            },
                            footer: function(tooltipItems) {
                                let sum = 0;
                                tooltipItems.forEach(function(tooltipItem) {
                                    if (tooltipItem.dataset.label !== 'Gesamt') {
                                        sum += tooltipItem.parsed.y;
                                    }
                                });
                                return '━━━━━━━━━━━━━━━━━━\nKategorien Summe: € ' +
                                    sum.toLocaleString('de-DE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                            }
                        }
                    },
                    filler: {
                        propagate: false
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Fehler beim Laden der Vermögensdaten:', error);
        document.getElementById('assetHistoryChart').parentElement.innerHTML =
            '<div class="alert alert-danger">Fehler beim Laden der Daten</div>';
    });

// Detail-Charts: Kategorien mit einzelnen Accounts
fetch("{% url 'finance:api_asset_category_details' %}")
    .then(response => response.json())
    .then(data => {
        // Cash Detail Chart
        if (data.Cash && data.Cash.datasets.length > 0) {
            const cashCtx = document.getElementById('cashDetailChart').getContext('2d');
            new Chart(cashCtx, {
                type: 'line',
                data: {
                    labels: data.Cash.labels,
                    datasets: data.Cash.datasets
                },
                options: getStackedChartOptions('Cash')
            });
        } else {
            document.getElementById('cashDetailChart').parentElement.innerHTML =
                '<p class="text-muted text-center">Keine Daten verfügbar</p>';
        }

        // MidtermInvest Detail Chart
        if (data.MidtermInvest && data.MidtermInvest.datasets.length > 0) {
            const midtermCtx = document.getElementById('midtermDetailChart').getContext('2d');
            new Chart(midtermCtx, {
                type: 'line',
                data: {
                    labels: data.MidtermInvest.labels,
                    datasets: data.MidtermInvest.datasets
                },
                options: getStackedChartOptions('MidtermInvest')
            });
        } else {
            document.getElementById('midtermDetailChart').parentElement.innerHTML =
                '<p class="text-muted text-center">Keine Daten verfügbar</p>';
        }

        // LongtermInvest Detail Chart
        if (data.LongtermInvest && data.LongtermInvest.datasets.length > 0) {
            const longtermCtx = document.getElementById('longtermDetailChart').getContext('2d');
            new Chart(longtermCtx, {
                type: 'line',
                data: {
                    labels: data.LongtermInvest.labels,
                    datasets: data.LongtermInvest.datasets
                },
                options: getStackedChartOptions('LongtermInvest')
            });
        } else {
            document.getElementById('longtermDetailChart').parentElement.innerHTML =
                '<p class="text-muted text-center">Keine Daten verfügbar</p>';
        }
    })
    .catch(error => {
        console.error('Fehler beim Laden der Detail-Daten:', error);
        ['cashDetailChart', 'midtermDetailChart', 'longtermDetailChart'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.parentElement.innerHTML =
                    '<div class="alert alert-danger">Fehler beim Laden</div>';
            }
        });
    });
</script>
{% endblock %}