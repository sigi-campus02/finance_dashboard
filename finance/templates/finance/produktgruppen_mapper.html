{% extends 'finance/base.html' %}
{% load static %}

{% block title %}Produktgruppen Mapper{% endblock %}

{% block content %}
<div id="root"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect } = React;

const ProduktgruppenMapper = () => {
  const [produktListe, setProduktListe] = useState([]);
  const [filter, setFilter] = useState('alle');
  const [suchbegriff, setSuchbegriff] = useState('');
  const [stats, setStats] = useState({ mitGruppe: 0, ohneGruppe: 0, gesamt: 0 });

  // Produktgruppen-Definitionen
const produktGruppen = {
    // ========== GEM√úSE ==========
    'Paprika': ['paprika', 'spitzpaprika'],
    'Tomaten': ['tomat', 'paradeiser', 'cherry', 'rispenparadeiser', 'markttomaten', 'rispenpara'],
    'Gurken': ['gurke', 'gurk'],
    'Salat': ['salat', 'rucola', 'eisberg', 'lollo', 'vogerlsalat', 'krauth√§uptel'],
    'Zwiebeln': ['zwiebel', 'schalott', 'zwieb'],
    'Kartoffeln': ['kartoffel', 'erd√§pfel', 'erdapfel', 's√º√ükartoffel', 'heurige'],
    'Karotten': ['karott', 'm√∂hre', 'wurzel'],
    'Knoblauch': ['knoblauch'],
    'Kr√§uter': ['petersilie', 'schnittlauch', 'basilikum', 'koriander', 'dill', 'thymian', 'rosmarin', 'salbei', 'kerbel', 'lorbeerbl', '8 kr√§utermix'],
    'Radieschen': ['radieschen'],
    'Zucchini': ['zucchini'],
    'Auberginen': ['aubergine', 'melanzani'],
    'Brokkoli': ['brokkoli', 'brocoli'],
    'Blumenkohl': ['blumenkohl', 'karfiol'],
    'Mais': ['mais', 'zuckermais'],
    'Erbsen': ['erbse', 'kichererbse'],
    'Bohnen': ['bohne', 'bohn', 'sojabohne', 'kidneybohne', 'riesenbohne', 'fisolen', 'edamame'],
    'Spinat': ['spinat', 'jungspinat', 'blattspinat'],
    'Lauch': ['lauch', 'porree'],
    'K√ºrbis': ['k√ºrbis', 'hokkaido', 'butternuss'],
    'Ingwer': ['ingwer'],
    'Chili': ['chili', 'chiliwurzerl', 'peperoni'],
    'Spargel': ['spargel'],
    'R√ºben': ['r√ºbe', 'rote r√ºbe', 'rote bete'],
    'Fenchel': ['fenchel'],
    'Kohl': ['kohl', 'kohlrabi', 'wei√ükohl', 'rotkohl', 'blumenkohl', 'rosenkohl', 'gr√ºnkohl', 'chinakohl', 'pak choi'],
    'Sellerie': ['sellerie', 'stangensellerie'],
    'Gem√ºse Allgemein': ['gem√ºse', 'suppengem√ºse'],
    'Sprossen': ['sprossen', 'sprossengarten', 'kresse'],
    'Linsen': ['linsen', 'berglinsen'],
    'Polenta': ['polenta'],

    // ========== OBST ==========
    '√Ñpfel': ['apfel', '√§pfel'],
    'Bananen': ['banane'],
    'Orangen': ['orange', 'apfelsine'],
    'Zitronen': ['zitrone', 'limette', 'lime'],
    'Beeren': ['erdbeere', 'himbeere', 'heidelbeere', 'brombeere', 'beere', 'blaubeere'],
    'Trauben': ['traube', 'weintraube'],
    'Birnen': ['birne'],
    'Kiwi': ['kiwi'],
    'Mango': ['mango'],
    'Ananas': ['ananas'],
    'Pfirsich': ['pfirsich', 'nektarine'],
    'Melone': ['melone', 'wassermelone', 'honigmelone'],
    'Avocado': ['avocado'],
    'Granatapfel': ['granatapfel'],
    'Zwetschken': ['zwetschke', 'zwetsch', 'pflaume'],
    'Pomelo': ['pomelo'],

    // ========== MILCHPRODUKTE ==========
    'Milch': ['milch', 'h-milch', 'vollmilch', 'frischmilch'],
    'Joghurt': ['joghurt', 'jogurt', 'naturjoghurt', 'fruchtjoghu', 'billa bio fairtrade kokos'],
    'K√§se': ['k√§se', 'baron', 'schlossdamer', 'brie', 'jerome', 'moosbacher', 'sch√§rd.', 'dachsteiner', 'halloumi','baronesse', 'gouda', 'emmentaler','mozzarella', 'burrata', 'cheddar', 'camembert', 'feta', 'ziegen', 'schafk√§se', 'almk√§se', 'bergk√§se', 'edamer', 'tilsiter', 'parm.', 'regg.', 'almk√∂nig', 'goudette'],
    'Butter': ['butter', 'kr√§uterbutter', 'rama', 'l√§tta', 'margarine', 'viospread'],
    'Sahne': ['sahne', 'schlagobers', 'obers', 'creme fraiche', 'cremefine', 'kochcreme'],
    'Topfen': ['topfen', 'quark', 'magertopfen'],
    'Frischk√§se': ['frischk√§se', 'cottage'],
    'Mascarpone': ['mascarpone'],
    'Parmesan': ['parmesan', 'parmigiano', 'grana', 'padano'],
    'Ricotta': ['ricotta'],
    'Babybel': ['babybel'],

    // ========== BACKWAREN ==========
    'Brot': ['brot', 'bauernbrot', 'vollkornbrot', 'wei√übrot', 'schwarzbrot', 'landbrot', 'krustenbrot', 'baguette', 'ciabatta', 'fladenbrot', 'dinkel sandwich', 'sonntagsb'],
    'Semmeln': ['semmel', 'br√∂tchen', 'weckerl', 'wecken', 'dachsteinweckerl'],
    'Toast': ['toast', 'toastbrot', 'mehrkorntoast', 'wasa'],
    'Geb√§ck': ['geb√§ck', 'croissant', 'plunder', 'krapfen', 'nougattasche', 'clever kr√§uter bag'],
    'Kn√§ckebrot': ['kn√§cke', 'leicht cross', 'leicht & cross'],
    'Bl√§tterteig': ['bl√§tterteig'],

    // ========== EIER ==========
    'Eier': ['eier', 'ei '],

    // ========== FLEISCH & WURST ==========
    'Rindfleisch': ['rindfleisch', 'rind ', 'steak', 'filetsteaks', 'tafelspitz', 'gulasch', 'grillmix'],
    'Schweinefleisch': ['schweinefleisch', 'schwein', 'karree'],
    'H√ºhnerfleisch': ['huhn', 'h√§hnchen', 'h√ºhner', 'poulet', 'chicken', 'hendl', 'h-filet', 'gefl√ºgel', 'unterkeulen'],
    'Putenfleisch': ['puten', 'pute'],
    'Wurst': ['wurst', 'w√ºrstel', 'w√ºrstchen', 'salami', 'leberk√§se', 'knacker', 'debreziner', 'frankfurter', 'kabanossi', 'griller', 'kaminwurzerl'],
    'Schinken': ['schinken', 'speck', 'bratl', 'bratenaufschnitt'],
    'Faschiertes': ['faschiert', 'hackfleisch', 'burger', 'beefburger'],
    'W√ºrstchen': ['neuburger', 'braunschweiger','chorizo', 'salsiccia', 'cevapcici'],

    // ========== FISCH ==========
    'Lachs': ['lachs'],
    'Thunfisch': ['thunfisch'],
    'Forelle': ['forelle'],
    'Garnelen': ['garnele', 'shrimp', 'crevette'],
    'Fisch': ['fisch', 'scholle'],
    'Makrelen': ['makrel'],

    // ========== NUDELN & REIS ==========
    'Nudeln': ['nudel', 'pasta', 'spaghetti', 'penne', 'fusilli', 'tagliatelle', 'rigatoni', 'farfalle', 'tortellini', 'ravioli', 'parpadelle', 'fleckerl', 'bucati', 'girandole', 'lasagne'],
    'Gnocchi': ['gnocchi', 'schupfnudeln'],
    'Tortelloni': ['tortelloni'],
    'Reis': ['reis', 'basmati', 'risotto', 'reisfleisch'],
    'Quinoa': ['quinoa'],
    'Couscous': ['couscous'],

    // ========== BACKEN ==========
    'Mehl': ['mehl'],
    'Backpulver': ['backpulver'],
    'Hefe': ['hefe', 'backhefe', 'germ'],
    'Vanille': ['vanille', 'bourbon'],
    'Pudding': ['pudding'],
    'Gelatine': ['blattgelat'],
    'Panier': ['panko', 'panier', 'crumbs'],

    // ========== S√úSSES ==========
    'Zucker': ['zucker', 'puderzucker', 'normalkristallz'],
    'Honig': ['honig'],

    // ========== GEW√úRZE ==========
    'Salz': ['salz'],
    'Pfeffer': ['pfeffer', 'cayennepf'],
    'Gew√ºrze': ['gew√ºrz', 'curry', 'paprikapulver', 'muskat', 'k√ºmmel', 'zimt', 'sternanis', 'anis', 'nelke', 'senf', 'koriander', 'kotanyi'],

    // ========== √ñLE & ESSIG ==========
    'Oliven√∂l': ['oliven√∂l'],
    'Sonnenblumen√∂l': ['sonnenblumen√∂l'],
    'K√ºrbis√∂l': ['k√ºrbis√∂l'],
    'Essig': ['essig', 'balsamico'],
    'Natron': ['natron'],

    // ========== SOSSEN & AUFSTRICHE ==========
    'Ketchup': ['ketchup'],
    'Mayonnaise': ['mayonnaise', 'mayo'],
    'So√üen': ['so√üe', 'sauce', 'hollandaise', 'pizzasauce'],
    'Dips': ['dip', 'tahin', 'sesam'],
    'Fond': ['fond'],
    'Letscho': ['letscho'],
    'Kren': ['kren', 'meerrettich'],

    // ========== FR√úHST√úCK ==========
    'M√ºsli': ['m√ºsli', 'knusperli'],
    'Cornflakes': ['cornflakes', 'color loops'],
    'Haferflocken': ['haferflocken', 'hafer'],
    'Kaffee': ['kaffee', 'nescaf√©', 'nescafe', 'crema intenso', 'hornig'],
    'Porridge': ['porridge'],

    // ========== S√úSSIGKEITEN & SNACKS ==========
    'Schokolade': ['schokolade', 'schoko', 'nutella', 'kinder-pingui', 'manner'],
    'Kekse': ['keks', 'biskuit', 'cookie', 'biskotten', 'leibniz', 'pick up'],
    'Chips': ['chips', 'snips', 'best foodies bio bunte'],
    'N√ºsse': ['nuss', 'mandel', 'haselnuss', 'walnuss', 'cashew', 'pistazie', 'erdnuss', 'studentenfutter', 'studentenfutt', 'pinienkerne', 'sonnenblumenkerne', 'chiasamen'],
    'Trockenfr√ºchte': ['rosine', 'dattel', 'maroni'],
    'S√º√üigkeiten': ['tiramisu', 'duplo', 'suchard', 'celebrations', 'corny', 'tr√ºffeltortenst√ºck'],
    'Proteinriegel': ['proteinriegel', 'barebells', 'neoh'],
    'Mohn': ['mohn'],

    // ========== GETR√ÑNKE ==========
    'Wasser': ['wasser', 'mineralwasser', 'sicheldorfer', 'v√∂slauer'],
    'Saft': ['saft', 'nektar', 'r√ºbensaft', 'fruchtik', 'innocent'],
    'Limonade': ['cola', 'sprite', 'fanta', 'limo'],
    'Bier': ['bier', 'radler', 'puntigamer'],
    'Wein': ['wein', 'rotwein', 'wei√üwein', 'weisswein', 'kremser', 'veltl', 'sandgrube', 'sauvignon', 'les fumees', 'drautaler'],
    'Energy Drinks': ['red bull', 'energy'],
    'Hafermilch': ['hafermilch', 'haferdrink', 'oatly', 'barista', 'natrue coco'],
    'Sojamilch': ['sojamilch', 'sojadrink'],
    'Tee': ['tee', 'halsfreund', 'kamille'],
    'Milchdrinks': ['lattella', 'n√∂m mix'],
    'Vegane Milch': ['vegavita no muuh'],

    // ========== HYGIENE & KOSMETIK ==========
    'Shampoo': ['shampoo'],
    'Duschgel': ['duschgel', 'dusche'],
    'Deo': ['deo'],
    'Lippenpflege': ['lippenpflege'],
    'Zahnpflege': ['zahncreme', 'zahnsp√ºl', 'zahnpasta', 'colgate', 'blend-a-med', 'elmex', 'sensodyne', 'corega'],
    'Wattest√§bchen': ['wattest√§bch', 'wattepads'],
    'Haargummis': ['haargummi', 'zopfhalter'],
    'Seife': ['seife', 'cremeseife'],
    'Desinfektionsmittel': ['desinfektions', 'dettol', 'lysoform'],
    'Haarspray': ['haarspray', 'taft'],
    'Sonnenschutz': ['sonnenspray', 'sonnenschutz', 'apres spray', 'nivea'],
    'Gel Pads': ['gel pads'],
    'Wachsstreifen': ['kaltwachs', 'veet'],
    'Waschgel': ['waschgel', 'g√§nseb'],

    // ========== HAUSHALT ==========
    'Reiniger': ['reiniger', 'frosch', 'dr. beckmann', 'rorax', 'clean&clear', 'bihome', 'lysofrom'],
    'Sp√ºlmittel': ['sp√ºlmittel'],
    'Toilettenpapier': ['toilettenpapier', 'klopapier'],
    'K√ºchenrolle': ['k√ºchenrolle', 'kitchen towel'],
    'Backpapier': ['backpapier'],
    'Alufolie': ['alufolie', 'aluminiumfolie'],
    'Gefrierbeutel': ['gefrierbeutel', 'frischhaltebeutel', 'knotenbeutel'],
    'M√ºllbeutel': ['m√ºllbeutel', 'm√ºllt√ºte', 'swirl active frische', 'swirl aktive frische'],
    'Taschent√ºcher': ['taschentuch', 'papiertaschentuch', 'tempo', 'feh taschent√ºcher'],
    'Frischhaltefolie': ['toppits', 'frischhalte', 'swiffer'],
    'Weichsp√ºler': ['silan'],
    'Brillenreiniger': ['brillenputz', 'brillenputzt√ºcher'],
    'Ohrst√∂psel': ['ohropax'],
    'Waschmittel': ['persil', 'ariel', 'pulver', 'megapearls', 'dr. beck.gardinen'],
    'Entkalker': ['durgol', 'calgon'],
    'Geschirrsp√ºler': ['finish', 'somat', 'klarsp√ºler'],
    'WC-Reiniger': ['wc ente', 'wc power'],
    'Sp√ºlschwamm': ['sp√ºlschwamm', 'vileda'],
    'Reinigungst√ºcher': ['reinigungst√ºcher', 'bi care'],
    'Feuchtt√ºcher': ['feucht', 'topa'],
    'Wundspray': ['wund reinigungsspr'],

    // ========== TIEFK√úHL ==========
    'Tiefk√ºhlkost': ['iglo', 'tk ', 'tiefk√ºhl'],
    'Pizza': ['pizza', 'pizzamehl'],
    'Eis': ['eis ', 'cornetto', 'langnese', 'magnum', 'eskimo', 'cremissimo', 'm√§lzer&fu'],
    'Tortillas': ['tortilla', 'wrap', 'tex mex'],

    // ========== AUFSTRICHE ==========
    'Marmelade': ['marmelade', 'konfit√ºre'],
    'Aufstrich': ['aufstrich'],

    // ========== FERTIGGERICHTE ==========
    'Fertiggerichte': ['frisch gekocht', 'ready to eat'],
    'Suppen': ['suppe', 'rindsuppe'],
    'Cornichons': ['cornichons'],

    // ========== TEXTILIEN & NON-FOOD ==========
    'Textilien': ['thermohose', 'm√ºtze', 'kissen'],
    'Blumen & Pflanzen': ['palmk√§tzchen', 'bl√ºhplfanzen', 'adventkranz', 'markttulpen', 'blumen'],
    'Batterien': ['batterien', 'batter', 'varta'],
    'Geschenke & Deko': ['bon ', 'geschenk', 'neujahrsgu√ü', 'happy birthay'],
    'Lichterketten': ['lichterkette', 'lichter', 'magnet-lichter'],
    'Diverses': ['non food', 'abverkauf', 'aktion', 'mailing', 'limited edition', 'bonus'],

    // ========== SONSTIGES ==========
    'Pfandartikel': ['pfand', 'einwegpfand', 'pfandartikel', 'leergut', 'leergut-ret', 'leerflasche'],
    'Tragetaschen': ['tragetasche'],
    'Sonstiges': ['sonstiges', '√§pp-only', 'unsere besten 6er', '8 x nimm mehr', 'stifterl', 'sch√ºtt-streubeh√§lter', 'tat√º box', 'koro', 'bi good', 'g√§rtnerbund', 'lieblingsprodukt', 'bio gourmet', 'landfr. natur', 'billa bon', 'alpenprinz', 'finis bio', 'sorger', 'traungold', 'wd nat√ºrl', 'machland', 'simply good', 'wolf', 'oetker', 'verival', 'aln', 'sm']
};

  const findeProduktGruppe = (produktName) => {
    if (!produktName) return null;
    const nameLower = produktName.toLowerCase();
    
    for (const [gruppe, keywords] of Object.entries(produktGruppen)) {
      for (const keyword of keywords) {
        if (nameLower.includes(keyword)) {
          return gruppe;
        }
      }
    }
    return null;
  };

  useEffect(() => {
    // Daten vom Django Backend laden
    const produkteVonDjango = {{ produkte_json|safe }};
    
    const mitGruppen = produkteVonDjango.map(produkt => ({
      ...produkt,
      produktgruppe: produkt.produktgruppe || findeProduktGruppe(produkt.name_normalisiert)
    }));

    setProduktListe(mitGruppen);
    
    const mitGruppe = mitGruppen.filter(p => p.produktgruppe !== null).length;
    setStats({
      gesamt: mitGruppen.length,
      mitGruppe,
      ohneGruppe: mitGruppen.length - mitGruppe
    });
  }, []);

  const gefiltert = produktListe.filter(p => {
    const matchFilter = filter === 'alle' || 
      (filter === 'mit' && p.produktgruppe) || 
      (filter === 'ohne' && !p.produktgruppe);
    
    const matchSuche = !suchbegriff || 
      p.name_normalisiert?.toLowerCase().includes(suchbegriff.toLowerCase());
    
    return matchFilter && matchSuche;
  });

  const speichereMapping = async () => {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    try {
      const response = await fetch('{% url "finance:produktgruppen_speichern" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        body: JSON.stringify({ produkte: produktListe })
      });
      
      if (response.ok) {
        alert('‚úì Produktgruppen erfolgreich gespeichert!');
      }
    } catch (error) {
      alert('Fehler beim Speichern: ' + error);
    }
  };

  const downloadCSV = () => {
    const headers = ['id', 'name_original', 'name_normalisiert', 'kategorie', 'produktgruppe'];
    const csv = [
      headers.join(','),
      ...produktListe.map(p => 
        headers.map(h => `"${p[h] || ''}"`).join(',')
      )
    ].join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'billa_produkte_mit_gruppen.csv';
    a.click();
  };

  // UI Code hier... (gek√ºrzt wegen L√§nge - siehe vollst√§ndigen Code unten)

  return (
    <div className="container-fluid p-4">
      <h1 className="mb-4">üè∑Ô∏è Produktgruppen-Mapper</h1>
      
      {/* Statistiken */}
      <div className="row mb-4">
        <div className="col-md-4">
          <div className="card border-primary">
            <div className="card-body">
              <h3>{stats.gesamt}</h3>
              <p className="mb-0">Gesamt Produkte</p>
            </div>
          </div>
        </div>
        <div className="col-md-4">
          <div className="card border-success">
            <div className="card-body">
              <h3 className="text-success">{stats.mitGruppe}</h3>
              <p className="mb-0">Mit Produktgruppe ({Math.round(stats.mitGruppe/stats.gesamt*100)}%)</p>
            </div>
          </div>
        </div>
        <div className="col-md-4">
          <div className="card border-warning">
            <div className="card-body">
              <h3 className="text-warning">{stats.ohneGruppe}</h3>
              <p className="mb-0">Ohne Produktgruppe</p>
            </div>
          </div>
        </div>
      </div>

      {/* Aktionen */}
      <div className="mb-3">
        <button onClick={speichereMapping} className="btn btn-primary me-2">
          üíæ In Datenbank speichern
        </button>
        <button onClick={downloadCSV} className="btn btn-secondary">
          üì• Als CSV downloaden
        </button>
      </div>

      {/* Tabelle */}
      <div className="table-responsive">
        <table className="table table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Produktname</th>
              <th>Kategorie</th>
              <th>Produktgruppe</th>
            </tr>
          </thead>
          <tbody>
            {gefiltert.slice(0, 100).map((p, idx) => (
              <tr key={idx}>
                <td>{p.id}</td>
                <td>{p.name_normalisiert}</td>
                <td>{p.kategorie}</td>
                <td>
                  {p.produktgruppe ? (
                    <span className="badge bg-success">{p.produktgruppe}</span>
                  ) : (
                    <span className="badge bg-secondary">Keine Zuordnung</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

ReactDOM.render(<ProduktgruppenMapper />, document.getElementById('root'));
</script>

{% csrf_token %}
{% endblock %}